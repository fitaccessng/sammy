{% extends "finance/base.html" %}
{% block title %}Finance Manager Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
   

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-chart-line text-green-600 mr-3"></i>Finance Manager Dashboard
        </h1>
        <p class="text-gray-600">Monitor financial performance, budgets, and cash flow</p>
    </div>

    <!-- Quick Navigation -->
    <div class="mb-8 bg-white rounded-lg shadow-sm p-4">
        <div class="flex flex-wrap gap-3">
            <a href="{{ url_for('finance_mgr.budgets') }}" class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition">
                <i class="fas fa-wallet mr-2"></i>Budgets
            </a>
            <a href="{{ url_for('finance_mgr.invoices') }}" class="inline-flex items-center px-4 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition">
                <i class="fas fa-file-invoice-dollar mr-2"></i>Invoices
            </a>
            <a href="{{ url_for('finance_mgr.payments') }}" class="inline-flex items-center px-4 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition">
                <i class="fas fa-money-check-alt mr-2"></i>Payments
            </a>
            <a href="{{ url_for('finance_mgr.receivables') }}" class="inline-flex items-center px-4 py-2 bg-yellow-50 text-yellow-700 rounded-lg hover:bg-yellow-100 transition">
                <i class="fas fa-receipt mr-2"></i>Receivables
            </a>
            <a href="{{ url_for('finance_mgr.payables') }}" class="inline-flex items-center px-4 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition">
                <i class="fas fa-file-invoice mr-2"></i>Payables
            </a>
            <a href="{{ url_for('finance_mgr.cashflow') }}" class="inline-flex items-center px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition">
                <i class="fas fa-chart-area mr-2"></i>Cash Flow
            </a>
            <a href="{{ url_for('finance_mgr.reports') }}" class="inline-flex items-center px-4 py-2 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                <i class="fas fa-chart-bar mr-2"></i>Reports
            </a>
            <a href="{{ url_for('finance_mgr.transactions') }}" class="inline-flex items-center px-4 py-2 bg-teal-50 text-teal-700 rounded-lg hover:bg-teal-100 transition">
                <i class="fas fa-exchange-alt mr-2"></i>Transactions
            </a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Revenue -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-green-100 text-sm">Total Revenue</p>
                    <h3 class="text-3xl font-bold">₦{{ "{:,.2f}".format(kpis.total_revenue) }}</h3>
                </div>
                <div class="bg-white bg-opacity-30 rounded-full p-3">
                    <i class="fas fa-money-bill-wave text-2xl"></i>
                </div>
            </div>
            <div class="flex items-center text-sm">
                <span class="bg-green-800 bg-opacity-50 px-2 py-1 rounded">
                    Collection Rate: {{ "{:.1f}".format(kpis.collection_rate) }}%
                </span>
            </div>
        </div>

        <!-- Outstanding Receivables -->
        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-yellow-100 text-sm">Outstanding Receivables</p>
                    <h3 class="text-3xl font-bold">₦{{ "{:,.2f}".format(kpis.outstanding_receivables) }}</h3>
                </div>
                <div class="bg-white bg-opacity-30 rounded-full p-3">
                    <i class="fas fa-receipt text-2xl"></i>
                </div>
            </div>
            <div class="flex items-center text-sm">
                {% if kpis.overdue_invoices > 0 %}
                <span class="bg-red-600 px-2 py-1 rounded">
                    {{ kpis.overdue_invoices }} Overdue
                </span>
                {% else %}
                <span class="bg-green-600 px-2 py-1 rounded">
                    <i class="fas fa-check mr-1"></i>All Current
                </span>
                {% endif %}
            </div>
        </div>

        <!-- Total Payables -->
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-red-100 text-sm">Total Payables</p>
                    <h3 class="text-3xl font-bold">₦{{ "{:,.2f}".format(kpis.total_payables) }}</h3>
                </div>
                <div class="bg-white bg-opacity-30 rounded-full p-3">
                    <i class="fas fa-file-invoice text-2xl"></i>
                </div>
            </div>
            <div class="flex items-center text-sm">
                {% if kpis.overdue_payables > 0 %}
                <span class="bg-red-800 bg-opacity-50 px-2 py-1 rounded">
                    ₦{{ "{:,.0f}".format(kpis.overdue_payables) }} Overdue
                </span>
                {% else %}
                <span class="bg-green-600 px-2 py-1 rounded">
                    <i class="fas fa-check mr-1"></i>On Track
                </span>
                {% endif %}
            </div>
        </div>

        <!-- Cash Balance -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <p class="text-blue-100 text-sm">Current Cash Balance</p>
                    <h3 class="text-3xl font-bold">₦{{ "{:,.2f}".format(kpis.current_cash_balance) }}</h3>
                </div>
                <div class="bg-white bg-opacity-30 rounded-full p-3">
                    <i class="fas fa-university text-2xl"></i>
                </div>
            </div>
            <div class="flex items-center text-sm">
                <span class="bg-blue-800 bg-opacity-50 px-2 py-1 rounded">
                    {{ kpis.active_budgets }} Active Budgets
                </span>
            </div>
        </div>
    </div>

    <!-- Secondary KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm mb-1">Budget Utilization</p>
                    <h4 class="text-2xl font-bold text-gray-900">{{ "{:.1f}".format(kpis.budget_utilization) }}%</h4>
                </div>
                <i class="fas fa-wallet text-3xl text-blue-500"></i>
            </div>
            <div class="mt-4 bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 rounded-full h-2" style="width: {{ kpis.budget_utilization }}%"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm mb-1">Pending Approvals</p>
                    <h4 class="text-2xl font-bold text-gray-900">{{ kpis.pending_invoice_approvals + kpis.pending_payment_approvals }}</h4>
                </div>
                <i class="fas fa-clock text-3xl text-yellow-500"></i>
            </div>
            <p class="text-sm text-gray-600 mt-2">
                {{ kpis.pending_invoice_approvals }} Invoices, {{ kpis.pending_payment_approvals }} Payments
            </p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm mb-1">Collected Revenue</p>
                    <h4 class="text-2xl font-bold text-gray-900">₦{{ "{:,.0f}".format(kpis.collected_revenue) }}</h4>
                </div>
                <i class="fas fa-hand-holding-usd text-3xl text-green-500"></i>
            </div>
            <p class="text-sm text-gray-600 mt-2">
                {{ "{:.1f}".format(kpis.collection_rate) }}% of total revenue
            </p>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Monthly Revenue Trend -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>Monthly Revenue Trend
            </h3>
            <canvas id="revenueChart" height="250"></canvas>
        </div>

        <!-- Top Customers -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-users text-green-600 mr-2"></i>Top Customers by Revenue
            </h3>
            <canvas id="customersChart" height="250"></canvas>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Invoices -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-file-invoice-dollar text-green-600 mr-2"></i>Recent Invoices
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Invoice #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for invoice in recent_invoices %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ invoice.invoice_number }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {{ invoice.customer_name }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ₦{{ "{:,.2f}".format(invoice.total_amount) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if invoice.status == 'paid' %}bg-green-100 text-green-800
                                    {% elif invoice.status == 'sent' %}bg-blue-100 text-blue-800
                                    {% elif invoice.status == 'draft' %}bg-gray-100 text-gray-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ invoice.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Payments -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-money-check-alt text-purple-600 mr-2"></i>Recent Payments
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Party</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for payment in recent_payments %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ payment.payment_number }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {{ payment.party_name }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ₦{{ "{:,.2f}".format(payment.amount) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {{ payment.payment_method }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Monthly Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_revenue|map(attribute='month')|list|tojson }},
            datasets: [{
                label: 'Revenue',
                data: {{ monthly_revenue|map(attribute='revenue')|list|tojson }},
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₦' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Top Customers Chart
    const customersCtx = document.getElementById('customersChart').getContext('2d');
    new Chart(customersCtx, {
        type: 'bar',
        data: {
            labels: {{ top_customers|map(attribute='customer_name')|list|tojson }},
            datasets: [{
                label: 'Total Revenue',
                data: {{ top_customers|map(attribute='total')|list|tojson }},
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₦' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
