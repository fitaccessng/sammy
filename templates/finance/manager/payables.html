{% extends "finance/base.html" %}
{% block title %}Accounts Payable{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'error' }} p-4 rounded-lg mb-4
                    {{ 'bg-green-50 border border-green-200 text-green-800' if category == 'success' else 'bg-red-50 border border-red-200 text-red-800' }}">
                    <div class="flex items-center">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} mr-2"></i>
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900"><i class="fas fa-file-invoice text-red-600 mr-3"></i>Accounts Payable</h1>
            <p class="text-gray-600">Track vendor bills and payment obligations</p>
        </div>
        <button onclick="openCreateModal()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700"><i class="fas fa-plus mr-2"></i>Add Payable</button>
    </div>

    <!-- Status Filters -->
    <div class="mb-6 bg-white rounded-lg shadow p-2 flex gap-2">
        <a href="?status=unpaid" class="px-4 py-2 rounded-lg {% if request.args.get('status', 'unpaid') == 'unpaid' %}bg-gray-700 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
            <i class="fas fa-clock mr-2"></i>Unpaid
        </a>
        <a href="?status=partially_paid" class="px-4 py-2 rounded-lg {% if request.args.get('status') == 'partially_paid' %}bg-yellow-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
            <i class="fas fa-coins mr-2"></i>Partially Paid
        </a>
        <a href="?status=overdue" class="px-4 py-2 rounded-lg {% if request.args.get('status') == 'overdue' %}bg-red-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
            <i class="fas fa-exclamation-triangle mr-2"></i>Overdue
        </a>
        <a href="?status=paid" class="px-4 py-2 rounded-lg {% if request.args.get('status') == 'paid' %}bg-green-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
            <i class="fas fa-check-circle mr-2"></i>Paid
        </a>
        <a href="?status=all" class="px-4 py-2 rounded-lg {% if request.args.get('status') == 'all' %}bg-purple-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
            <i class="fas fa-list mr-2"></i>All
        </a>
    </div>

    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bill #</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for ap in payables %}
                <tr class="hover:bg-gray-50 {% if ap.status == 'overdue' %}bg-red-50{% endif %}">
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium">{{ ap.vendor_name }}</div>
                        {% if ap.vendor_email %}
                        <div class="text-xs text-gray-500">{{ ap.vendor_email }}</div>
                        {% endif %}
                        {% if ap.project %}
                        <div class="text-xs text-blue-600 mt-1"><i class="fas fa-project-diagram mr-1"></i>{{ ap.project.project_name }}</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium">{{ ap.bill_number }}</div>
                        <div class="text-xs text-gray-500">{{ ap.bill_date.strftime('%b %d, %Y') }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">{{ ap.category or '-' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm {% if ap.status == 'overdue' %}text-red-600 font-bold{% endif %}">{{ ap.due_date.strftime('%b %d, %Y') }}</div>
                        {% if ap.days_overdue > 0 %}
                        <div class="text-xs text-red-600 font-semibold">{{ ap.days_overdue }} days overdue</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold">₦{{ "{:,.2f}".format(ap.amount_due) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold text-red-700">₦{{ "{:,.2f}".format(ap.balance) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs rounded-full {% if ap.status == 'paid' %}bg-green-100 text-green-800{% elif ap.status == 'overdue' %}bg-red-100 text-red-800{% elif ap.status == 'partially_paid' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">{{ ap.status }}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                        {% if ap.status != 'paid' %}
                        <button onclick="recordPayment({{ ap.id }}, '{{ ap.vendor_name }}', {{ ap.balance }})" class="text-green-600 hover:text-green-800">
                            <i class="fas fa-money-bill-wave"></i> Pay
                        </button>
                        {% endif %}
                        <form action="{{ url_for('finance_mgr.delete_payable', payable_id=ap.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this payable?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                            <button type="submit" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center">
                        <i class="fas fa-file-invoice text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No Payables Found</h3>
                        <p class="text-gray-500 mb-6">Add vendor bills to track payment obligations</p>
                        <button onclick="openCreateModal()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700">
                            <i class="fas fa-plus mr-2"></i>Add Payable
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
        <div class="px-6 py-4 border-b flex justify-between items-center">
            <h3 class="text-xl font-bold">Add Payable</h3>
            <button onclick="closeCreateModal()"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form method="post" class="p-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Vendor Name *</label><input type="text" name="vendor_name" required class="w-full border rounded-lg px-4 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Vendor Email</label><input type="email" name="vendor_email" class="w-full border rounded-lg px-4 py-2"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Bill Number *</label><input type="text" name="bill_number" required class="w-full border rounded-lg px-4 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Amount Due *</label><input type="number" name="amount_due" step="0.01" required class="w-full border rounded-lg px-4 py-2"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Bill Date *</label><input type="date" name="bill_date" required class="w-full border rounded-lg px-4 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Due Date *</label><input type="date" name="due_date" required class="w-full border rounded-lg px-4 py-2"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Payment Terms</label><input type="text" name="payment_terms" class="w-full border rounded-lg px-4 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Category</label><input type="text" name="category" class="w-full border rounded-lg px-4 py-2"></div>
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Project</label><select name="project_id" class="w-full border rounded-lg px-4 py-2"><option value="">None</option>{% for project in projects %}<option value="{{ project.id }}">{{ project.project_name }}</option>{% endfor %}</select></div>
            <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Description</label><textarea name="description" rows="2" class="w-full border rounded-lg px-4 py-2"></textarea></div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeCreateModal()" class="px-6 py-2 border rounded-lg">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"><i class="fas fa-save mr-2"></i>Add Payable</button>
            </div>
        </form>
    </div>
</div>

<!-- Record Payment Modal -->
<div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b flex justify-between items-center">
            <h3 class="text-xl font-bold">Record Payment</h3>
            <button onclick="closePaymentModal()"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="paymentForm" method="post" action="" class="p-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Vendor</label>
                <input type="text" id="payment_vendor" readonly class="w-full border rounded-lg px-4 py-2 bg-gray-50">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Amount to Pay *</label>
                <input type="number" name="payment_amount" id="payment_amount" step="0.01" required class="w-full border rounded-lg px-4 py-2">
                <p class="text-xs text-gray-500 mt-1">Balance Due: ₦<span id="balance_due">0.00</span></p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date *</label>
                <input type="date" name="payment_date" required class="w-full border rounded-lg px-4 py-2">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closePaymentModal()" class="px-6 py-2 border rounded-lg">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"><i class="fas fa-check mr-2"></i>Record Payment</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openCreateModal() { document.getElementById('createModal').classList.remove('hidden'); }
    function closeCreateModal() { document.getElementById('createModal').classList.add('hidden'); }
    
    function recordPayment(id, vendor, balance) {
        document.getElementById('paymentModal').classList.remove('hidden');
        document.getElementById('payment_vendor').value = vendor;
        document.getElementById('balance_due').textContent = balance.toLocaleString('en-US', {minimumFractionDigits: 2});
        document.getElementById('payment_amount').max = balance;
        document.getElementById('paymentForm').action = '/finance/manager/payables/' + id + '/payment';
    }
    
    function closePaymentModal() {
        document.getElementById('paymentModal').classList.add('hidden');
    }
</script>
{% endblock %}
