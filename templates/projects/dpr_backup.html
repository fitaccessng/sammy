{% extends "projects/base.html" %}

{% block title %}Daily Production Reports | SammyA Projects{% endblock %}
{% block header %}Daily Production Reports (DPR){% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Project Selection Required -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <i class="bx bx-info-circle text-blue-500 text-xl"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-blue-800">Project Context Required</h3>
                <p class="text-sm text-blue-600">Select a project below to manage Daily Production Reports for that specific project.</p>
            </div>
        </div>
    </div>
    
    <!-- Project Selection -->
    {% if accessible_projects %}
    <div class="flex items-center space-x-3">
        <label for="projectSelector" class="text-sm font-medium text-gray-700">Select Project:</label>
        <select id="projectSelector" class="px-4 py-2 border rounded-lg flex-1 max-w-md">
            <option value="">-- Select a Project to Continue --</option>
            {% for proj in accessible_projects %}
            <option value="{{ proj.id }}">{{ proj.name }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}
    
    <!-- Actions Row -->
    <div class="flex justify-between">
        <div class="flex space-x-3">
            {% if user_role == 'super_hq' or user_role == 'hq_project' or user_role == 'project_manager' %}
            <button id="createDPRBtn" disabled
                    class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed">
                Create New DPR (Select Project)
            </button>
            {% else %}
            <button class="px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" disabled>
                Create DPR (Restricted)
            </button>
            {% endif %}
        </div>
        <div class="flex space-x-3">
            <select id="statusFilter" class="px-4 py-2 border p-2 rounded-lg">
                <option value="">All Status</option>
                <option value="draft">Draft</option>
                <option value="sent_to_staff">Sent to Staff</option>
                <option value="completed">Completed</option>
                <option value="reviewed">Reviewed</option>
            </select>
        </div>
    </div>

    <!-- DPR List -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">Daily Production Reports</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Project</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="dprTableBody">
                    <!-- DPR rows will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create DPR Modal -->
<div id="createDPRModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Create Daily Production Report</h3>
                <button class="closeDPRModal text-gray-400 hover:text-gray-600">
                    <i class="bx bx-x text-2xl"></i>
                </button>
            </div>
            
            <form id="createDPRForm" method="POST" action="{{ url_for('project.create_dpr') }}" class="space-y-6">
                <!-- Hidden field for project ID -->
                {% if selected_project %}
                <input type="hidden" name="project_id" value="{{ selected_project.id }}">
                {% endif %}
                
                <!-- Header Information -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Report Date <span class="text-red-500">*</span></label>
                        <input type="date" name="report_date" required class="mt-1 border p-2 block w-full rounded-md border-gray-300">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Assign to Staff Member</label>
                        <select name="assigned_to_id" id="staffAssignSelect" class="mt-1 border p-2 block w-full rounded-md border-gray-300">
                            <option value="">-- Select Staff --</option>
                            {% if project_staff %}
                                {% for staff in project_staff %}
                                <option value="{{ staff.id }}" data-email="{{ staff.email }}" data-type="{{ staff.type }}">
                                    {{ staff.name }} ({{ staff.role }}) - {{ staff.email }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        {% if project_staff %}
                            <p class="mt-1 text-xs text-gray-500">
                                <i class="bx bx-info-circle"></i> 
                                Selected staff will receive email notification and dashboard alert.
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Project Info Display -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-900">Project: <span id="selectedProjectName">Not Selected</span></h4>
                    <p class="text-sm text-gray-600">Daily Production Report for selected project</p>
                </div>

                <!-- Project Staff Display -->
                {% if project_staff %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-900 mb-3">
                        <i class="bx bx-group text-blue-600"></i> 
                        Assigned Project Personnel ({{ project_staff|length }})
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {% for staff in project_staff %}
                        <div class="bg-white p-3 rounded border">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h5 class="font-medium text-gray-900">{{ staff.name }}</h5>
                                    <p class="text-sm text-gray-600">{{ staff.role }}</p>
                                    <p class="text-xs text-gray-500">{{ staff.email }}</p>
                                </div>
                                <div class="text-right">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                        {% if staff.type == 'user' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                        {{ staff.type|title }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="mt-2 text-xs text-blue-600">
                        <i class="bx bx-info-circle"></i> 
                        DPRs can be assigned to any of these personnel. They will receive notifications via email and dashboard.
                    </p>
                </div>
                {% else %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <i class="bx bx-warning text-yellow-500 text-xl"></i>
                        <div>
                            <h4 class="font-medium text-yellow-800">No Staff Assigned</h4>
                            <p class="text-sm text-yellow-600">No staff members or employees are currently assigned to this project. Please assign personnel from the project management page before creating DPRs.</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Production Items Section -->
                <div class="border rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">PRODUCTION</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Bill Item</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Target Qty</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Daily Qty</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <!-- EARTHWORKS -->
                                <tr class="bg-gray-100 font-semibold">
                                    <td class="px-4 py-2">1.00</td>
                                    <td class="px-4 py-2 font-bold">EARTHWORKS</td>
                                    <td class="px-4 py-2"></td>
                                    <td class="px-4 py-2"></td>
                                    <td class="px-4 py-2"></td>
                                    <td class="px-4 py-2"></td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">1.01</td>
                                    <td class="px-4 py-2">Soft Cut Works</td>
                                    <td class="px-4 py-2">
                                        <input type="text" name="location_1_01" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">M3</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="target_qty_1_01" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="daily_qty_1_01" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">1.02</td>
                                    <td class="px-4 py-2">Fill works</td>
                                    <td class="px-4 py-2">
                                        <input type="text" name="location_1_02" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">M3</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="target_qty_1_02" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="daily_qty_1_02" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">1.03</td>
                                    <td class="px-4 py-2">Scarification</td>
                                    <td class="px-4 py-2">
                                        <input type="text" name="location_1_03" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">M2</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="target_qty_1_03" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="daily_qty_1_03" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">1.04</td>
                                    <td class="px-4 py-2">Hard Core Filling</td>
                                    <td class="px-4 py-2">
                                        <input type="text" name="location_1_04" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2"></td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="target_qty_1_04" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="daily_qty_1_04" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                
                                <!-- CONCRETE WORKS -->
                                <tr class="bg-gray-100 font-semibold">
                                    <td class="px-4 py-2">2.00</td>
                                    <td class="px-4 py-2 font-bold">CONCRETE WORKS</td>
                                    <td class="px-4 py-2"></td>
                                    <td class="px-4 py-2"></td>
                                    <td class="px-4 py-2"></td>
                                    <td class="px-4 py-2"></td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">2.01</td>
                                    <td class="px-4 py-2">Blinding</td>
                                    <td class="px-4 py-2">
                                        <input type="text" name="location_2_01" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">M3</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="target_qty_2_01" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="daily_qty_2_01" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">2.02</td>
                                    <td class="px-4 py-2">Base/Top Slab concrete</td>
                                    <td class="px-4 py-2">
                                        <input type="text" name="location_2_02" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">M3</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="target_qty_2_02" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="daily_qty_2_02" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">2.03</td>
                                    <td class="px-4 py-2">Wall concrete</td>
                                    <td class="px-4 py-2">
                                        <input type="text" name="location_2_03" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">M3</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="target_qty_2_03" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="daily_qty_2_03" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">2.04</td>
                                    <td class="px-4 py-2">Reinforcement in total length</td>
                                    <td class="px-4 py-2">
                                        <input type="text" name="location_2_04" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">M</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="target_qty_2_04" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="daily_qty_2_04" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Material Usage Section -->
                <div class="border rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">MATERIAL USAGE</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Material Description</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Quantity Used</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-4 py-2">1</td>
                                    <td class="px-4 py-2">Cement</td>
                                    <td class="px-4 py-2">bag</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="material_qty_1" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">2</td>
                                    <td class="px-4 py-2">Earthfill works</td>
                                    <td class="px-4 py-2">trucks</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="material_qty_2" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">3</td>
                                    <td class="px-4 py-2">Cut work</td>
                                    <td class="px-4 py-2">trucks</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="material_qty_3" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">4</td>
                                    <td class="px-4 py-2">Diesel</td>
                                    <td class="px-4 py-2">ltr</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="material_qty_4" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">5</td>
                                    <td class="px-4 py-2">Concrete Mixer small truck</td>
                                    <td class="px-4 py-2">trucks</td>
                                    <td class="px-4 py-2">
                                        <input type="number" step="0.01" name="material_qty_5" class="w-full border rounded px-2 py-1 text-sm">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" class="closeDPRModal px-4 py-2 bg-gray-200 text-gray-800 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" name="action" value="save_draft" class="px-4 py-2 bg-blue-600 text-white rounded-md">
                        Save as Draft
                    </button>
                    <button type="submit" name="action" value="send_to_staff" class="px-4 py-2 bg-indigo-600 text-white rounded-md">
                        Send to Staff
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// DPR template data - predefined structure
const DPR_PRODUCTION_ITEMS = [
    // EARTHWORKS
    { code: "1.00", description: "EARTHWORKS", location: "", unit: "", isHeader: true },
    { code: "1.01", description: "Soft Cut Works", location: "", unit: "M3" },
    { code: "1.02", description: "Fill works", location: "", unit: "M3" },
    { code: "1.03", description: "Scarification", location: "", unit: "M2" },
    { code: "1.04", description: "Hard Core Filling", location: "", unit: "" },
    
    // CONCRETE WORKS
    { code: "2.00", description: "CONCRETE WORKS", location: "", unit: "", isHeader: true },
    { code: "2.01", description: "Blinding", location: "", unit: "M3" },
    { code: "2.02", description: "Base/Top Slab concrete", location: "", unit: "M3" },
    { code: "2.03", description: "Wall concrete", location: "", unit: "M3" },
    { code: "2.04", description: "Reinforcement in total length", location: "", unit: "M" },
    
    // PAVEMENT & PROTECTION
    { code: "3.00", description: "PAVEMENT & PROTECTION", location: "", unit: "", isHeader: true },
    { code: "3.01", description: "Base fill works", location: "", unit: "M3" },
    { code: "3.02", description: "Priming works", location: "", unit: "M2" },
    { code: "3.03", description: "Tack Coat", location: "", unit: "M2" },
    { code: "3.04", description: "Wearing Course works", location: "", unit: "M2" },
    { code: "3.05", description: "Surface Dressing works", location: "", unit: "M2" },
    { code: "3.06", description: "Stone pitching protection works", location: "", unit: "M2" },
    { code: "3.07", description: "Kerb lining works", location: "", unit: "M" },
    
    // RAW MATERIAL SUPPLY
    { code: "4.00", description: "RAW MATERIAL SUPPLY", location: "", unit: "", isHeader: true },
    { code: "4.01", description: "Aggregate supply works", location: "", unit: "TONS" },
    { code: "4.02", description: "Sand supply works", location: "", unit: "TONS" },
    { code: "4.03", description: "Cement supply works", location: "", unit: "Bags" },
    { code: "4.04", description: "Reinforcement", location: "", unit: "TONS" },
    { code: "4.05", description: "Labour", location: "", unit: "Naira" },
    { code: "4.06", description: "Other expenses", location: "", unit: "Naira" },
    { code: "4.07", description: "Bitumen", location: "", unit: "TONS" },
    { code: "4.08", description: "Kerosene", location: "", unit: "Litres" },
    { code: "4.09", description: "Diesel", location: "", unit: "Litres" }
];

const DPR_MATERIAL_USAGE = [
    { number: 1, description: "Cement", unit: "bag" },
    { number: 2, description: "Earthfill works", unit: "trucks" },
    { number: 3, description: "Cut work", unit: "trucks" },
    { number: 4, description: "Diesel", unit: "ltr" },
    { number: 5, description: "Concrete Mixer small truck", unit: "trucks" },
    { number: 6, description: "Concrete Mixer Big truck", unit: "trucks" },
    { number: 7, description: "Concrete Mix", unit: "m3" },
    { number: 8, description: "MC1 bitumen mix", unit: "tons" },
    { number: 9, description: "S-125 bitumen mix", unit: "tons" },
    { number: 10, description: "Tack coat bitumen mix", unit: "tons" },
    { number: 11, description: "Wearing course asphalt", unit: "tons" }
];

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('createDPRModal');
    const openModal = document.getElementById('createDPRBtn');
    const closeModal = document.querySelectorAll('.closeDPRModal');
    const form = document.getElementById('createDPRForm');
    const projectSelector = document.getElementById('projectSelector');

    // Project selection handler
    if (projectSelector) {
        // Set initial selection if we have a selected project
        {% if selected_project %}
        projectSelector.value = "{{ selected_project.id }}";
        {% endif %}
        
        projectSelector.addEventListener('change', () => {
            const selectedProject = projectSelector.value;
            
            if (selectedProject) {
                // Reload page with selected project to load staff server-side
                window.location.href = `{{ url_for('project.dpr_list') }}?selected_project_id=${selectedProject}`;
            } else {
                // Clear selection - reload without project parameter
                window.location.href = `{{ url_for('project.dpr_list') }}`;
            }
        });
    }

    // Enable/disable create button based on project selection
    {% if selected_project %}
    if (openModal) {
        openModal.disabled = false;
        openModal.className = "px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700";
        openModal.textContent = "Create DPR for {{ selected_project.name }}";
    }
    {% else %}
    if (openModal) {
        openModal.disabled = true;
        openModal.className = "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed";
        openModal.textContent = "Create New DPR (Select Project)";
    }
    {% endif %}

    // Modal controls
    if (openModal) {
        openModal.addEventListener('click', () => {
            if (!openModal.disabled) {
                initializeDPRForm();
                modal.classList.remove('hidden');
            }
        });
    }
    
    closeModal.forEach(btn => {
        btn.addEventListener('click', () => modal.classList.add('hidden'));
    });

    // Initialize DPR form with template data
    function initializeDPRForm() {
        {% if selected_project %}
        document.getElementById('selectedProjectName').textContent = "{{ selected_project.name }}";
        {% else %}
        document.getElementById('selectedProjectName').textContent = "Not Selected";
        {% endif %}
        
        // Populate production items
        populateProductionItems();
        
        // Populate material usage
        populateMaterialUsage();
    }

    function populateProductionItems() {
        const tbody = document.getElementById('productionItemsTable');
        tbody.innerHTML = '';
        
        DPR_PRODUCTION_ITEMS.forEach(item => {
            const row = document.createElement('tr');
            if (item.isHeader) {
                row.className = 'bg-gray-100 font-semibold';
                row.innerHTML = `
                    <td class="px-4 py-2">${item.code}</td>
                    <td class="px-4 py-2 font-bold">${item.description}</td>
                    <td class="px-4 py-2"></td>
                    <td class="px-4 py-2"></td>
                    <td class="px-4 py-2"></td>
                    <td class="px-4 py-2"></td>
                `;
            } else {
                row.innerHTML = `
                    <td class="px-4 py-2">${item.code}</td>
                    <td class="px-4 py-2">${item.description}</td>
                    <td class="px-4 py-2">
                        <input type="text" name="location_${item.code}" class="w-full border rounded px-2 py-1 text-sm">
                    </td>
                    <td class="px-4 py-2">${item.unit}</td>
                    <td class="px-4 py-2">
                        <input type="number" step="0.01" name="target_qty_${item.code}" class="w-full border rounded px-2 py-1 text-sm">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" step="0.01" name="daily_qty_${item.code}" class="w-full border rounded px-2 py-1 text-sm" placeholder="Daily quantity">
                    </td>
                `;
            }
            tbody.appendChild(row);
        });
    }

    function populateMaterialUsage() {
        const tbody = document.getElementById('materialUsageTable');
        tbody.innerHTML = '';
        
        DPR_MATERIAL_USAGE.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-4 py-2">${item.number}</td>
                <td class="px-4 py-2">${item.description}</td>
                <td class="px-4 py-2">${item.unit}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function loadProjectStaff(projectId) {
        // This would load staff members assigned to the project
        // For now, we'll use a placeholder
        const assignSelect = document.querySelector('select[name="assigned_to_id"]');
        assignSelect.innerHTML = '<option value="">-- Select Staff --</option>';
    }

    function loadProjectDPRs(projectId) {
        // This would load existing DPRs for the project
        // For now, we'll show a placeholder
        const tbody = document.getElementById('dprTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Select a project to view DPRs</td></tr>';
    }

    // Form submission
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const action = e.submitter.value;
            
            // Add selected project
            formData.set('project_id', projectSelector.value);
            formData.set('action', action);
            
            // Collect production items data
            const productionData = [];
            DPR_PRODUCTION_ITEMS.forEach(item => {
                if (!item.isHeader && item.unit) {
                    productionData.push({
                        code: item.code,
                        description: item.description,
                        location: formData.get(`location_${item.code}`) || '',
                        unit: item.unit,
                        target_qty: parseFloat(formData.get(`target_qty_${item.code}`)) || 0,
                        daily_qty: parseFloat(formData.get(`daily_qty_${item.code}`)) || 0
                    });
                }
            });
            
            try {
                const response = await fetch('/project/dpr/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({
                        project_id: projectSelector.value,
                        report_date: formData.get('report_date'),
                        assigned_to_id: formData.get('assigned_to_id') || null,
                        action: action,
                        production_items: productionData,
                        material_usage: DPR_MATERIAL_USAGE
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    alert(data.message);
                    modal.classList.add('hidden');
                    loadProjectDPRs(projectSelector.value);
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create DPR');
            }
        });
    }
});
</script>
{% endblock %}