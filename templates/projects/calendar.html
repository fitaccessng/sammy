{% extends "projects/base.html" %}

{% block title %}Project Calendar | SammyA Projects{% endblock %}
{% block header %}Project Calendar{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Project Selection -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Select Project</h3>
        {% if accessible_projects %}
            <select id="projectSelector" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <option value="">Select a project to view calendar events...</option>
                {% for project in accessible_projects %}
                    <option value="{{ project.id }}" {% if selected_project and selected_project.id == project.id %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                {% endfor %}
            </select>
        {% else %}
            <div class="text-center py-8">
                <div class="text-gray-500">
                    <i class="fas fa-info-circle text-4xl mb-4"></i>
                    <p class="text-lg font-medium">No Projects Assigned</p>
                    <p>You need to be assigned to a project to view calendar events.</p>
                </div>
            </div>
        {% endif %}
    </div>

    {% if accessible_projects %}
    <!-- Calendar Controls -->
    <div id="calendarControls" class="bg-white rounded-lg shadow p-4 {% if not selected_project %}hidden{% endif %}">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">
                {% if selected_project %}
                    Calendar for: {{ selected_project.name }}
                {% else %}
                    Project Calendar Events
                {% endif %}
            </h3>
            <div class="flex space-x-3">
                <select id="filterEvents" class="px-4 py-2 border rounded-lg">
                    <option value="">All Events</option>
                    <option value="project-start">Project Start/End</option>
                    <option value="milestone">Milestones</option>
                    <option value="task">Tasks</option>
                    <option value="schedule">Schedules</option>
                    <option value="dpr">DPR Submissions</option>
                    <option value="expense">Expenses</option>
                </select>
            </div>
        </div>

        <!-- Legend -->
        <div class="flex flex-wrap gap-4 text-sm">
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-green-500 rounded"></div>
                <span>Project Start</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-red-500 rounded"></div>
                <span>Project End</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-purple-500 rounded"></div>
                <span>Milestones</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-gray-500 rounded"></div>
                <span>Tasks</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-blue-500 rounded"></div>
                <span>Schedules</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-green-600 rounded"></div>
                <span>DPR Reports</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-4 h-4 bg-red-600 rounded"></div>
                <span>Expenses</span>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div id="calendarContainer" class="bg-white rounded-lg shadow {% if not selected_project %}hidden{% endif %}">
        <div class="p-6">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- No Project Selected Message -->
    <div id="selectProjectMessage" class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 {% if selected_project %}hidden{% endif %}">
        <div class="text-center">
            <i class="fas fa-calendar-alt text-yellow-500 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-yellow-800 mb-2">Select a Project</h3>
            <p class="text-yellow-700">Choose a project from the dropdown above to view its calendar events including milestones, tasks, schedules, and important dates.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectSelector = document.getElementById('projectSelector');
    const calendarControls = document.getElementById('calendarControls');
    const calendarContainer = document.getElementById('calendarContainer');
    const selectProjectMessage = document.getElementById('selectProjectMessage');
    const filterEvents = document.getElementById('filterEvents');
    
    let calendar = null;
    let allEvents = [];
    let selectedProjectId = null;

    // Initialize calendar
    function initializeCalendar(events = []) {
        const calendarEl = document.getElementById('calendar');
        if (calendar) {
            calendar.destroy();
        }
        
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: events,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            eventClick: function(info) {
                // Show event details in a popup or modal
                alert(`Event: ${info.event.title}\n\nDescription: ${info.event.extendedProps.description || 'No description available'}`);
            },
            eventMouseEnter: function(info) {
                info.el.title = info.event.extendedProps.description || info.event.title;
            }
        });
        
        calendar.render();
    }

    // Load project calendar events
    async function loadProjectCalendar(projectId) {
        if (!projectId) {
            calendarControls.classList.add('hidden');
            calendarContainer.classList.add('hidden');
            selectProjectMessage.classList.remove('hidden');
            return;
        }

        try {
            const response = await fetch(`/project/calendar/events/${projectId}`, {
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load calendar events');
            }

            const data = await response.json();
            if (data.status === 'success') {
                allEvents = data.events;
                initializeCalendar(allEvents);
                
                calendarControls.classList.remove('hidden');
                calendarContainer.classList.remove('hidden');
                selectProjectMessage.classList.add('hidden');
                
                // Reset filter
                filterEvents.value = '';
            } else {
                throw new Error(data.message || 'Failed to load events');
            }
        } catch (error) {
            console.error('Error loading calendar events:', error);
            showNotification('Failed to load calendar events', 'error');
            
            calendarControls.classList.add('hidden');
            calendarContainer.classList.add('hidden');
            selectProjectMessage.classList.remove('hidden');
        }
    }

    // Filter events by type
    function filterEventsByType(type) {
        if (!type) {
            initializeCalendar(allEvents);
            return;
        }

        const filteredEvents = allEvents.filter(event => event.type === type);
        initializeCalendar(filteredEvents);
    }

    // Show notification
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Event listeners
    if (projectSelector) {
        projectSelector.addEventListener('change', function() {
            selectedProjectId = this.value;
            loadProjectCalendar(selectedProjectId);
        });

        // Load initial project if selected
        if (projectSelector.value) {
            selectedProjectId = projectSelector.value;
            loadProjectCalendar(selectedProjectId);
        }
    }

    if (filterEvents) {
        filterEvents.addEventListener('change', function() {
            filterEventsByType(this.value);
        });
    }

    // Initialize empty calendar if no project selected
    if (!selectedProjectId) {
        initializeCalendar([]);
    }
});
</script>
{% endblock %}