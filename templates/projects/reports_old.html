{% extends "projects/base.html" %}

{% block title %}Reports | SammyA Projects{% endblock %}
{% block header %}Project Reports{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Project Selection Required -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <i class="bx bx-info-circle text-blue-500 text-xl"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-blue-800">Project Context Required</h3>
                <p class="text-sm text-blue-600">Select a project below to view reports and DPRs for that specific project.</p>
            </div>
        </div>
    </div>
    
    <!-- Project Selection -->
    {% if accessible_projects %}
    <div class="flex items-center space-x-3">
        <label for="projectSelector" class="text-sm font-medium text-gray-700">Select Project:</label>
        <select id="projectSelector" class="px-4 py-2 border rounded-lg flex-1 max-w-md">
            <option value="">-- Select a Project to Continue --</option>
            {% for proj in accessible_projects %}
            <option value="{{ proj.id }}">{{ proj.name }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <!-- Reports Tabs -->
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button id="generalReportsTab" class="border-transparent text-indigo-600 border-b-2 border-indigo-500 py-2 px-1 text-sm font-medium tab-button active">
                General Reports
            </button>
            <button id="dprTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-2 px-1 text-sm font-medium tab-button">
                Daily Production Reports
            </button>
        </nav>
    </div>

    <!-- General Reports Section -->
    <div id="generalReportsSection" class="tab-content">
        <!-- Actions -->
        <div class="flex justify-between mb-6">
            <div class="flex space-x-3">
                <button id="createReportBtn" disabled
                        class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed">
                    Create Report (Select Project)
                </button>
                <button id="exportReportsBtn" disabled class="px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed">
                    Export Reports (Select Project)
                </button>
            </div>
            <div class="flex space-x-3">
                <select id="filterReports" class="px-4 py-2 border rounded-lg">
                    <option value="">All Types</option>
                    <option value="progress">Progress Report</option>
                    <option value="financial">Financial Report</option>
                    <option value="material">Material Report</option>
                    <option value="equipment">Equipment Report</option>
                </select>
            </div>
        </div>

        <!-- Reports List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Project Reports</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Author</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="reportsTableBody">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Select a project to view reports</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DPR Section -->
    <div id="dprSection" class="tab-content hidden">
        <!-- DPR Actions -->
        <div class="flex justify-between mb-6">
            <div class="flex space-x-3">
                {% if user_role == 'super_hq' or user_role == 'project_manager' %}
                <a id="manageDPRBtn" href="/projects/dpr" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 inline-block">
                    Manage DPRs
                </a>
                {% endif %}
                <button id="exportDPRBtn" disabled class="px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed">
                    Export DPRs (Select Project)
                </button>
            </div>
            <div class="flex space-x-3">
                <select id="dprStatusFilter" class="px-4 py-2 border rounded-lg">
                    <option value="">All Status</option>
                    <option value="draft">Draft</option>
                    <option value="sent_to_staff">Sent to Staff</option>
                    <option value="completed">Completed</option>
                    <option value="reviewed">Reviewed</option>
                </select>
            </div>
        </div>

        <!-- DPR Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="dprSummaryCards">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="bx bx-file text-indigo-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total DPRs</p>
                        <p class="text-lg font-semibold text-gray-900" id="totalDPRs">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="bx bx-time text-yellow-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Pending</p>
                        <p class="text-lg font-semibold text-gray-900" id="pendingDPRs">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="bx bx-check-circle text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Completed</p>
                        <p class="text-lg font-semibold text-gray-900" id="completedDPRs">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="bx bx-calendar text-blue-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">This Month</p>
                        <p class="text-lg font-semibold text-gray-900" id="monthlyDPRs">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- DPR List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Daily Production Reports</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created By</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completed</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="dprTableBody">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Select a project to view DPRs</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Report Modal -->
<div id="createReportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Create Report</h3>
            <form id="createReportForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Report Title</label>
                    <input type="text" name="title" required class="mt-1 border p-2 block w-full rounded-md border-gray-300">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Report Type</label>
                    <select name="type" required class="mt-1 block border p-2 w-full rounded-md border-gray-300">
                        {% for type in data.report_types %}
                        <option value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea name="description" rows="3" class="mt-1 border p-2 block w-full rounded-md border-gray-300"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="closeModal px-4 py-2 bg-gray-200 text-gray-800 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectSelector = document.getElementById('projectSelector');
    const generalReportsTab = document.getElementById('generalReportsTab');
    const dprTab = document.getElementById('dprTab');
    const generalReportsSection = document.getElementById('generalReportsSection');
    const dprSection = document.getElementById('dprSection');
    const createReportBtn = document.getElementById('createReportBtn');
    const exportReportsBtn = document.getElementById('exportReportsBtn');
    const exportDPRBtn = document.getElementById('exportDPRBtn');

    // Tab switching
    function switchTab(tab) {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active', 'text-indigo-600', 'border-indigo-500');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        
        // Update content sections
        document.querySelectorAll('.tab-content').forEach(section => {
            section.classList.add('hidden');
        });
        
        if (tab === 'dpr') {
            dprTab.classList.add('active', 'text-indigo-600', 'border-indigo-500');
            dprTab.classList.remove('text-gray-500', 'border-transparent');
            dprSection.classList.remove('hidden');
        } else {
            generalReportsTab.classList.add('active', 'text-indigo-600', 'border-indigo-500');
            generalReportsTab.classList.remove('text-gray-500', 'border-transparent');
            generalReportsSection.classList.remove('hidden');
        }
    }

    generalReportsTab.addEventListener('click', () => switchTab('general'));
    dprTab.addEventListener('click', () => switchTab('dpr'));

    // Project selection handler
    if (projectSelector) {
        projectSelector.addEventListener('change', () => {
            const selectedProject = projectSelector.value;
            const projectName = projectSelector.options[projectSelector.selectedIndex].text;
            
            if (selectedProject) {
                // Enable buttons
                if (createReportBtn) {
                    createReportBtn.disabled = false;
                    createReportBtn.className = "px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700";
                    createReportBtn.textContent = `Create Report for ${projectName}`;
                }
                if (exportReportsBtn) {
                    exportReportsBtn.disabled = false;
                    exportReportsBtn.className = "px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50";
                    exportReportsBtn.textContent = `Export ${projectName} Reports`;
                }
                if (exportDPRBtn) {
                    exportDPRBtn.disabled = false;
                    exportDPRBtn.className = "px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50";
                    exportDPRBtn.textContent = `Export ${projectName} DPRs`;
                }
                
                // Load project data
                loadProjectReports(selectedProject);
                loadProjectDPRs(selectedProject);
            } else {
                // Disable buttons
                if (createReportBtn) {
                    createReportBtn.disabled = true;
                    createReportBtn.className = "px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed";
                    createReportBtn.textContent = "Create Report (Select Project)";
                }
                if (exportReportsBtn) {
                    exportReportsBtn.disabled = true;
                    exportReportsBtn.className = "px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed";
                    exportReportsBtn.textContent = "Export Reports (Select Project)";
                }
                if (exportDPRBtn) {
                    exportDPRBtn.disabled = true;
                    exportDPRBtn.className = "px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 cursor-not-allowed";
                    exportDPRBtn.textContent = "Export DPRs (Select Project)";
                }
                
                // Clear tables
                clearReportsTables();
            }
        });
    }

    function loadProjectReports(projectId) {
        const tbody = document.getElementById('reportsTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading reports...</td></tr>';
        
        // Load actual reports for the project
        fetch(`/projects/reports/project/${projectId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    populateReportsTable(data.reports);
                } else {
                    console.error('Failed to load reports:', data.message);
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load reports: ' + data.message + '</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading reports:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading reports. Please try again.</td></tr>';
            });
    }
    
    function populateReportsTable(reports) {
        const tbody = document.getElementById('reportsTableBody');
        
        if (reports.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No reports found for this project</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        reports.forEach(report => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const statusClass = {
                'draft': 'bg-gray-100 text-gray-800',
                'final': 'bg-green-100 text-green-800',
                'reviewed': 'bg-blue-100 text-blue-800'
            }[report.status.toLowerCase()] || 'bg-gray-100 text-gray-800';
            
            // Format date properly
            const reportDate = new Date(report.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${report.title}</div>
                    ${report.description ? '<div class="text-sm text-gray-500">' + report.description + '</div>' : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${report.type}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${reportDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${report.author}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                        ${report.status.toUpperCase()}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <a href="#" onclick="viewReport(${report.id})" class="text-indigo-600 hover:text-indigo-900">View</a>
                    <span class="text-gray-400">|</span>
                    <a href="#" onclick="editReport(${report.id})" class="text-green-600 hover:text-green-900">Edit</a>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function loadProjectDPRs(projectId) {
        // Load DPR summary and list
        fetch(`/projects/dpr/project/${projectId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateDPRSummary(data.dprs);
                    populateDPRTable(data.dprs);
                } else {
                    console.error('Failed to load DPRs:', data.message);
                    document.getElementById('dprTableBody').innerHTML = 
                        '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load DPRs: ' + data.message + '</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading DPRs:', error);
                document.getElementById('dprTableBody').innerHTML = 
                    '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading DPRs. Please try again.</td></tr>';
            });
    }

    function updateDPRSummary(dprs) {
        const total = dprs.length;
        const pending = dprs.filter(dpr => dpr.status === 'sent_to_staff').length;
        const completed = dprs.filter(dpr => dpr.status === 'completed').length;
        const thisMonth = dprs.filter(dpr => {
            const dprDate = new Date(dpr.report_date);
            const now = new Date();
            return dprDate.getMonth() === now.getMonth() && dprDate.getFullYear() === now.getFullYear();
        }).length;

        document.getElementById('totalDPRs').textContent = total;
        document.getElementById('pendingDPRs').textContent = pending;
        document.getElementById('completedDPRs').textContent = completed;
        document.getElementById('monthlyDPRs').textContent = thisMonth;
    }

    function populateDPRTable(dprs) {
        const tbody = document.getElementById('dprTableBody');
        
        if (dprs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No DPRs found for this project</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        dprs.forEach(dpr => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const statusClass = {
                'draft': 'bg-gray-100 text-gray-800',
                'sent_to_staff': 'bg-yellow-100 text-yellow-800',
                'completed': 'bg-green-100 text-green-800',
                'reviewed': 'bg-blue-100 text-blue-800'
            }[dpr.status] || 'bg-gray-100 text-gray-800';
            
            // Format dates properly
            const reportDate = new Date(dpr.report_date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            const completedDate = dpr.completed_at ? 
                new Date(dpr.completed_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${reportDate}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                        ${dpr.status.replace('_', ' ').toUpperCase()}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${dpr.created_by}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${dpr.assigned_to}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${completedDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <a href="/projects/dpr/${dpr.id}/fill" class="text-indigo-600 hover:text-indigo-900">View</a>
                    ${dpr.status === 'completed' ? 
                        '<span class="text-gray-400">|</span><a href="#" onclick="viewDPRDetails(' + dpr.id + ')" class="text-green-600 hover:text-green-900">Details</a>' : ''
                    }
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function clearReportsTables() {
        document.getElementById('reportsTableBody').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Select a project to view reports</td></tr>';
        document.getElementById('dprTableBody').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Select a project to view DPRs</td></tr>';
        
        // Clear DPR summary
        document.getElementById('totalDPRs').textContent = '-';
        document.getElementById('pendingDPRs').textContent = '-';
        document.getElementById('completedDPRs').textContent = '-';
        document.getElementById('monthlyDPRs').textContent = '-';
    }

    // Create Report functionality
    if (createReportBtn) {
        createReportBtn.addEventListener('click', () => {
            if (!createReportBtn.disabled) {
                showCreateReportModal();
            }
        });
    }

    // Export functionality
    if (exportDPRBtn) {
        exportDPRBtn.addEventListener('click', () => {
            if (!exportDPRBtn.disabled) {
                const projectName = projectSelector.options[projectSelector.selectedIndex].text;
                alert(`Exporting DPRs for ${projectName}...`);
            }
        });
    }
});

// DPR Details Modal Function
function viewDPRDetails(dprId) {
    fetch(`/projects/dpr/${dprId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showDPRDetailsModal(data.dpr);
            } else {
                alert('Failed to load DPR details: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading DPR details:', error);
            alert('Error loading DPR details. Please try again.');
        });
}

function showDPRDetailsModal(dpr) {
    // Create modal HTML
    const modalHTML = `
        <div id="dprDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">DPR Details - ${new Date(dpr.report_date).toLocaleDateString()}</h3>
                        <button onclick="closeDPRDetailsModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="bx bx-x text-2xl"></i>
                        </button>
                    </div>
                    
                    <!-- Production Items -->
                    <div class="mb-6">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">Production Items</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Target Qty</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Daily Production</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Done</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Progress</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${dpr.production_items.map(item => {
                                        const progress = item.target_qty > 0 ? (item.total_qty_done / item.target_qty * 100).toFixed(1) : 0;
                                        const progressClass = progress >= 100 ? 'text-green-600' : progress >= 50 ? 'text-yellow-600' : 'text-red-600';
                                        return `
                                            <tr>
                                                <td class="px-4 py-2 text-sm">
                                                    <div class="font-medium text-gray-900">${item.item_code}</div>
                                                    <div class="text-gray-500 text-xs">${item.description}</div>
                                                </td>
                                                <td class="px-4 py-2 text-sm text-gray-900">${item.location || '-'}</td>
                                                <td class="px-4 py-2 text-sm text-gray-900">${item.unit}</td>
                                                <td class="px-4 py-2 text-sm font-medium text-blue-600">${item.target_qty.toLocaleString()}</td>
                                                <td class="px-4 py-2 text-sm font-medium text-green-600">${item.day_production.toLocaleString()}</td>
                                                <td class="px-4 py-2 text-sm text-gray-900">${item.total_qty_done.toLocaleString()}</td>
                                                <td class="px-4 py-2 text-sm font-medium ${progressClass}">${progress}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Material Usage -->
                    <div class="mb-6">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">Material Usage</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Material</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Previous Usage</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Daily Usage</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Usage</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${dpr.material_usage.map(material => `
                                        <tr>
                                            <td class="px-4 py-2 text-sm">
                                                <div class="font-medium text-gray-900">${material.item_number}</div>
                                                <div class="text-gray-500 text-xs">${material.description}</div>
                                            </td>
                                            <td class="px-4 py-2 text-sm text-gray-900">${material.unit}</td>
                                            <td class="px-4 py-2 text-sm text-gray-600">${material.previous_qty_used.toLocaleString()}</td>
                                            <td class="px-4 py-2 text-sm font-medium text-green-600">${material.day_usage.toLocaleString()}</td>
                                            <td class="px-4 py-2 text-sm text-gray-900">${material.total_qty_used.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Issues and Notes -->
                    ${dpr.issues ? `
                        <div class="mb-4">
                            <h4 class="text-md font-semibold text-gray-800 mb-2">Issues & Notes</h4>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                <p class="text-sm text-gray-700">${dpr.issues}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Signatures -->
                    <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Prepared By</label>
                            <p class="text-sm text-gray-900">${dpr.prepared_by || '-'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Checked By</label>
                            <p class="text-sm text-gray-900">${dpr.checked_by || '-'}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeDPRDetailsModal() {
    const modal = document.getElementById('dprDetailsModal');
    if (modal) {
        modal.remove();
    }
}

// Report management functions
function viewReport(reportId) {
    // This would open a report viewer
    window.open(`/projects/reports/${reportId}`, '_blank');
}

function editReport(reportId) {
    // This would open a report editor
    window.open(`/projects/reports/${reportId}/edit`, '_blank');
}

// Create Report Modal Functions
function showCreateReportModal() {
    const modal = document.getElementById('createReportModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function hideCreateReportModal() {
    const modal = document.getElementById('createReportModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Handle create report form submission
document.getElementById('createReportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const projectId = document.getElementById('projectSelector').value;
    
    const reportData = {
        project_id: projectId,
        title: formData.get('title'),
        type: formData.get('type'),
        description: formData.get('description')
    };
    
    fetch('/projects/reports/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(reportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Report created successfully!');
            hideCreateReportModal();
            // Reload reports for the current project
            loadProjectReports(projectId);
            // Reset form
            document.getElementById('createReportForm').reset();
        } else {
            alert('Failed to create report: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating report:', error);
        alert('Error creating report. Please try again.');
    });
});

// Close modal handlers
document.querySelectorAll('.closeModal').forEach(btn => {
    btn.addEventListener('click', hideCreateReportModal);
});
</script>
{% endblock %}