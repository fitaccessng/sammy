{% extends "projects/base.html" %}

{% block title %}Account Settings | SammyA Projects{% endblock %}
{% block header %}Account Settings{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- User Info Summary -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg shadow">
        <div class="p-6 text-white">
            <div class="flex items-center space-x-4">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-semibold">{{ user.name or 'User' }}</h2>
                    <p class="text-indigo-100">{{ user.role or 'Staff Member' }} â€¢ {{ user.department or 'General' }}</p>
                    <p class="text-indigo-100 text-sm">{{ user.email }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'error' }} p-4 rounded-lg mb-4
                    {{ 'bg-green-50 border border-green-200 text-green-800' if category == 'success' else 'bg-red-50 border border-red-200 text-red-800' }}">
                    <div class="flex items-center">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} mr-2"></i>
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Profile Settings -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-user-edit text-indigo-600 mr-3"></i>
                <h2 class="text-lg font-medium text-gray-900">Profile Settings</h2>
            </div>
            <form method="POST" action="{{ url_for('project.settings', form='profile') }}" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" name="name" value="{{ user.name or '' }}" required
                               class="mt-1 border p-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" name="email" value="{{ user.email or '' }}" required
                               class="mt-1 border p-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Role</label>
                        <input type="text" value="{{ user.role or 'Not Assigned' }}" disabled
                               class="mt-1 border p-2 block w-full rounded-md border-gray-300 bg-gray-50 text-gray-500">
                        <p class="text-xs text-gray-500 mt-1">Contact an administrator to change your role</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Department</label>
                        <select name="department" class="mt-1 border p-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="">Select Department</option>
                            <option value="Engineering" {{ 'selected' if user.department == 'Engineering' }}>Engineering</option>
                            <option value="Construction" {{ 'selected' if user.department == 'Construction' }}>Construction</option>
                            <option value="Project Management" {{ 'selected' if user.department == 'Project Management' }}>Project Management</option>
                            <option value="Finance" {{ 'selected' if user.department == 'Finance' }}>Finance</option>
                            <option value="Human Resources" {{ 'selected' if user.department == 'Human Resources' }}>Human Resources</option>
                            <option value="Procurement" {{ 'selected' if user.department == 'Procurement' }}>Procurement</option>
                            <option value="Quality Control" {{ 'selected' if user.department == 'Quality Control' }}>Quality Control</option>
                            <option value="Operations" {{ 'selected' if user.department == 'Operations' }}>Operations</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        <i class="fas fa-save mr-2"></i>Save Profile
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Settings -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-shield-alt text-indigo-600 mr-3"></i>
                <h2 class="text-lg font-medium text-gray-900">Security Settings</h2>
            </div>
            <form method="POST" action="{{ url_for('project.settings', form='security') }}" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Current Password</label>
                        <input type="password" name="current_password" required
                               class="mt-1 border p-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="Enter your current password">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">New Password</label>
                        <input type="password" name="new_password" required minlength="8"
                               class="mt-1 border p-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="Enter a new strong password">
                        <p class="text-xs text-gray-500 mt-1">Password must be at least 8 characters long</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                        <input type="password" name="confirm_password" required minlength="8"
                               class="mt-1 border p-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                               placeholder="Confirm your new password">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        <i class="fas fa-key mr-2"></i>Update Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Settings -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-bell text-indigo-600 mr-3"></i>
                <h2 class="text-lg font-medium text-gray-900">Notification Preferences</h2>
            </div>
            <form method="POST" action="{{ url_for('project.settings', form='notifications') }}" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h3 class="text-sm font-medium text-gray-700">Email Notifications</h3>
                            <p class="text-sm text-gray-500">Receive project updates and important announcements via email</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="email_notifications" class="sr-only peer" 
                                   {{ 'checked' if user.notification_preferences.email_notifications }}>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h3 class="text-sm font-medium text-gray-700">Task Reminders</h3>
                            <p class="text-sm text-gray-500">Get reminded about upcoming tasks and deadlines</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="task_reminders" class="sr-only peer"
                                   {{ 'checked' if user.notification_preferences.task_reminders }}>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h3 class="text-sm font-medium text-gray-700">Project Updates</h3>
                            <p class="text-sm text-gray-500">Notifications about project status changes and milestones</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="project_updates" class="sr-only peer"
                                   {{ 'checked' if user.notification_preferences.get('project_updates', True) }}>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        <i class="fas fa-save mr-2"></i>Save Preferences
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Information -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-info-circle text-indigo-600 mr-3"></i>
                <h2 class="text-lg font-medium text-gray-900">Account Information</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Account Status</label>
                    <div class="mt-1 flex items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Active
                        </span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Member Since</label>
                    <p class="mt-1 text-sm text-gray-900">{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'Not Available' }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Last Login</label>
                    <p class="mt-1 text-sm text-gray-900">{{ current_user.last_login.strftime('%B %d, %Y at %I:%M %p') if current_user.last_login else 'Never' }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Projects Assigned</label>
                    <p class="mt-1 text-sm text-gray-900">{{ accessible_projects|length if accessible_projects else 0 }} project(s)</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password confirmation validation
    const securityForm = document.querySelector('form[action*="security"]');
    if (securityForm) {
        securityForm.addEventListener('submit', function(e) {
            const newPassword = this.querySelector('input[name="new_password"]').value;
            const confirmPassword = this.querySelector('input[name="confirm_password"]').value;
            
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                showNotification('New passwords do not match!', 'error');
                return false;
            }
            
            if (newPassword.length < 8) {
                e.preventDefault();
                showNotification('Password must be at least 8 characters long!', 'error');
                return false;
            }
        });
    }

    // Form submission feedback
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            }
        });
    });

    // Show notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                ${message}
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Auto-hide flash messages after 5 seconds
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        }, 5000);
    });
});
</script>
{% endblock %}