{% extends "projects/base.html" %}

{% block title %}Reports | SammyA Projects{% endblock %}
{% block header %}Project Reports{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Project Selection Required -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <i class="bx bx-info-circle text-blue-500 text-xl"></i>
            </div>
            <div>
                <h3 class="text-sm font-medium text-blue-800">Project Context Required</h3>
                <p class="text-sm text-blue-600">Select a project below to view reports and DPRs for that specific project.</p>
            </div>
        </div>
    </div>
    
    <!-- Project Selection Form -->
    {% if accessible_projects %}
    <form method="GET" action="{{ url_for('project.reports_index') }}">
        <div class="flex items-center space-x-3">
            <label for="projectSelector" class="text-sm font-medium text-gray-700">Select Project:</label>
            <select name="selected_project_id" id="projectSelector" class="px-4 py-2 border rounded-lg flex-1 max-w-md" onchange="this.form.submit()">
                <option value="">-- Select a Project to Continue --</option>
                {% for proj in accessible_projects %}
                <option value="{{ proj.id }}" {% if selected_project and selected_project.id == proj.id %}selected{% endif %}>
                    {{ proj.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </form>
    {% endif %}

    {% if selected_project %}
    <!-- Reports Tabs -->
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button id="generalReportsTab" class="border-transparent text-indigo-600 border-b-2 border-indigo-500 py-2 px-1 text-sm font-medium tab-button active">
                General Reports
            </button>
            <button id="dprTab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-2 px-1 text-sm font-medium tab-button">
                Daily Production Reports
            </button>
        </nav>
    </div>

    <!-- General Reports Section -->
    <div id="generalReportsSection" class="tab-content">
        <!-- Actions -->
        <div class="flex justify-between mb-6">
            <div class="flex space-x-3">
                <button id="createReportBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Create Report for {{ selected_project.name }}
                </button>
                <button id="exportReportsBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Export {{ selected_project.name }} Reports
                </button>
            </div>
            <div class="flex space-x-3">
                <select id="filterReports" class="px-4 py-2 border rounded-lg">
                    <option value="">All Types</option>
                    <option value="progress">Progress Report</option>
                    <option value="financial">Financial Report</option>
                    <option value="material">Material Report</option>
                    <option value="equipment">Equipment Report</option>
                </select>
            </div>
        </div>

        <!-- Reports List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Project Reports</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Author</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% if project_reports %}
                            {% for report in project_reports %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ report.title }}</div>
                                    {% if report.description %}
                                    <div class="text-sm text-gray-500">{{ report.description }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ report.type }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ report.date.strftime('%b %d, %Y') if report.date else 'Unknown' }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ report.author }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% set status_class = {
                                        'draft': 'bg-gray-100 text-gray-800',
                                        'final': 'bg-green-100 text-green-800',
                                        'reviewed': 'bg-blue-100 text-blue-800'
                                    }.get(report.status.lower(), 'bg-gray-100 text-gray-800') %}
                                    <span class="px-2 py-1 text-xs font-medium rounded-full {{ status_class }}">
                                        {{ report.status.upper() }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <a href="#" onclick="viewReport({{ report.id }})" class="text-indigo-600 hover:text-indigo-900">View</a>
                                    <span class="text-gray-400">|</span>
                                    <a href="#" onclick="editReport({{ report.id }})" class="text-green-600 hover:text-green-900">Edit</a>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">No reports found for this project</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DPR Section -->
    <div id="dprSection" class="tab-content hidden">
        <!-- DPR Actions -->
        <div class="flex justify-between mb-6">
            <div class="flex space-x-3">
                {% if user_role == 'super_hq' or user_role == 'project_manager' %}
                <a href="/projects/dpr" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 inline-block">
                    Manage DPRs
                </a>
                {% endif %}
                <button id="exportDPRBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Export {{ selected_project.name }} DPRs
                </button>
            </div>
            <div class="flex space-x-3">
                <select id="dprStatusFilter" class="px-4 py-2 border rounded-lg">
                    <option value="">All Status</option>
                    <option value="draft">Draft</option>
                    <option value="sent_to_staff">Sent to Staff</option>
                    <option value="completed">Completed</option>
                    <option value="reviewed">Reviewed</option>
                </select>
            </div>
        </div>

        <!-- DPR Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="bx bx-file text-indigo-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total DPRs</p>
                        <p class="text-lg font-semibold text-gray-900">{{ dpr_summary.total }}</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="bx bx-time text-yellow-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Pending</p>
                        <p class="text-lg font-semibold text-gray-900">{{ dpr_summary.pending }}</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="bx bx-check-circle text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Completed</p>
                        <p class="text-lg font-semibold text-gray-900">{{ dpr_summary.completed }}</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="bx bx-calendar text-blue-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">This Month</p>
                        <p class="text-lg font-semibold text-gray-900">{{ dpr_summary.monthly }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- DPR List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Daily Production Reports</h3>
                <p class="text-sm text-gray-600 mt-1">
                    Target quantity represents the planned work, while daily production shows actual work completed that day.
                </p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created By</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completed</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="dprTableBody">
                        {% if project_dprs %}
                            {% for dpr in project_dprs %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    {{ dpr.report_date.strftime('%b %d, %Y') }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% set status_class = {
                                        'draft': 'bg-gray-100 text-gray-800',
                                        'sent_to_staff': 'bg-yellow-100 text-yellow-800',
                                        'completed': 'bg-green-100 text-green-800',
                                        'reviewed': 'bg-blue-100 text-blue-800'
                                    }.get(dpr.status, 'bg-gray-100 text-gray-800') %}
                                    <span class="px-2 py-1 text-xs font-medium rounded-full {{ status_class }}">
                                        {{ dpr.status.replace('_', ' ').upper() }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ dpr.created_by }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ dpr.assigned_to }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {% if dpr.completed_at %}
                                        {{ dpr.completed_at.strftime('%b %d, %Y %I:%M %p') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <a href="/projects/dpr/{{ dpr.id }}/fill" class="text-indigo-600 hover:text-indigo-900">View</a>
                                    {% if dpr.status == 'completed' %}
                                    <span class="text-gray-400">|</span>
                                    <a href="#" onclick="viewDPRDetails({{ dpr.id }})" class="text-green-600 hover:text-green-900">Details</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">No DPRs found for this project</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No project selected message -->
    <div class="text-center py-12">
        <i class="bx bx-folder-open text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-medium text-gray-900 mb-2">No Project Selected</h3>
        <p class="text-gray-500">Please select a project above to view its reports and DPRs.</p>
    </div>
    {% endif %}
</div>

<!-- Create Report Modal -->
<div id="createReportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Create Report</h3>
            <form id="createReportForm" method="POST" action="{{ url_for('project.create_report') }}" class="space-y-4">
                {% if selected_project %}
                <input type="hidden" name="project_id" value="{{ selected_project.id }}">
                {% endif %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">Report Title</label>
                    <input type="text" name="title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Report Type</label>
                    <select name="type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        {% for type in data.report_types %}
                        <option value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="closeModal px-4 py-2 bg-gray-200 text-gray-800 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generalReportsTab = document.getElementById('generalReportsTab');
    const dprTab = document.getElementById('dprTab');
    const generalReportsSection = document.getElementById('generalReportsSection');
    const dprSection = document.getElementById('dprSection');
    const createReportBtn = document.getElementById('createReportBtn');

    // Tab switching functionality only
    function switchTab(tab) {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active', 'text-indigo-600', 'border-indigo-500');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        
        // Update content sections
        document.querySelectorAll('.tab-content').forEach(section => {
            section.classList.add('hidden');
        });
        
        if (tab === 'dpr') {
            dprTab.classList.add('active', 'text-indigo-600', 'border-indigo-500');
            dprTab.classList.remove('text-gray-500', 'border-transparent');
            dprSection.classList.remove('hidden');
        } else {
            generalReportsTab.classList.add('active', 'text-indigo-600', 'border-indigo-500');
            generalReportsTab.classList.remove('text-gray-500', 'border-transparent');
            generalReportsSection.classList.remove('hidden');
        }
    }

    if (generalReportsTab) generalReportsTab.addEventListener('click', () => switchTab('general'));
    if (dprTab) dprTab.addEventListener('click', () => switchTab('dpr'));

    // Create Report Modal
    if (createReportBtn) {
        createReportBtn.addEventListener('click', () => {
            const modal = document.getElementById('createReportModal');
            if (modal) modal.classList.remove('hidden');
        });
    }

    // Close modal handlers
    document.querySelectorAll('.closeModal').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = document.getElementById('createReportModal');
            if (modal) modal.classList.add('hidden');
        });
    });

    // Report filtering (client-side)
    const filterSelect = document.getElementById('filterReports');
    if (filterSelect) {
        filterSelect.addEventListener('change', function() {
            const filterValue = this.value.toLowerCase();
            const rows = document.querySelectorAll('#generalReportsSection tbody tr');
            
            rows.forEach(row => {
                if (filterValue === '') {
                    row.style.display = '';
                } else {
                    const typeCell = row.cells[1];
                    if (typeCell && typeCell.textContent.toLowerCase().includes(filterValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
    }

    // DPR Status filtering (client-side)
    const dprFilterSelect = document.getElementById('dprStatusFilter');
    if (dprFilterSelect) {
        dprFilterSelect.addEventListener('change', function() {
            const filterValue = this.value.toLowerCase();
            const rows = document.querySelectorAll('#dprTableBody tr');
            
            rows.forEach(row => {
                if (filterValue === '') {
                    row.style.display = '';
                } else {
                    const statusCell = row.cells[1];
                    if (statusCell && statusCell.textContent.toLowerCase().includes(filterValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
    }
});

// Simple report functions
function viewReport(reportId) {
    window.open(`/projects/reports/${reportId}`, '_blank');
}

function editReport(reportId) {
    window.open(`/projects/reports/${reportId}/edit`, '_blank');
}

function viewDPRDetails(dprId) {
    window.open(`/projects/dpr/${dprId}/fill`, '_blank');
}
</script>
{% endblock %}