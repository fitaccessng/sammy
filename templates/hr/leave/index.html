{% extends "hr/base.html" %}

{% block title %}Leave Management | SammyA HR{% endblock %}
{% block header %}Leave Management{% endblock %}

{% block extra_head %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Leave Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Pending Requests</p>
                    <p class="text-3xl font-bold text-yellow-600">{{ leaves.pending }}</p>
                </div>
                <div class="bg-yellow-100 p-3 rounded-full">
                    <i class='bx bx-time text-2xl text-yellow-600'></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Approved</p>
                    <p class="text-3xl font-bold text-green-600">{{ leaves.approved }}</p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class='bx bx-check-circle text-2xl text-green-600'></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Rejected</p>
                    <p class="text-3xl font-bold text-red-600">{{ leaves.rejected }}</p>
                </div>
                <div class="bg-red-100 p-3 rounded-full">
                    <i class='bx bx-x-circle text-2xl text-red-600'></i>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Upcoming</p>
                    <p class="text-3xl font-bold text-blue-600">{{ leaves.upcoming }}</p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class='bx bx-calendar text-2xl text-blue-600'></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Leave Request Form -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">New Leave Request</h2>
            <form method="post" action="{{ url_for('hr.create_leave') }}" id="leaveRequestForm" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                
                <div>
                    <label for="employee_id" class="block text-sm font-medium text-gray-700 mb-2">Staff Member *</label>
                    <select id="employee_id" name="employee_id" required 
                            class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Staff</option>
                        {% if employees %}
                            {% for emp in employees %}
                            <option value="{{ emp.id }}">{{ emp.name }} ({{ emp.department or 'No Dept' }})</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                
                <div>
                    <label for="leave_type" class="block text-sm font-medium text-gray-700 mb-2">Leave Type *</label>
                    <select id="leave_type" name="leave_type" required
                            class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                        <option value="Annual">Annual Leave</option>
                        <option value="Sick">Sick Leave</option>
                        <option value="Maternity">Maternity Leave</option>
                        <option value="Paternity">Paternity Leave</option>
                        <option value="Study">Study Leave</option>
                        <option value="Emergency">Emergency Leave</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2">Start Date *</label>
                        <input type="date" id="start_date" name="start_date" required
                               class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2">End Date *</label>
                        <input type="date" id="end_date" name="end_date" required
                               class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
                    <textarea id="reason" name="reason" rows="3" placeholder="Brief reason for leave"
                              class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    Submit Request
                </button>
            </form>
        </div>

        <!-- Leave Calendar -->
       
    </div>
</div>

<!-- Leave Details Modal -->
<div id="leaveDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Leave Request Details</h3>
            <button onclick="hideModal()" class="text-gray-500 hover:text-gray-700">
                <i class='bx bx-x text-2xl'></i>
            </button>
        </div>
        
        <div class="space-y-3 mb-6">
            <div class="flex justify-between">
                <span class="text-gray-600">Staff:</span>
                <span id="modal-staff" class="font-medium"></span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Department:</span>
                <span id="modal-dept" class="font-medium"></span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Type:</span>
                <span id="modal-type" class="font-medium"></span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Duration:</span>
                <span id="modal-duration" class="font-medium"></span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Status:</span>
                <span id="modal-status" class="px-2 py-1 text-xs rounded-full"></span>
            </div>
        </div>
        
        <div class="flex items-center justify-end space-x-3">
            <button onclick="hideModal()" class="px-4 py-2 rounded border text-gray-700 hover:bg-gray-50">Close</button>
            <button id="modal-approve" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 hidden">Approve</button>
            <button id="modal-reject" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 hidden">Reject</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
console.log('Script loading...');

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    
    var calendarEl = document.getElementById('calendar');
    console.log('Calendar element:', calendarEl);
    
    if (!calendarEl) {
        console.error('Calendar element not found!');
        return;
    }
    
    // Check if FullCalendar is loaded
    if (typeof FullCalendar === 'undefined') {
        console.error('FullCalendar library not loaded!');
        calendarEl.innerHTML = '<div class="text-red-600 p-4">Error: Calendar library failed to load</div>';
        return;
    }
    
    // Parse leave events from backend
    var leaveEvents = {{ leave_events | tojson | safe }};
    console.log('Leave events loaded:', leaveEvents);
    console.log('Number of events:', leaveEvents.length);
    
    try {
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 600,
            contentHeight: 550,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listMonth'
            },
            events: leaveEvents,
            eventClick: function(info) {
                console.log('Event clicked:', info.event);
                const props = info.event.extendedProps;
                document.getElementById('modal-staff').textContent = props.staff || 'N/A';
                document.getElementById('modal-dept').textContent = props.department || 'N/A';
                document.getElementById('modal-type').textContent = props.type || 'N/A';
                
                // Format dates properly
                const startDate = info.event.start ? info.event.start.toLocaleDateString() : 'N/A';
                const endDate = info.event.end ? info.event.end.toLocaleDateString() : startDate;
                document.getElementById('modal-duration').textContent = startDate + ' - ' + endDate;
                
                const statusBadge = document.getElementById('modal-status');
                statusBadge.textContent = props.status || 'Pending';
                statusBadge.className = 'px-2 py-1 text-xs rounded-full ';
                if (props.status === 'Approved') {
                    statusBadge.className += 'bg-green-100 text-green-800';
                } else if (props.status === 'Rejected') {
                    statusBadge.className += 'bg-red-100 text-red-800';
                } else {
                    statusBadge.className += 'bg-yellow-100 text-yellow-800';
                }
                
                showModal();
            },
            eventDidMount: function(info) {
                const status = info.event.extendedProps.status;
                if (status === 'Approved') {
                    info.el.style.backgroundColor = '#10b981';
                    info.el.style.borderColor = '#10b981';
                } else if (status === 'Rejected') {
                    info.el.style.backgroundColor = '#ef4444';
                    info.el.style.borderColor = '#ef4444';
                } else {
                    info.el.style.backgroundColor = '#f59e0b';
                    info.el.style.borderColor = '#f59e0b';
                }
            }
        });
        
        console.log('Rendering calendar...');
        calendar.render();
        console.log('Calendar rendered successfully!');
        
    } catch (error) {
        console.error('Error initializing calendar:', error);
        calendarEl.innerHTML = '<div class="text-red-600 p-4">Error initializing calendar: ' + error.message + '</div>';
    }
});

function showModal() {
    document.getElementById('leaveDetailsModal').classList.remove('hidden');
    document.getElementById('leaveDetailsModal').classList.add('flex');
}

function hideModal() {
    document.getElementById('leaveDetailsModal').classList.add('hidden');
    document.getElementById('leaveDetailsModal').classList.remove('flex');
}
</script>
{% endblock %}
