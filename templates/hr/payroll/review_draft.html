{% extends "hr/base.html" %}

{% block title %}Review Draft Payroll | SammyA HR{% endblock %}
{% block header %}Review Draft Payroll{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Actions -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Draft Payroll Review</h2>
            <p class="text-gray-600">{{ summary.period }} • {{ summary.employee_count }} employees</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('hr.payroll') }}" 
               class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center">
                <i class='bx bx-arrow-back text-lg mr-2'></i>
                Back to Payroll
            </a>
            <button onclick="submitForApproval()" 
                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center">
                <i class='bx bx-check-circle text-lg mr-2'></i>
                Submit for Approval
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Total Gross</p>
                    <h3 class="text-xl font-bold text-blue-600">₦{{ "{:,.0f}".format(summary.total_gross) }}</h3>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class='bx bx-money text-2xl text-blue-600'></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Total Deductions</p>
                    <h3 class="text-xl font-bold text-red-600">₦{{ "{:,.0f}".format(summary.total_deductions) }}</h3>
                </div>
                <div class="bg-red-100 p-3 rounded-full">
                    <i class='bx bx-minus-circle text-2xl text-red-600'></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Net Payroll</p>
                    <h3 class="text-xl font-bold text-green-600">₦{{ "{:,.0f}".format(summary.total_net) }}</h3>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class='bx bx-check-circle text-2xl text-green-600'></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">Employees</p>
                    <h3 class="text-xl font-bold text-purple-600">{{ summary.employee_count }}</h3>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                    <i class='bx bx-user-check text-2xl text-purple-600'></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Payroll Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">Employee Payroll Details</h3>
            <p class="text-sm text-gray-600">Click on any row to edit payroll details</p>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Salary</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Loan/Advance</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Pension (JACO)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">PAYE Tax</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Late Deduction</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Net Salary</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Days Worked</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for payroll in payrolls %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-10 w-10 flex-shrink-0">
                                    <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold">
                                        {{ payroll.employee_name[:2].upper() }}
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ payroll.employee_name }}</div>
                                    <div class="text-sm text-gray-500">{{ payroll.staff_code or 'No code' }} • {{ payroll.department }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                            ₦{{ "{:,.2f}".format(payroll.gross) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                            ₦{{ "{:,.2f}".format(payroll.loan_or_salary_advance) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                            ₦{{ "{:,.2f}".format(payroll.jaco) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                            ₦{{ "{:,.2f}".format(payroll.minna_paye) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                            ₦{{ "{:,.2f}".format(payroll.late_deduction) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-green-600">
                            ₦{{ "{:,.2f}".format(payroll.balance_salary) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">
                            {{ payroll.days_worked }}/{{ payroll.work_days }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button class="edit-payroll-btn text-blue-600 hover:text-blue-900"
                                    data-id="{{ payroll.id }}"
                                    data-name="{{ payroll.employee_name }}"
                                    data-gross="{{ payroll.gross }}"
                                    data-loan="{{ payroll.loan_or_salary_advance }}"
                                    data-jaco="{{ payroll.jaco }}"
                                    data-paye="{{ payroll.minna_paye }}"
                                    data-late="{{ payroll.late_deduction }}"
                                    data-work-days="{{ payroll.work_days }}"
                                    data-days-worked="{{ payroll.days_worked }}">
                                <i class="bx bx-edit text-lg"></i>
                            </button>
                            <a href="{{ url_for('generate_payslip', employee_id=payroll.employee_id) }}" 
                               class="text-green-600 hover:text-green-900 ml-3">
                                <i class="bx bx-printer text-lg"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Payroll Modal -->
<div id="editPayrollModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Edit Payroll</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                <i class="bx bx-x text-2xl"></i>
            </button>
        </div>

        <form id="editPayrollForm" method="POST" action="{{ url_for('hr.update_draft_payroll') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <input type="hidden" name="payroll_id" id="editPayrollId" />
            
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-900 mb-2">Employee</h4>
                    <p id="editEmployeeName" class="text-blue-800"></p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gross Salary (₦)</label>
                        <input type="number" name="gross" id="editGross" required step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Loan/Salary Advance (₦)</label>
                        <input type="number" name="loan_or_salary_advance" id="editLoan" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pension - JACO (₦)</label>
                        <input type="number" name="jaco" id="editJaco" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PAYE Tax (₦)</label>
                        <input type="number" name="minna_paye" id="editPaye" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Late Deduction (₦)</label>
                        <input type="number" name="late_deduction" id="editLateDeduction" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Days Worked</label>
                        <div class="flex space-x-2">
                            <input type="number" name="days_worked" id="editDaysWorked" min="0" max="31"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="self-center text-gray-500">/</span>
                            <input type="number" name="work_days" id="editWorkDays" min="1" max="31"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-medium text-green-900 mb-2">Net Salary Preview</h4>
                    <p id="netSalaryPreview" class="text-lg font-bold text-green-800">₦0.00</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 p-6 border-t">
                <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Update Payroll
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function editPayroll(id, name, gross, loan, jaco, paye, late, workDays, daysWorked) {
    document.getElementById('editPayrollId').value = id;
    document.getElementById('editEmployeeName').textContent = name;
    document.getElementById('editGross').value = gross;
    document.getElementById('editLoan').value = loan;
    document.getElementById('editJaco').value = jaco;
    document.getElementById('editPaye').value = paye;
    document.getElementById('editLateDeduction').value = late;
    document.getElementById('editWorkDays').value = workDays;
    document.getElementById('editDaysWorked').value = daysWorked;
    
    updateNetSalaryPreview();
    document.getElementById('editPayrollModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editPayrollModal').classList.add('hidden');
}

function updateNetSalaryPreview() {
    const gross = parseFloat(document.getElementById('editGross').value) || 0;
    const loan = parseFloat(document.getElementById('editLoan').value) || 0;
    const jaco = parseFloat(document.getElementById('editJaco').value) || 0;
    const paye = parseFloat(document.getElementById('editPaye').value) || 0;
    const late = parseFloat(document.getElementById('editLateDeduction').value) || 0;
    
    const netSalary = gross - loan - jaco - paye - late;
    document.getElementById('netSalaryPreview').textContent = `₦${netSalary.toLocaleString('en-NG', { minimumFractionDigits: 2 })}`;
}

function submitForApproval() {
    if (confirm('Are you sure you want to submit this payroll for admin approval? You will not be able to edit it afterwards.')) {
        // Create a form and submit to the submit approval endpoint
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("submit_payroll_for_approval") }}';
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = '{{ csrf_token }}';
        form.appendChild(csrfToken);
        
        const currentDate = new Date();
        
        const yearInput = document.createElement('input');
        yearInput.type = 'hidden';
        yearInput.name = 'period_year';
        yearInput.value = currentDate.getFullYear();
        form.appendChild(yearInput);
        
        const monthInput = document.createElement('input');
        monthInput.type = 'hidden';
        monthInput.name = 'period_month';
        monthInput.value = currentDate.getMonth() + 1;
        form.appendChild(monthInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Add event listeners for real-time net salary calculation
document.addEventListener('DOMContentLoaded', function() {
    const inputs = ['editGross', 'editLoan', 'editJaco', 'editPaye', 'editLateDeduction'];
    inputs.forEach(function(inputId) {
        document.getElementById(inputId).addEventListener('input', updateNetSalaryPreview);
    });
    
    // Add event listeners for edit buttons
    document.querySelectorAll('.edit-payroll-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            const gross = this.dataset.gross;
            const loan = this.dataset.loan;
            const jaco = this.dataset.jaco;
            const paye = this.dataset.paye;
            const late = this.dataset.late;
            const workDays = this.dataset.workDays;
            const daysWorked = this.dataset.daysWorked;
            editPayroll(id, name, gross, loan, jaco, paye, late, workDays, daysWorked);
        });
    });
});

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('editPayrollModal');
    if (event.target === modal) {
        closeEditModal();
    }
});
</script>
{% endblock %}