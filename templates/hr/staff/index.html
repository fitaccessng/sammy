{% extends "hr/base.html" %}

{% block title %}Staff Management | SammyA HR{% endblock %}

{% block content %}
<style>
  .modern-card { background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  .status-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
  .badge-active { background: #ecfdf5; color: #065f46; }
  .badge-inactive { background: #fef2f2; color: #991b1b; }
  .badge-on-leave { background: #fffbeb; color: #92400e; }
</style>

<div class="mb-6 flex items-start justify-between gap-4 flex-col sm:flex-row">
  <div>
    <h2 class="text-2xl font-bold text-gray-800">Staff Management</h2>
    <p class="text-gray-600">Manage employees, departments, and roles</p>
  </div>
  <div class="flex items-center gap-2 w-full sm:w-auto">
    <button type="button" onclick="openModal('modal-import')" class="px-3 py-2 rounded border bg-white hover:bg-gray-50 text-gray-700">Import</button>
    <a href="{{ url_for('hr.export_staff') }}" class="px-3 py-2 rounded border bg-white hover:bg-gray-50 text-gray-700">Export</a>
    <button type="button" onclick="openModal('modal-departments')" class="px-3 py-2 rounded border bg-white hover:bg-gray-50 text-gray-700">Departments</button>
    <button type="button" onclick="openModal('modal-add-staff')" class="px-4 py-2 rounded bg-blue-600 text-white font-medium">Add Staff</button>
  </div>
  </div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="modern-card p-4 border-l-4 mb-4 {% if category=='error' %}border-red-500 bg-red-50 text-red-800{% else %}border-green-500 bg-green-50 text-green-800{% endif %}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <div class="modern-card p-4">
    <p class="text-gray-500 text-xs uppercase">Total Staff</p>
    <p class="text-3xl font-bold text-gray-800">{{ stats.total_staff }}</p>
  </div>
  <div class="modern-card p-4">
    <p class="text-gray-500 text-xs uppercase">Active</p>
    <p class="text-3xl font-bold text-gray-800">{{ stats.active }}</p>
  </div>
  <div class="modern-card p-4">
    <p class="text-gray-500 text-xs uppercase">Departments</p>
    <p class="text-3xl font-bold text-gray-800">{{ stats.departments }}</p>
  </div>
  <div class="modern-card p-4">
    <p class="text-gray-500 text-xs uppercase">New This Month</p>
    <p class="text-3xl font-bold text-gray-800">{{ stats.new_staff }}</p>
  </div>
</div>

<div class="modern-card">
  <div class="px-4 md:px-6 py-4 border-b flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2"><i class='bx bxs-user-detail text-blue-600'></i> Staff Directory</h3>
    <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
      <select id="statusFilter" class="px-3 py-2 border rounded text-sm">
        <option value="">All Status</option>
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
        <option value="On Leave">On Leave</option>
      </select>
      <input id="searchStaff" type="search" placeholder="Search by name or department" class="px-3 py-2 border rounded text-sm w-full sm:w-64" />
    </div>
  </div>

  <div class="p-4 md:p-6">
    {% if staff_list %}
    <div class="hidden md:block overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for staff in staff_list %}
          <tr class="staff-row" data-name="{{ staff.name|default('')|lower }}" data-status="{{ staff.status|default('active')|lower }}" data-department="{{ staff.department|default('')|lower }}">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <img class="h-10 w-10 rounded-full" src="{{ staff.avatar_url }}" alt="{{ staff.name|default('Staff') }}" />
                <div class="ml-3">
                  <div class="text-sm font-medium text-gray-900">{{ staff.name|default('N/A') }}</div>
                  <div class="text-xs text-gray-500">{{ staff.email|default('—') }}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ staff.staff_code or '—' }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ staff.department|default('Unassigned') }}</div>
              <div class="text-xs text-gray-500">{{ staff.position|default('Not set') }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ staff.role|default('Not assigned') }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% set status = staff.status|default('Active')|lower|replace(' ', '-') %}
              <span class="status-badge badge-{{ status }}">{{ staff.status|default('Active') }}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <div class="flex items-center gap-3">
                <a href="{{ url_for('hr.staff_details', staff_id=staff.id) }}" class="text-blue-600 hover:underline">View</a>
                <form method="post" action="{{ url_for('hr.assign_role', staff_id=staff.id) }}" class="inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <input type="hidden" name="role_id" value="">
                  <button type="submit" class="text-indigo-600 hover:underline">Assign Role</button>
                </form>
                <!-- <form method="post" action="{{ url_for('hr.delete_staff', staff_id=staff.id) }}" class="inline" onsubmit="return confirm('Delete this staff member?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                  <button type="submit" class="text-red-600 hover:underline">Delete</button>
                </form> -->
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile cards -->
    <div class="grid grid-cols-1 gap-3 md:hidden">
      {% for staff in staff_list %}
      <div class="modern-card p-4 staff-row" data-name="{{ staff.name|default('')|lower }}" data-status="{{ staff.status|default('active')|lower }}" data-department="{{ staff.department|default('')|lower }}">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <img class="h-10 w-10 rounded-full" src="{{ staff.avatar_url }}" alt="{{ staff.name|default('Staff') }}" />
            <div class="ml-3">
              <p class="font-medium text-gray-900">{{ staff.name|default('N/A') }}</p>
              <p class="text-xs text-gray-500">{{ staff.email|default('—') }}</p>
              <p class="text-xs text-gray-700">ID: {{ staff.staff_code or '—' }}</p>
            </div>
          </div>
          {% set status = staff.status|default('Active')|lower|replace(' ', '-') %}
          <span class="status-badge badge-{{ status }}">{{ staff.status|default('Active') }}</span>
        </div>
        <div class="mt-3 text-sm text-gray-600">
          <p>{{ staff.department|default('Unassigned') }} • {{ staff.position|default('Not set') }}</p>
        </div>
        <div class="mt-4 flex items-center gap-4 text-sm">
          <a href="{{ url_for('hr.staff_details', staff_id=staff.id) }}" class="text-blue-600">View</a>
          <form method="post" action="{{ url_for('hr.delete_staff', staff_id=staff.id) }}" onsubmit="return confirm('Delete this staff member?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="text-red-600">Delete</button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="text-center py-12">
        {% if error %}
          <i class='bx bx-error-circle text-6xl text-red-300 mb-4'></i>
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Error Loading Staff</h3>
          <p class="text-gray-500 mb-6">Please refresh the page or try again later.</p>
          <a href="{{ url_for('hr.staff_list') }}" class="px-4 py-2 rounded bg-blue-600 text-white">Refresh</a>
        {% else %}
          <i class='bx bx-user text-6xl text-gray-300 mb-4'></i>
          <h3 class="text-lg font-semibold text-gray-800 mb-2">No staff found</h3>
          <p class="text-gray-500 mb-6">Start by adding your first staff member.</p>
          <button type="button" onclick="openModal('modal-add-staff')" class="px-4 py-2 rounded bg-blue-600 text-white">Add Staff</button>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal Overlays -->
<div id="modal-import" class="fixed inset-0 bg-black/50 z-40 items-center justify-center p-4 hidden">
  <div class="relative max-h-[90vh] overflow-auto" role="dialog" aria-modal="true" aria-labelledby="modal-import-title">
    <button class="absolute -top-3 -right-3 bg-white rounded-full shadow p-2" aria-label="Close" data-modal-close>
      <i class='bx bx-x text-xl'></i>
    </button>
    {% include 'hr/staff/import_modal.html' %}
  </div>
  <span class="sr-only" id="modal-import-title">Import Staff</span>
  <span class="sr-only" data-modal-sentinel></span>
  <span class="sr-only" data-modal-sentinel></span>
  </div>

<div id="modal-departments" class="fixed inset-0 bg-black/50 z-40 items-center justify-center p-4 hidden">
  <div class="relative max-h-[90vh] overflow-auto" role="dialog" aria-modal="true" aria-labelledby="modal-departments-title">
    <button class="absolute -top-3 -right-3 bg-white rounded-full shadow p-2" aria-label="Close" data-modal-close>
      <i class='bx bx-x text-xl'></i>
    </button>
    {% include 'hr/staff/departments_modal.html' %}
  </div>
  <span class="sr-only" id="modal-departments-title">Manage Departments</span>
  <span class="sr-only" data-modal-sentinel></span>
  <span class="sr-only" data-modal-sentinel></span>
</div>

<div id="modal-add-staff" class="fixed inset-0 bg-black/50 z-40 items-center justify-center p-4 hidden">
  <div class="relative max-h-[90vh] overflow-auto" role="dialog" aria-modal="true" aria-labelledby="modal-add-staff-title">
    <button class="absolute -top-3 -right-3 bg-white rounded-full shadow p-2" aria-label="Close" data-modal-close>
      <i class='bx bx-x text-xl'></i>
    </button>
    {% include 'hr/staff/add_modal.html' %}
  </div>
  <span class="sr-only" id="modal-add-staff-title">Add Staff</span>
  <span class="sr-only" data-modal-sentinel></span>
  <span class="sr-only" data-modal-sentinel></span>
</div>

<script>
  // Modal controls
  function openModal(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove('hidden');
    el.classList.add('flex');
    // focus first focusable
    const focusable = el.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    focusable && focusable.focus();
    document.addEventListener('keydown', escListener);
  }
  function closeModal(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.add('hidden');
    el.classList.remove('flex');
    document.removeEventListener('keydown', escListener);
  }
  function escListener(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('[id^="modal-"]').forEach(m => {
        if (!m.classList.contains('hidden')) m.classList.add('hidden');
      });
    }
  }
  // Close on backdrop click or data attribute
  document.addEventListener('click', (e) => {
    if (e.target.matches('[data-modal-close]')) {
      const overlay = e.target.closest('[id^="modal-"]');
      if (overlay) closeModal(overlay.id);
      return;
    }
    const overlay = e.target.closest('[id^="modal-"]');
    if (overlay && e.target === overlay) {
      closeModal(overlay.id);
    }
  });
  const searchEl = document.getElementById('searchStaff');
  const statusEl = document.getElementById('statusFilter');
  function filterStaff() {
    const q = (searchEl?.value || '').toLowerCase();
    const status = (statusEl?.value || '').toLowerCase();
    document.querySelectorAll('.staff-row').forEach(row => {
      const name = row.dataset.name || '';
      const dep = row.dataset.department || '';
      const st = row.dataset.status || '';
      const visible = (name.includes(q) || dep.includes(q)) && (!status || st === status);
      row.style.display = visible ? '' : 'none';
    });
  }
  searchEl?.addEventListener('input', filterStaff);
  statusEl?.addEventListener('change', filterStaff);
</script>
{% endblock %}
