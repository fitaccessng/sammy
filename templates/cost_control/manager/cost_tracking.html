{% extends "cost_control/base.html" %}

{% block title %}Cost Tracking{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Cost Tracking</h1>
        <p class="text-gray-600">Track and manage project costs with real-time budget monitoring</p>
    </div>

    {% if budget_summary and selected_project_id %}
    <!-- Budget Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        {% for category, data in budget_summary.items() %}
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">{{ category|title }}</h3>
            <div class="mb-2">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Spent: ₦{{ "{:,.0f}".format(data.spent) }}</span>
                    <span>Budget: ₦{{ "{:,.0f}".format(data.allocated) }}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="{% if data.usage_percentage > 90 %}bg-red-600{% elif data.usage_percentage > 75 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-2 rounded-full" 
                         style="width: {{ data.usage_percentage }}%"></div>
                </div>
            </div>
            <p class="text-xs text-gray-600">
                Remaining: ₦{{ "{:,.0f}".format(data.remaining) }} 
                <span class="font-semibold">({{ "%.1f"|format(100 - data.usage_percentage) }}%)</span>
            </p>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Add Cost Entry Form -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">Add Cost Entry</h2>
        </div>
        <div class="p-6">
            <form method="POST" id="costEntryForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Project *</label>
                    <select name="project_id" id="projectSelect" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Project</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" {% if selected_project_id == project.id %}selected{% endif %}>
                            {{ project.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                    <select name="category_id" id="categorySelect" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Project First</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cost Type *</label>
                    <select name="cost_type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="material">Material</option>
                        <option value="labor">Labor</option>
                        <option value="equipment">Equipment</option>
                        <option value="subcontractor">Subcontractor</option>
                        <option value="overhead">Overhead</option>
                        <option value="transportation">Transportation</option>
                        <option value="professional_services">Professional Services</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Entry Date *</label>
                    <input type="date" name="entry_date" required value="{{ today }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                    <input type="text" name="description" required placeholder="e.g., Steel reinforcement bars for foundation"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Planned Cost (₦) *</label>
                    <input type="number" name="planned_cost" step="0.01" required id="plannedCost"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Actual Cost (₦) *</label>
                    <input type="number" name="actual_cost" step="0.01" required id="actualCost"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                    <input type="number" name="quantity" step="0.01" placeholder="Optional"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                    <input type="text" name="unit" placeholder="e.g., kg, m³, hrs, pcs"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Variance Preview -->
                <div class="md:col-span-2 p-4 bg-gray-50 rounded-lg" id="variancePreview" style="display: none;">
                    <p class="text-sm text-gray-600">
                        <strong>Variance:</strong> 
                        <span id="varianceAmount" class="font-semibold"></span>
                        <span id="variancePercent" class="font-semibold"></span>
                    </p>
                    <p class="text-xs text-yellow-600 mt-1" id="approvalWarning" style="display: none;">
                        ⚠️ This entry will require approval due to high variance (>10%)
                    </p>
                </div>
                
                <div class="md:col-span-2">
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add Cost Entry
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-lg shadow mb-6 p-6">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                <select name="project_id" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if selected_project_id == project.id %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Cost Type</label>
                <select name="cost_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">All Types</option>
                    <option value="material">Material</option>
                    <option value="labor">Labor</option>
                    <option value="equipment">Equipment</option>
                    <option value="subcontractor">Subcontractor</option>
                    <option value="overhead">Overhead</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                <input type="date" name="date_from" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                <input type="date" name="date_to" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="md:col-span-4">
                <button type="submit" class="px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">
                    <i class="fas fa-filter mr-2"></i>Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Cost Entries Table -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">Cost Entries</h2>
        </div>
        <div class="overflow-x-auto">
            {% if entries %}
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Planned</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actual</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Variance</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for entry in entries %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ entry.entry_date.strftime('%Y-%m-%d') }}</td>
                        <td class="px-6 py-4 text-sm">{{ entry.description }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 bg-gray-100 rounded text-xs">{{ entry.cost_type }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">₦{{ "{:,.2f}".format(entry.planned_cost) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">₦{{ "{:,.2f}".format(entry.actual_cost) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                            <span class="{% if entry.variance < 0 %}text-green-600{% else %}text-red-600{% endif %} font-semibold">
                                {{ "%.1f"|format(entry.variance_percentage) }}%
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            {% if entry.status == 'approved' %}
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Approved</span>
                            {% elif entry.status == 'pending' %}
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Pending</span>
                            {% elif entry.status == 'rejected' %}
                            <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Rejected</span>
                            {% else %}
                            <span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">{{ entry.status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>No cost entries found. Add your first entry above.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Dynamic category loading based on project selection
document.getElementById('projectSelect').addEventListener('change', function() {
    const projectId = this.value;
    const categorySelect = document.getElementById('categorySelect');
    
    if (!projectId) {
        categorySelect.innerHTML = '<option value="">Select Project First</option>';
        return;
    }
    
    // Show loading
    categorySelect.innerHTML = '<option value="">Loading categories...</option>';
    
    // Fetch categories for selected project
    fetch(`/cost-control/manager/api/categories/${projectId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option);
                });
            } else {
                categorySelect.innerHTML = '<option value="">Error loading categories</option>';
            }
        })
        .catch(error => {
            console.error('Error fetching categories:', error);
            categorySelect.innerHTML = '<option value="">Error loading categories</option>';
        });
});

// Real-time variance calculation
const plannedCostInput = document.getElementById('plannedCost');
const actualCostInput = document.getElementById('actualCost');
const variancePreview = document.getElementById('variancePreview');
const varianceAmount = document.getElementById('varianceAmount');
const variancePercent = document.getElementById('variancePercent');
const approvalWarning = document.getElementById('approvalWarning');

function calculateVariance() {
    const planned = parseFloat(plannedCostInput.value) || 0;
    const actual = parseFloat(actualCostInput.value) || 0;
    
    if (planned > 0 && actual > 0) {
        const variance = actual - planned;
        const variancePercentage = (variance / planned) * 100;
        
        variancePreview.style.display = 'block';
        varianceAmount.textContent = `₦${variance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
        variancePercent.textContent = `(${variancePercentage.toFixed(1)}%)`;
        
        // Color code the variance
        if (variance < 0) {
            varianceAmount.className = 'font-semibold text-green-600';
            variancePercent.className = 'font-semibold text-green-600';
        } else {
            varianceAmount.className = 'font-semibold text-red-600';
            variancePercent.className = 'font-semibold text-red-600';
        }
        
        // Show approval warning if variance > 10%
        if (Math.abs(variancePercentage) > 10) {
            approvalWarning.style.display = 'block';
        } else {
            approvalWarning.style.display = 'none';
        }
    } else {
        variancePreview.style.display = 'none';
    }
}

plannedCostInput.addEventListener('input', calculateVariance);
actualCostInput.addEventListener('input', calculateVariance);

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('input[name="entry_date"]');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Trigger category load if project is pre-selected
    const projectSelect = document.getElementById('projectSelect');
    if (projectSelect.value) {
        projectSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
