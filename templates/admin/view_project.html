{% extends "admin/base_simple.html" %}

{% block title %}{{ project.name }} - Project Management{% endblock %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token }}">
<!-- Project data for JS (JSON) -->
<script id="project-data" type="application/json">{{ {'id': project.id, 'progress': project.progress or 0, 'csrf': csrf_token}|tojson }}</script>
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<style>
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .slide-down { animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    /* Flash Modal Animations */
    #flashMessageModal {
        transition: opacity 0.3s ease-in-out;
    }
    
    #flashMessageModal > div > div {
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s ease-out;
    }
    
    .flash-modal-enter {
        transform: scale(1) !important;
        opacity: 1 !important;
    }
    
    @keyframes modalBounce {
        0% { transform: scale(0.8) translateY(-20px); opacity: 0; }
        50% { transform: scale(1.05) translateY(-10px); opacity: 0.8; }
        100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    .modal-bounce {
        animation: modalBounce 0.4s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Project Data for JavaScript -->
    <script type="application/json" id="project-data">
        {
            "id": {{ project.id }},
            "name": "{{ project.name|e }}",
            "project_type": "{{ project.project_type or '' }}",
            "status": "{{ project.status or '' }}",
            "progress": {{ project.progress or 0 }}
        }
    </script>

    <!-- Flash Messages as Modals -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              showFlashModal('{{ category }}', '{{ message|e }}');
            });
          </script>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Enhanced Project Header -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-3">
                        <h2 class="text-3xl font-bold text-gray-900">{{ project.name }}</h2>
                        <button onclick="editProjectInfo()" class="text-gray-400 hover:text-indigo-600 transition-colors">
                            <i class='bx bx-edit text-xl'></i>
                        </button>
                    </div>
                    
                    <!-- Enhanced Project Meta Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-500">Project Type</p>
                            <p class="font-medium text-gray-900">{{ project.project_type or 'Not specified' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Priority</p>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                {% if project.priority == 'Critical' %}bg-red-100 text-red-800
                                {% elif project.priority == 'High' %}bg-orange-100 text-orange-800
                                {% elif project.priority == 'Medium' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ project.priority or 'Medium' }}
                            </span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Client</p>
                            <p class="font-medium text-gray-900">{{ project.client_name or 'Not specified' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Risk Level</p>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                {% if project.risk_level == 'Critical' %}bg-red-100 text-red-800
                                {% elif project.risk_level == 'High' %}bg-orange-100 text-orange-800
                                {% elif project.risk_level == 'Medium' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ project.risk_level or 'Low' }}
                            </span>
                        </div>
                    </div>

                    <!-- Project Details Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-500">Site Location</p>
                            <p class="font-medium text-gray-900">{{ project.site_location or 'Not specified' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Funding Source</p>
                            <p class="font-medium text-gray-900">{{ project.funding_source or 'Not specified' }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Safety Requirements</p>
                            <p class="font-medium text-gray-900">{{ project.safety_requirements or 'Standard' }}</p>
                        </div>
                    </div>

                    <div class="flex items-center text-sm text-gray-500 space-x-4">
                        <span>Created {{ project.created_at.strftime('%B %d, %Y') if project.created_at else 'Unknown' }}</span>
                        {% if project.project_manager %}
                        <span>• Managed by {{ project.project_manager }}</span>
                        {% endif %}
                        <span>• Last updated {{ project.updated_at.strftime('%B %d, %Y') if project.updated_at else 'Recently' }}</span>
                    </div>
                    
                    {% if project.description %}
                    <div class="mt-3 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-2">Project Description</h4>
                        <p class="text-gray-700">{{ project.description }}</p>
                    </div>
                    {% endif %}

                    {% if project.regulatory_requirements %}
                    <div class="mt-3 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">
                            <i class='bx bx-shield-check mr-1'></i>
                            Regulatory Requirements
                        </h4>
                        <p class="text-blue-800">{{ project.regulatory_requirements }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex flex-col space-y-2">
                    <button onclick="editProject()" 
                       class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        <i class='bx bx-edit mr-1'></i>
                        Edit Project
                    </button>
                    <button onclick="updateProgress()" 
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i class='bx bx-trending-up mr-1'></i>
                        Update Progress
                    </button>
                    <button onclick="showActivityLog()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <i class='bx bx-history mr-1'></i>
                        Activity Log
                    </button>
                </div>
            </div>

            <!-- Enhanced Status and Health Badges -->
            <div class="mt-6 flex flex-wrap gap-3">
                <span class="px-3 py-1 text-sm font-semibold rounded-full 
                      {% if project.status == 'Active' %}bg-green-100 text-green-800
                      {% elif project.status == 'Planning' %}bg-yellow-100 text-yellow-800
                      {% elif project.status == 'Completed' %}bg-blue-100 text-blue-800
                      {% elif project.status == 'On Hold' %}bg-orange-100 text-orange-800
                      {% elif project.status == 'Cancelled' %}bg-red-100 text-red-800
                      {% else %}bg-gray-100 text-gray-800{% endif %}">
                    <i class='bx bx-pulse mr-1'></i>
                    {{ project.status }}
                </span>
                
                <span class="px-3 py-1 text-sm font-semibold rounded-full 
                      {% if health_status == 'Good' %}bg-green-100 text-green-800
                      {% elif health_status == 'Warning' %}bg-orange-100 text-orange-800
                      {% elif health_status == 'Critical' %}bg-red-100 text-red-800
                      {% else %}bg-gray-100 text-gray-800{% endif %}">
                    <i class='bx bx-heart mr-1'></i>
                    Health: {{ health_status or 'Unknown' }}
                </span>
                
                {% if is_overdue %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800 pulse">
                    <i class='bx bx-alarm mr-1'></i>
                    Overdue by {{ days_remaining or 0 }} days
                </span>
                {% elif days_remaining is not none %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">
                    <i class='bx bx-calendar mr-1'></i>
                    {{ days_remaining }} days remaining
                </span>
                {% endif %}

                {% if budget_utilization and budget_utilization > 90 %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800">
                    <i class='bx bx-error mr-1'></i>
                    Budget Alert
                </span>
                {% elif budget_utilization and budget_utilization > 75 %}
                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-orange-100 text-orange-800">
                    <i class='bx bx-error-alt mr-1'></i>
                    Budget Warning
                </span>
                {% endif %}
            </div>

            <!-- Enhanced Progress Bar with Interactive Update -->
            <div class="mt-6">
                <div class="flex justify-between items-center text-sm mb-2">
                    <span class="text-gray-600 font-medium">Overall Progress</span>
                    <div class="flex items-center space-x-2">
                        <span class="font-bold text-lg" data-progress-text>{{ progress }}%</span>
                        <button onclick="updateProgress()" class="text-indigo-600 hover:text-indigo-800">
                            <i class='bx bx-refresh text-sm'></i>
                        </button>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-4 rounded-full transition-all duration-500 
                         {% if progress < 25 %}from-red-500 to-red-600
                         {% elif progress < 50 %}from-orange-500 to-yellow-500
                         {% elif progress < 75 %}from-yellow-500 to-green-500
                         {% else %}from-green-500 to-blue-500{% endif %}" 
                         data-progress-bar
                         style="width: {{ progress }}%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0%</span>
                    <span>25%</span>
                    <span>50%</span>
                    <span>75%</span>
                    <span>100%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Project Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Milestones Metric -->
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Milestones</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" data-metric="milestones">{{ completed_milestones }}/{{ milestone_count }}</h3>
                    <div class="flex items-center mt-2">
                        {% if milestone_count > 0 %}
                        <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (completed_milestones / milestone_count * 100) if milestone_count > 0 else 0 }}%"></div>
                        </div>
                        <span class="text-xs text-gray-600">{{ (completed_milestones / milestone_count * 100)|round(1) if milestone_count > 0 else 0 }}%</span>
                        {% endif %}
                    </div>
                </div>
                <div class="bg-blue-100 p-4 rounded-full">
                    <i class='bx bx-flag text-3xl text-blue-600'></i>
                </div>
            </div>
            {% if overdue_milestones > 0 %}
            <div class="mt-3 p-2 bg-red-50 rounded-md">
                <p class="text-xs text-red-600 font-medium">
                    <i class='bx bx-error-circle mr-1'></i>
                    {{ overdue_milestones }} overdue milestone{{ 's' if overdue_milestones != 1 else '' }}
                </p>
            </div>
            {% endif %}
            <button onclick="openMilestoneModal()" class="mt-3 w-full text-sm text-blue-600 hover:text-blue-800 font-medium">
                <i class='bx bx-plus mr-1'></i>
                Add Milestone
            </button>
        </div>

        <!-- Tasks Metric -->
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Tasks</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" data-metric="tasks">{{ completed_tasks }}/{{ task_count }}</h3>
                    <div class="flex items-center mt-2">
                        {% if task_count > 0 %}
                        <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: {{ (completed_tasks / task_count * 100) if task_count > 0 else 0 }}%"></div>
                        </div>
                        <span class="text-xs text-gray-600">{{ (completed_tasks / task_count * 100)|round(1) if task_count > 0 else 0 }}%</span>
                        {% endif %}
                    </div>
                </div>
                <div class="bg-green-100 p-4 rounded-full">
                    <i class='bx bx-task text-3xl text-green-600'></i>
                </div>
            </div>
            <button onclick="openTaskModal()" class="mt-3 w-full text-sm text-green-600 hover:text-green-800 font-medium">
                <i class='bx bx-plus mr-1'></i>
                Add Task
            </button>
        </div>

        <!-- Team Members Metric -->
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Team Members</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1">{{ team_size }}</h3>
                    <div class="mt-2">
                        {% if team_roles %}
                        <div class="flex flex-wrap gap-1">
                            {% for role, count in team_roles.items() %}
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">{{ count }} {{ role.split()[0] }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="bg-purple-100 p-4 rounded-full">
                    <i class='bx bx-group text-3xl text-purple-600'></i>
                </div>
            </div>
            <button onclick="openStaffModal()" class="mt-3 w-full text-sm text-purple-600 hover:text-purple-800 font-medium">
                <i class='bx bx-plus mr-1'></i>
                Assign Staff
            </button>
        </div>

        <!-- Budget Metric -->
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Budget Used</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1">{{ budget_utilization or 0 }}%</h3>
                    <div class="flex items-center mt-2">
                        <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="h-2 rounded-full {% if budget_utilization and budget_utilization > 90 %}bg-red-600{% elif budget_utilization and budget_utilization > 75 %}bg-orange-500{% else %}bg-yellow-500{% endif %}" 
                                 style="width: {{ budget_utilization or 0 }}%"></div>
                        </div>
                        <span class="text-xs {% if budget_utilization and budget_utilization > 90 %}text-red-600{% elif budget_utilization and budget_utilization > 75 %}text-orange-600{% else %}text-gray-600{% endif %}">
                            ₦{{ "{:,.0f}".format(spent_amount) if spent_amount else '0' }} spent
                        </span>
                    </div>
                </div>
                <div class="bg-yellow-100 p-4 rounded-full">
                    <i class='bx bx-wallet text-3xl text-yellow-600'></i>
                </div>
            </div>
            {% if budget_utilization and budget_utilization > 90 %}
            <div class="mt-3 p-2 bg-red-50 rounded-md">
                <p class="text-xs text-red-600 font-medium">
                    <i class='bx bx-error-circle mr-1'></i>
                    Budget nearly exhausted
                </p>
            </div>
            {% elif budget_utilization and budget_utilization > 75 %}
            <div class="mt-3 p-2 bg-orange-50 rounded-md">
                <p class="text-xs text-orange-600 font-medium">
                    <i class='bx bx-error-alt mr-1'></i>
                    High budget utilization
                </p>
            </div>
            {% endif %}
            <button onclick="openBudgetModal()" class="mt-3 w-full text-sm text-yellow-600 hover:text-yellow-800 font-medium">
                <i class='bx bx-plus mr-1'></i>
                Add Expense
            </button>
        </div>
    </div>

    <!-- Enhanced Project Details Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Enhanced Staff Management -->
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class='bx bx-group text-purple-600 mr-2'></i>
                        Team Management
                    </h3>
                    {% if available_staff %}
                    <button onclick="openStaffModal()" 
                            class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                        <i class='bx bx-plus mr-1'></i>
                        Assign Staff
                    </button>
                    {% endif %}
                </div>

                <div class="space-y-4" id="staff-list">
                    {% if staff_assignments %}
                        {% for assignment_data in staff_assignments %}
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors" 
                             data-staff-id="{{ assignment_data.id }}">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                    <span class="text-purple-600 font-semibold text-sm">{{ assignment_data.staff_name[:2].upper() }}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">
                                        {{ assignment_data.staff_name }}
                                        {% if assignment_data.type == 'employee' %}
                                            <span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">HR Employee</span>
                                        {% else %}
                                            <span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">System User</span>
                                        {% endif %}
                                    </p>
                                    <p class="text-sm text-purple-600 font-medium">{{ assignment_data.role }}</p>
                                    <p class="text-xs text-gray-500">
                                        <i class='bx bx-calendar mr-1'></i>
                                        Assigned {{ assignment_data.assigned_at.strftime('%b %d, %Y') if assignment_data.assigned_at else 'Recently' }}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="editStaffRole('{{ assignment_data.id }}', '{{ assignment_data.role }}')" 
                                        class="text-indigo-600 hover:text-indigo-800 p-1 rounded">
                                    <i class='bx bx-edit text-sm'></i>
                                </button>
                                <button onclick="removeStaff('{{ assignment_data.id }}', '{{ assignment_data.staff_name }}')" 
                                        class="text-red-600 hover:text-red-800 p-1 rounded">
                                    <i class='bx bx-trash text-sm'></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Team Composition Summary -->
                        {% if team_roles %}
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <i class='bx bx-pie-chart-alt-2 mr-1'></i>
                                Team Composition
                            </h4>
                            <div class="grid grid-cols-2 gap-2">
                                {% for role, count in team_roles.items() %}
                                <div class="flex justify-between items-center text-sm p-2 bg-white rounded border">
                                    <span class="text-gray-600">{{ role }}</span>
                                    <span class="font-semibold text-purple-600">{{ count }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-8">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class='bx bx-group text-2xl text-gray-400'></i>
                            </div>
                            <p class="text-gray-500 text-sm mb-4">No staff assigned yet</p>
                            <button onclick="openStaffModal()" 
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                <i class='bx bx-plus mr-1'></i>
                                Assign First Staff Member
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Enhanced Milestone Management -->
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class='bx bx-flag text-blue-600 mr-2'></i>
                        All Milestones
                        {% if milestones %}
                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">{{ milestones|length }}</span>
                        {% endif %}
                    </h3>
                    <button onclick="openMilestoneModal()" 
                            class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <i class='bx bx-plus mr-1'></i>
                        Add Milestone
                    </button>
                </div>

                <div class="space-y-4 max-h-96 overflow-y-auto" id="milestone-list">
                    {% if milestones %}
                        {% for milestone in milestones|sort(attribute='due_date') %}
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                             data-milestone-id="{{ milestone.id }}">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center
                                    {% if milestone.status == 'Completed' %}bg-green-100
                                    {% elif milestone.status == 'In Progress' %}bg-blue-100
                                    {% elif milestone.status == 'Pending' %}bg-yellow-100
                                    {% else %}bg-gray-100{% endif %}">
                                    <i class='bx 
                                        {% if milestone.status == 'Completed' %}bx-check text-green-600
                                        {% elif milestone.status == 'In Progress' %}bx-loader-alt text-blue-600
                                        {% elif milestone.status == 'Pending' %}bx-time text-yellow-600
                                        {% else %}bx-flag text-gray-600{% endif %}'></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ milestone.title }}</p>
                                    <p class="text-xs text-gray-500">
                                        <i class='bx bx-calendar mr-1'></i>
                                        Due: {{ milestone.due_date.strftime('%B %d, %Y') if milestone.due_date else 'No due date' }}
                                    </p>
                                    {% if milestone.description %}
                                    <p class="text-xs text-gray-600 mt-1">{{ milestone.description[:60] }}{% if milestone.description|length > 60 %}...{% endif %}</p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full 
                                      {% if milestone.status == 'Completed' %}bg-green-100 text-green-800
                                      {% elif milestone.status == 'In Progress' %}bg-blue-100 text-blue-800
                                      {% elif milestone.status == 'Pending' %}bg-yellow-100 text-yellow-800
                                      {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ milestone.status }}
                                </span>
                                <button onclick="editMilestone({{ milestone.id }})" 
                                        class="text-indigo-600 hover:text-indigo-800 p-1 rounded">
                                    <i class='bx bx-edit text-sm'></i>
                                </button>
                                <button onclick="deleteMilestone({{ milestone.id }})" 
                                        class="text-red-600 hover:text-red-800 p-1 rounded">
                                    <i class='bx bx-trash text-sm'></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class='bx bx-flag text-2xl text-gray-400'></i>
                            </div>
                            <p class="text-gray-500 text-sm mb-4">No milestones created yet</p>
                            <button onclick="openMilestoneModal()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class='bx bx-plus mr-1'></i>
                                Create First Milestone
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Enhanced Project Information & BOQ -->
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class='bx bx-info-circle text-indigo-600 mr-2'></i>
                    Project Details
                </h3>
                
                <!-- Enhanced Project Information Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-500">Start Date</span>
                            <span class="text-sm font-medium {% if project.start_date %}text-gray-900{% else %}text-red-500{% endif %}">
                                {{ project.start_date.strftime('%B %d, %Y') if project.start_date else 'Not set' }}
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-500">End Date</span>
                            <span class="text-sm font-medium {% if is_overdue %}text-red-600{% elif project.end_date %}text-gray-900{% else %}text-red-500{% endif %}">
                                {{ project.end_date.strftime('%B %d, %Y') if project.end_date else 'Not set' }}
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-500">Total Budget</span>
                            <span class="text-sm font-medium text-gray-900">
                                ₦{{ "{:,.0f}".format(total_budget) if total_budget else 'Not set' }}
                            </span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-500">Amount Spent</span>
                            <span class="text-sm font-medium text-gray-900">
                                ₦{{ "{:,.0f}".format(spent_amount) if spent_amount else '0' }}
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-500">Remaining Budget</span>
                            <span class="text-sm font-medium {% if remaining_budget and remaining_budget < 0 %}text-red-600{% else %}text-gray-900{% endif %}">
                                ₦{{ "{:,.0f}".format(remaining_budget) if remaining_budget is not none else '0' }}
                            </span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-500">Budget Health</span>
                            <span class="text-sm font-medium {% if budget_utilization and budget_utilization > 90 %}text-red-600{% elif budget_utilization and budget_utilization > 70 %}text-orange-600{% else %}text-green-600{% endif %}">
                                {{ budget_utilization or 0 }}% utilized
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Bill of Quantities Section -->
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class='bx bx-calculator text-green-600 mr-2'></i>
                            Bill of Quantities (BOQ)
                        </h4>
                        <button onclick="openBOQModal()" 
                                class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class='bx bx-plus mr-1'></i>
                            Add BOQ Item
                        </button>
                    </div>
                    
                    <div class="space-y-3" id="boq-list">
                        {% if boq_items %}
                            {% for item in boq_items %}
                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg"
                                 data-boq-id="{{ item.id }}">
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">{{ item.description }}</p>
                                            <p class="text-xs text-gray-500">{{ item.unit }} • Qty: {{ item.quantity }}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm font-semibold text-green-700">₦{{ "{:,.2f}".format(item.total_cost) if item.total_cost else '0.00' }}</p>
                                            <p class="text-xs text-gray-500">₦{{ "{:,.2f}".format(item.unit_cost) if item.unit_cost else '0.00' }}/{{ item.unit }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <button onclick="editBOQ({{ item.id }})" 
                                            class="text-indigo-600 hover:text-indigo-800 p-1 rounded">
                                        <i class='bx bx-edit text-sm'></i>
                                    </button>
                                    <button onclick="deleteBOQ({{ item.id }})" 
                                            class="text-red-600 hover:text-red-800 p-1 rounded">
                                        <i class='bx bx-trash text-sm'></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <!-- BOQ Summary -->
                            <div class="mt-4 p-4 bg-green-100 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-green-800">Total BOQ Value:</span>
                                    <span class="text-lg font-bold text-green-900">₦{{ "{:,.2f}".format(total_boq_cost) if total_boq_cost else '0.00' }}</span>
                                </div>
                                {% if total_boq_cost and total_budget and total_boq_cost > total_budget %}
                                <p class="text-xs text-red-600 mt-1">
                                    <i class='bx bx-error-circle mr-1'></i>
                                    BOQ exceeds project budget by ₦{{ "{:,.2f}".format(total_boq_cost - total_budget) }}
                                </p>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="text-center py-6">
                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class='bx bx-calculator text-xl text-gray-400'></i>
                                </div>
                                <p class="text-gray-500 text-sm mb-3">No BOQ items created yet</p>
                                <button onclick="openBOQModal()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class='bx bx-plus mr-1'></i>
                                    Add First BOQ Item
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Material Schedule Section -->
    <div class="grid grid-cols-1 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-6">
                <!-- Project Type Selector and Controls -->
                <div class="mb-6 bg-gray-50 rounded-lg p-4">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center space-x-4">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                                <i class='bx bx-package text-purple-600 mr-2'></i>
                                Material Schedule & BOQ
                            </h3>
                            <div class="flex items-center space-x-2">
                                <label for="project-type-selector" class="text-sm font-medium text-gray-700">Project Type:</label>
                                <select id="project-type-selector" 
                                        class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        onchange="handleProjectTypeChange(this.value)"
                                        onfocus="preloadAllCommonTemplates()">
                                    <option value="">Select Project Type</option>
                                    <option value="Bridge" {{ 'selected' if project.project_type == 'Bridge' else '' }}>Bridge</option>
                                    <option value="Building" {{ 'selected' if project.project_type == 'Building' else '' }}>Building</option>
                                    <option value="Road" {{ 'selected' if project.project_type == 'Road' else '' }}>Road</option>
                                    <option value="Culvert" {{ 'selected' if project.project_type == 'Culvert' else '' }}>Culvert</option>
                                    <option value="Road and Bridge" {{ 'selected' if project.project_type == 'Road and Bridge' else '' }}>Road and Bridge</option>
                                    <option value="Road and Culvert" {{ 'selected' if project.project_type == 'Road and Culvert' else '' }}>Road and Culvert</option>
                                    <option value="Bridge Road and Culvert" {{ 'selected' if project.project_type == 'Bridge Road and Culvert' else '' }}>Bridge Road and Culvert</option>
                                    <option value="Construction" {{ 'selected' if project.project_type == 'Construction' else '' }}>Construction</option>
                                    <option value="Infrastructure" {{ 'selected' if project.project_type == 'Infrastructure' else '' }}>Infrastructure</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="loadBOQTemplates()" 
                                    class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                <i class='bx bx-download mr-1'></i>
                                Load BOQ Templates
                            </button>
                            <button onclick="generateMaterialSchedule()" 
                                    class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                <i class='bx bx-refresh mr-1'></i>
                                Generate Schedule
                            </button>
                            <div class="relative">
                                <input type="file" id="boq-import-file" accept=".xlsx,.xls,.csv" class="hidden" onchange="importBOQFile(this)">
                                <button onclick="document.getElementById('boq-import-file').click()" 
                                        class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                                    <i class='bx bx-upload mr-1'></i>
                                    Import BOQ
                                </button>
                            </div>
                            <div class="relative">
                                <input type="file" id="material-import-file" accept=".xlsx,.xls,.csv" class="hidden" onchange="importMaterialFile(this)">
                                <button onclick="document.getElementById('material-import-file').click()" 
                                        class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                                    <i class='bx bx-upload mr-1'></i>
                                    Import Materials
                                </button>
                            </div>
                            <button onclick="exportMaterialSchedule()" 
                                    class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm">
                                <i class='bx bx-download mr-1'></i>
                                Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Template Loading Status -->
                <div id="template-loading-status" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center">
                        <i class='bx bx-loader-alt bx-spin text-blue-600 mr-2'></i>
                        <span class="text-blue-800 text-sm">Loading project templates...</span>
                    </div>
                </div>

                <!-- Tabs for BOQ and Material Schedule -->
                <div class="mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button onclick="switchTab('boq')" 
                                    id="boq-tab"
                                    class="tab-button active border-purple-500 text-purple-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                <i class='bx bx-calculator mr-1'></i>
                                Bill of Quantities (BOQ)
                            </button>
                            <button onclick="switchTab('materials')" 
                                    id="materials-tab"
                                    class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                <i class='bx bx-package mr-1'></i>
                                Material Schedule
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- BOQ Tab Content -->
                <div id="boq-content" class="tab-content">
                    <div class="mb-4 flex justify-between items-center">
                        <h4 class="text-lg font-semibold text-gray-800">Bill of Quantities</h4>
                        <button onclick="addNewBOQRow()" 
                                class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class='bx bx-plus mr-1'></i>
                            Add New Item
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        {% if boq_items %}
                        <table class="w-full table-auto" id="boq-table">
                            <thead>
                                <tr class="bg-gray-50 border-b">
                                    <th class="text-left py-3 px-4 font-semibold text-sm text-gray-700">Item Description</th>
                                    <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">Unit</th>
                                    <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">Quantity</th>
                                    <th class="text-right py-3 px-4 font-semibold text-sm text-gray-700">Unit Cost</th>
                                    <th class="text-right py-3 px-4 font-semibold text-sm text-gray-700">Total Cost</th>
                                    <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">Type</th>
                                    <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="boq-table-body">
                                {% for item in boq_items %}
                                <tr class="hover:bg-gray-50 transition-colors" data-item-id="{{ item.id }}">
                                    <td class="py-4 px-4">
                                        <input type="text" 
                                               value="{{ item.item_description }}" 
                                               class="w-full border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm"
                                               onchange="updateBOQItem({{ item.id }}, 'item_description', this.value)"
                                               ondblclick="this.focus()">
                                    </td>
                                    <td class="py-4 px-4 text-center">
                                        <input type="text" 
                                               value="{{ item.unit or '' }}" 
                                               class="w-20 border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm text-center"
                                               onchange="updateBOQItem({{ item.id }}, 'unit', this.value)"
                                               ondblclick="this.focus()">
                                    </td>
                                    <td class="py-4 px-4 text-center">
                                        <input type="number" 
                                               value="{{ item.quantity or 0 }}" 
                                               class="w-24 border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm text-center"
                                               onchange="updateBOQItem({{ item.id }}, 'quantity', this.value)"
                                               ondblclick="this.focus()">
                                    </td>
                                    <td class="py-4 px-4 text-right">
                                        <input type="number" 
                                               value="{{ item.unit_price or 0 }}" 
                                               step="0.01"
                                               class="w-32 border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm text-right"
                                               onchange="updateBOQItem({{ item.id }}, 'unit_price', this.value)"
                                               ondblclick="this.focus()">
                                    </td>
                                    <td class="py-4 px-4 text-right">
                                        <span class="text-sm font-semibold text-green-700">₦{{ "{:,.2f}".format(item.total_cost) if item.total_cost else '0.00' }}</span>
                                    </td>
                                    <td class="py-4 px-4 text-center">
                                        <input type="text" 
                                               value="{{ item.item_type or '' }}" 
                                               class="w-24 border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm text-center"
                                               onchange="updateBOQItem({{ item.id }}, 'item_type', this.value)"
                                               ondblclick="this.focus()">
                                    </td>
                                    <td class="py-4 px-4 text-center">
                                        <div class="flex justify-center space-x-2">
                                            <button onclick="saveBOQItem({{ item.id }})" 
                                                    class="text-green-600 hover:text-green-800 p-1 rounded" title="Save Changes">
                                                <i class='bx bx-save text-sm'></i>
                                            </button>
                                            <button onclick="deleteBOQItem({{ item.id }})" 
                                                    class="text-red-600 hover:text-red-800 p-1 rounded" title="Delete Item">
                                                <i class='bx bx-trash text-sm'></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div id="boq-empty-state" class="text-center py-8">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class='bx bx-calculator text-2xl text-blue-400'></i>
                            </div>
                            <p class="text-gray-500 text-sm mb-4">No BOQ items found</p>
                            <p class="text-xs text-gray-400 mb-4">Load templates or import BOQ data to get started</p>
                            <div class="flex justify-center space-x-2">
                                <button onclick="loadBOQTemplatesFromButton()" 
                                        id="load-templates-btn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class='bx bx-download mr-1'></i>
                                    Load Templates
                                </button>
                                <button onclick="document.getElementById('boq-import-file').click()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class='bx bx-upload mr-1'></i>
                                    Import BOQ
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- BOQ Loading Skeleton -->
                        <div id="boq-loading-skeleton" class="hidden">
                            <div class="bg-white rounded-lg shadow-sm border">
                                <div class="px-6 py-4 border-b border-gray-200">
                                    <div class="h-6 bg-gray-200 rounded animate-pulse w-48"></div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3"><div class="h-4 bg-gray-200 rounded animate-pulse"></div></th>
                                                <th class="px-6 py-3"><div class="h-4 bg-gray-200 rounded animate-pulse"></div></th>
                                                <th class="px-6 py-3"><div class="h-4 bg-gray-200 rounded animate-pulse"></div></th>
                                                <th class="px-6 py-3"><div class="h-4 bg-gray-200 rounded animate-pulse"></div></th>
                                                <th class="px-6 py-3"><div class="h-4 bg-gray-200 rounded animate-pulse"></div></th>
                                                <th class="px-6 py-3"><div class="h-4 bg-gray-200 rounded animate-pulse"></div></th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <tr class="animate-pulse">
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-full"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-16"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-12"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-20"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-24"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-8"></div></td>
                                            </tr>
                                            <tr class="animate-pulse">
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-full"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-16"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-12"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-20"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-24"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-8"></div></td>
                                            </tr>
                                            <tr class="animate-pulse">
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-full"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-16"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-12"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-20"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-24"></div></td>
                                                <td class="px-6 py-4"><div class="h-4 bg-gray-200 rounded w-8"></div></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="px-6 py-4 border-t border-gray-200 bg-purple-50">
                                    <div class="flex items-center justify-center space-x-2">
                                        <div class="w-4 h-4 bg-purple-400 rounded-full animate-bounce"></div>
                                        <div class="w-4 h-4 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                        <div class="w-4 h-4 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                        <span class="text-purple-600 font-medium ml-2">Loading templates...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Material Schedule Tab Content -->
                <div id="materials-content" class="tab-content hidden">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-800">Material Schedule</h4>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="loadMaterialTemplates()" 
                                        class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                    <i class='bx bx-download mr-1'></i>
                                    Load Material Templates
                                </button>
                                <button onclick="addNewMaterialRow()" 
                                        class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                                    <i class='bx bx-plus mr-1'></i>
                                    Add New Material
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        {% if material_schedules %}
                        <table class="w-full table-auto" id="materials-table">
                            <thead>
                                <tr class="bg-gray-50 border-b">
                                    <th class="text-left py-3 px-4 font-semibold text-sm text-gray-700">Material/Item</th>
                                    <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">Unit</th>
                                    <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">Quantity</th>
                                    <th class="text-right py-3 px-4 font-semibold text-sm text-gray-700">Unit Cost</th>
                                    <th class="text-right py-3 px-4 font-semibold text-sm text-gray-700">Total Cost</th>
                                    <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">Status</th>
                                    <th class="text-center py-3 px-4 font-semibold text-sm text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="materials-table-body">
                                {% for item in material_schedules %}
                                <tr class="hover:bg-gray-50 transition-colors" data-item-id="{{ item.id }}">
                                    <td class="py-4 px-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                                <i class='bx bx-package text-purple-600 text-sm'></i>
                                            </div>
                                            <div>
                                                <input type="text" 
                                                       value="{{ item.material_name }}" 
                                                       class="w-full border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm font-medium"
                                                       onchange="updateMaterialItem({{ item.id }}, 'material_name', this.value)"
                                                       ondblclick="this.focus()">
                                                {% if item.specification %}
                                                <p class="text-xs text-gray-500">Spec: {{ item.specification[:50] }}{% if item.specification|length > 50 %}...{% endif %}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-4 px-4 text-center">
                                        <input type="text" 
                                               value="{{ item.unit or '' }}" 
                                               class="w-20 border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm text-center"
                                               onchange="updateMaterialItem({{ item.id }}, 'unit', this.value)"
                                               ondblclick="this.focus()">
                                    </td>
                                    <td class="py-4 px-4 text-center">
                                        <input type="number" 
                                               value="{{ item.required_qty or 0 }}" 
                                               class="w-24 border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm text-center font-medium"
                                               onchange="updateMaterialItem({{ item.id }}, 'required_qty', this.value)"
                                               ondblclick="this.focus()">
                                    </td>
                                    <td class="py-4 px-4 text-right">
                                        <input type="number" 
                                               value="{{ item.unit_cost or 0 }}" 
                                               step="0.01"
                                               class="w-32 border-0 bg-transparent focus:bg-white focus:border-gray-300 rounded px-2 py-1 text-sm text-right"
                                               onchange="updateMaterialItem({{ item.id }}, 'unit_cost', this.value)"
                                               ondblclick="this.focus()">
                                    </td>
                                    <td class="py-4 px-4 text-right">
                                        <span class="text-sm font-semibold text-green-700">₦{{ "{:,.2f}".format(item.total_cost) if item.total_cost else '0.00' }}</span>
                                    </td>
                                    <td class="py-4 px-4 text-center">
                                        <select class="text-xs px-2 py-1 rounded-full border-0 
                                                {% if item.status == 'Ordered' %}bg-blue-100 text-blue-800
                                                {% elif item.status == 'Delivered' %}bg-green-100 text-green-800
                                                {% elif item.status == 'Planned' %}bg-yellow-100 text-yellow-800
                                                {% elif item.status == 'In Use' %}bg-purple-100 text-purple-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}"
                                                onchange="updateMaterialStatus({{ item.id }}, this.value)">
                                            <option value="Planned" {{ 'selected' if not item.status or item.status == 'Planned' else '' }}>Planned</option>
                                            <option value="Ordered" {{ 'selected' if item.status == 'Ordered' else '' }}>Ordered</option>
                                            <option value="Delivered" {{ 'selected' if item.status == 'Delivered' else '' }}>Delivered</option>
                                            <option value="In Use" {{ 'selected' if item.status == 'In Use' else '' }}>In Use</option>
                                            <option value="Depleted" {{ 'selected' if item.status == 'Depleted' else '' }}>Depleted</option>
                                        </select>
                                    </td>
                                    <td class="py-4 px-4 text-center">
                                        <div class="flex justify-center space-x-2">
                                            <button onclick="saveMaterialItem({{ item.id }})" 
                                                    class="text-green-600 hover:text-green-800 p-1 rounded" title="Save Changes">
                                                <i class='bx bx-save text-sm'></i>
                                            </button>
                                            <button onclick="deleteMaterialItem({{ item.id }})" 
                                                    class="text-red-600 hover:text-red-800 p-1 rounded" title="Delete Item">
                                                <i class='bx bx-trash text-sm'></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        <!-- Material Schedule Summary -->
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-xs text-blue-600 font-medium uppercase tracking-wide">Total Items</p>
                                <p class="text-2xl font-bold text-blue-900">{{ material_schedules|length }}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <p class="text-xs text-green-600 font-medium uppercase tracking-wide">Total Value</p>
                                <p class="text-2xl font-bold text-green-900">₦{{ "{:,.0f}".format(total_material_cost) if total_material_cost else '0' }}</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <p class="text-xs text-yellow-600 font-medium uppercase tracking-wide">Pending Orders</p>
                                <p class="text-2xl font-bold text-yellow-900">{{ material_schedules|selectattr('status', 'equalto', 'Planned')|list|length }}</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <p class="text-xs text-purple-600 font-medium uppercase tracking-wide">Project Type</p>
                                <p class="text-sm font-bold text-purple-900">{{ project.project_type or 'General' }}</p>
                            </div>
                        </div>
                        {% else %}
                        <div id="materials-empty-state" class="text-center py-8">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class='bx bx-package text-2xl text-purple-400'></i>
                            </div>
                            <p class="text-gray-500 text-sm mb-4">No materials in schedule yet</p>
                            <p class="text-xs text-gray-400 mb-4">Materials will be generated from BOQ items</p>
                            <div class="flex justify-center space-x-2">
                                <button onclick="loadBOQTemplates()" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class='bx bx-download mr-1'></i>
                                    Load BOQ First
                                </button>
                                <button onclick="document.getElementById('material-import-file').click()" 
                                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                                    <i class='bx bx-upload mr-1'></i>
                                    Import Materials
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Management & Activity Sections -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Document Management -->
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class='bx bx-folder text-orange-600 mr-2'></i>
                        Documents & Reports
                    </h3>
                    <button onclick="openDocumentModal()" 
                            class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                        <i class='bx bx-upload mr-1'></i>
                        Upload Document
                    </button>
                </div>

                <div class="space-y-3" id="document-list">
                    {% if documents %}
                        {% for doc in documents %}
                        <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors"
                             data-document-id="{{ doc.id }}">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <i class='bx 
                                        {% if doc.file_type in ['pdf'] %}bx-file-doc text-red-600
                                        {% elif doc.file_type in ['xlsx', 'xls'] %}bx-file-doc text-green-600
                                        {% elif doc.file_type in ['jpg', 'jpeg', 'png'] %}bx-image text-blue-600
                                        {% else %}bx-file text-gray-600{% endif %}'></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ doc.filename }}</p>
                                    <p class="text-xs text-gray-500">
                                        <i class='bx bx-calendar mr-1'></i>
                                        Uploaded {{ doc.uploaded_at.strftime('%b %d, %Y') if doc.uploaded_at else 'Recently' }}
                                        {% if doc.uploaded_by %}• by {{ doc.uploaded_by }}{% endif %}
                                    </p>
                                    <p class="text-xs text-gray-400">{{ doc.formatted_file_size }} • {{ doc.file_type.upper() }}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <a href="{{ url_for('admin.download_document', project_id=project.id, document_id=doc.id) }}" 
                                   class="text-indigo-600 hover:text-indigo-800 p-1 rounded" 
                                   title="Download">
                                    <i class='bx bx-download text-sm'></i>
                                </a>
                                <button onclick="deleteDocument({{ doc.id }})" 
                                        class="text-red-600 hover:text-red-800 p-1 rounded" 
                                        title="Delete">
                                    <i class='bx bx-trash text-sm'></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class='bx bx-folder-open text-2xl text-gray-400'></i>
                            </div>
                            <p class="text-gray-500 text-sm mb-4">No documents uploaded yet</p>
                            <button onclick="openDocumentModal()" 
                                    class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                                <i class='bx bx-upload mr-1'></i>
                                Upload First Document
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Activity Log & Recent Tasks -->
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class='bx bx-history text-purple-600 mr-2'></i>
                        Activity Log
                    </h3>
                    <button onclick="refreshActivityLog()" 
                            class="text-purple-600 hover:text-purple-800 p-1 rounded">
                        <i class='bx bx-refresh text-lg'></i>
                    </button>
                </div>

                <div class="space-y-4" id="activity-log">
                    {% if activity_log %}
                        {% for activity in activity_log %}
                        <div class="flex items-start space-x-3 p-3 bg-purple-50 rounded-lg">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mt-1">
                                <i class='bx 
                                    {% if activity.action_type == 'milestone_added' %}bx-flag text-blue-600
                                    {% elif activity.action_type == 'staff_assigned' %}bx-user-plus text-green-600
                                    {% elif activity.action_type == 'document_uploaded' %}bx-upload text-orange-600
                                    {% elif activity.action_type == 'progress_updated' %}bx-trending-up text-indigo-600
                                    {% else %}bx-info-circle text-purple-600{% endif %} text-sm'></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-900">
                                    <span class="font-medium">{{ activity.user_name or 'System' }}</span>
                                    {{ activity.description }}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class='bx bx-time mr-1'></i>
                                    {{ activity.created_at.strftime('%B %d, %Y at %I:%M %p') if activity.created_at else 'Recently' }}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-6">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class='bx bx-history text-xl text-gray-400'></i>
                            </div>
                            <p class="text-gray-500 text-sm">No recent activity</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Recent Tasks Sub-section -->
                <div class="mt-6 pt-6 border-t">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class='bx bx-task text-green-600 mr-2'></i>
                            Recent Tasks
                        </h4>
                        <button onclick="openTaskModal()" 
                                class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class='bx bx-plus mr-1'></i>
                            Add Task
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        {% if recent_tasks %}
                            {% for task in recent_tasks %}
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">{{ task.title }}</p>
                                    <p class="text-xs text-gray-500">
                                        Updated: {{ task.updated_at.strftime('%B %d, %Y') if task.updated_at else 'Recently' }}
                                    </p>
                                    {% if task.percent_complete > 0 %}
                                    <div class="mt-2">
                                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                                            <span>Progress</span>
                                            <span>{{ task.percent_complete }}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-600 h-2 rounded-full transition-all" 
                                                 style="width: {{ task.percent_complete }}%"></div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full 
                                          {% if task.status == 'completed' %}bg-green-100 text-green-800
                                          {% elif task.status == 'in_progress' %}bg-blue-100 text-blue-800
                                          {% elif task.status == 'pending' %}bg-yellow-100 text-yellow-800
                                          {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ task.status.replace('_', ' ').title() }}
                                    </span>
                                    <button onclick="editTask({{ task.id }})" 
                                            class="text-indigo-600 hover:text-indigo-800 p-1 rounded">
                                        <i class='bx bx-edit text-sm'></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <p class="text-gray-500 text-sm mb-3">No tasks created yet</p>
                                <button onclick="openTaskModal()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class='bx bx-plus mr-1'></i>
                                    Create First Task
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <a href="{{ url_for('admin.milestones', project_id=project.id) }}" 
           class="group bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-white">
            <div class="flex items-center justify-between mb-4">
                <i class="bx bx-calendar text-3xl opacity-80"></i>
                <i class="bx bx-right-arrow-alt text-xl opacity-60 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2">Project Timeline</h3>
            <p class="text-blue-100 text-sm">View milestones, deadlines, and project schedule</p>
        </a>

        <button onclick="viewReports()" 
           class="group bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-white w-full text-left">
            <div class="flex items-center justify-between mb-4">
                <i class="bx bx-bar-chart-alt-2 text-3xl opacity-80"></i>
                <i class="bx bx-right-arrow-alt text-xl opacity-60 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2">Analytics & Reports</h3>
            <p class="text-green-100 text-sm">Access project analytics and generate reports</p>
        </button>

        <button onclick="openBudgetAnalysis()" 
                class="group bg-gradient-to-br from-yellow-500 to-orange-500 p-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-white text-left">
            <div class="flex items-center justify-between mb-4">
                <i class="bx bx-wallet text-3xl opacity-80"></i>
                <i class="bx bx-right-arrow-alt text-xl opacity-60 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2">Budget Analysis</h3>
            <p class="text-orange-100 text-sm">Detailed budget breakdown and forecasting</p>
        </button>

        <button onclick="openProjectSettings()" 
                class="group bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105 text-white text-left">
            <div class="flex items-center justify-between mb-4">
                <i class="bx bx-cog text-3xl opacity-80"></i>
                <i class="bx bx-right-arrow-alt text-xl opacity-60 group-hover:opacity-100 transition-opacity"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2">Project Settings</h3>
            <p class="text-purple-100 text-sm">Configure project preferences and permissions</p>
        </button>
    </div>

    <!-- Activity Log & Recent Tasks -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class='bx bx-history text-purple-600 mr-2'></i>
                    All Milestones
                </h3>
            </div>

            {% if milestones %}
                <div class="space-y-3 max-h-64 overflow-y-auto">
                    {% for milestone in milestones|sort(attribute='due_date') %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ milestone.title }}</p>
                            <p class="text-xs text-gray-500">
                                Due: {{ milestone.due_date.strftime('%B %d, %Y') }}
                            </p>
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full 
                              {% if milestone.status == 'Completed' %}bg-green-100 text-green-800
                              {% elif milestone.status == 'Pending' %}bg-yellow-100 text-yellow-800
                              {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ milestone.status }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}

                <div class="text-center py-4">
                    <p class="text-gray-500 text-sm">No milestones defined</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Tasks -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Tasks</h3>
                {% if recent_tasks %}
                <div class="space-y-3">
                    {% for task in recent_tasks %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ task.title }}</p>
                            <p class="text-xs text-gray-500">
                                Updated: {{ task.updated_at.strftime('%B %d, %Y') }}
                            </p>
                            {% if task.percent_complete > 0 %}
                            <div class="mt-1">
                                <div class="w-full bg-gray-200 rounded-full h-1">
                                    <div class="bg-blue-600 h-1 rounded-full" 
                                         style="width: {{ task.percent_complete }}%"></div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full 
                              {% if task.status == 'completed' %}bg-green-100 text-green-800
                              {% elif task.status == 'in_progress' %}bg-blue-100 text-blue-800
                              {% elif task.status == 'pending' %}bg-yellow-100 text-yellow-800
                              {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ task.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <p class="text-gray-500 text-sm">No tasks created</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Actions Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <a href="{{ url_for('admin.milestones', project_id=project.id) }}" 
           class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
            <i class="bx bx-calendar text-2xl text-indigo-600"></i>
            <h3 class="mt-2 text-lg font-medium text-gray-900">Timeline</h3>
            <p class="mt-1 text-sm text-gray-500">View project milestones and timeline</p>
        </a>

        <a href="{{ url_for('admin.projects') }}" 
           class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
            <i class="bx bx-file text-2xl text-indigo-600"></i>
            <h3 class="mt-2 text-lg font-medium text-gray-900">Reports</h3>
            <p class="mt-1 text-sm text-gray-500">Access project reports and documents</p>
        </a>

        <button onclick="editProject()" class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow text-left">
            <i class="bx bx-cog text-2xl text-indigo-600"></i>
            <h3 class="mt-2 text-lg font-medium text-gray-900">Settings</h3>
            <p class="mt-1 text-sm text-gray-500">Configure project settings</p>
        </button>
    </div>
</div>

    <!-- Assign Staff Form -->
    
    



    <!-- Modals Section -->
    
    <!-- Add Staff Modal -->
    <div id="addStaffModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Assign Staff Member</h3>
                    <button onclick="closeModal('addStaffModal')" class="text-gray-400 hover:text-gray-600">
                        <i class='bx bx-x text-xl'></i>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('admin.assign_staff_new', project_id=project.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <div class="mb-4">
                        <label for="staff_id" class="block text-sm font-medium text-gray-700 mb-2">
                            Select Staff/Employee
                            <span class="text-xs text-gray-500">(All users and employees available)</span>
                        </label>
                        <select name="staff_id" id="staff_id" required 
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Choose staff member or employee...</option>
                            
                            <!-- Users (Staff) Section -->
                            <optgroup label="👥 SYSTEM USERS (STAFF)">
                                {% for staff in available_staff %}
                                {% if staff.type == 'user' %}
                                <option value="{{ staff.id }}" 
                                        {% if staff.is_assigned %}style="background-color: #fee2e2; color: #dc2626;"{% endif %}>
                                    {{ staff.name }} 
                                    {% if staff.is_assigned %}(Already Assigned){% endif %}
                                    - {{ staff.role }} | {{ staff.email }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </optgroup>
                            
                            <!-- Employees Section -->
                            <optgroup label="🏢 HR EMPLOYEES">
                                {% for staff in available_staff %}
                                {% if staff.type == 'employee' %}
                                <option value="{{ staff.id }}">
                                    {{ staff.name }} - {{ staff.display_info }}
                                    {% if staff.staff_code %} | Code: {{ staff.staff_code }}{% endif %}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </optgroup>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="font-medium">Users:</span> System users with login access | 
                            <span class="font-medium">Employees:</span> HR database records
                        </p>
                    </div>
                    <div class="mb-4">
                        <label for="role" class="block text-sm font-medium text-gray-700 mb-2">Role in Project</label>
                        <select name="role" id="role" required 
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select role...</option>
                            <option value="Site Engineer">Site Engineer</option>
                            <option value="Project Manager">Project Manager</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Foreman">Foreman</option>
                            <option value="Safety Officer">Safety Officer</option>
                            <option value="Quality Control">Quality Control</option>
                            <option value="Technical Support">Technical Support</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('addStaffModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            Assign Staff
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Milestone Modal -->
    <div id="addMilestoneModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Add Project Milestone</h3>
                    <button onclick="closeModal('addMilestoneModal')" class="text-gray-400 hover:text-gray-600">
                        <i class='bx bx-x text-xl'></i>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('admin.add_milestone_new', project_id=project.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <div class="mb-4">
                        <label for="milestone_name" class="block text-sm font-medium text-gray-700 mb-2">Milestone Name</label>
                        <input type="text" name="milestone_name" id="milestone_name" required 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="e.g., Foundation Completion">
                    </div>
                    <div class="mb-4">
                        <label for="milestone_description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="milestone_description" id="milestone_description" rows="3" 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                  placeholder="Describe the milestone..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="due_date" class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                        <input type="date" name="due_date" id="due_date" required 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('addMilestoneModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            Add Milestone
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add BOQ Item Modal -->
    <div id="addBoqModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Add BOQ Item</h3>
                    <button onclick="closeModal('addBoqModal')" class="text-gray-400 hover:text-gray-600">
                        <i class='bx bx-x text-xl'></i>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('admin.add_boq_item', project_id=project.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <div class="mb-4">
                        <label for="item_description" class="block text-sm font-medium text-gray-700 mb-2">Item Description</label>
                        <input type="text" name="item_description" id="item_description" required 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="e.g., Portland Cement 42.5N">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                            <input type="number" name="quantity" id="quantity" required step="0.01" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="unit" class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                            <select name="unit" id="unit" required 
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Select unit...</option>
                                <option value="bags">Bags</option>
                                <option value="tons">Tons</option>
                                <option value="m³">Cubic Meters</option>
                                <option value="m²">Square Meters</option>
                                <option value="kg">Kilograms</option>
                                <option value="pcs">Pieces</option>
                                <option value="lump sum">Lump Sum</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="unit_price" class="block text-sm font-medium text-gray-700 mb-2">Unit Price (₦)</label>
                        <input type="number" name="unit_price" id="unit_price" required step="0.01" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('addBoqModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                            Add Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class='bx bx-edit text-indigo-600 mr-2'></i>
                        Edit Project Information
                    </h3>
                    <button onclick="closeModal('editProjectModal')" class="text-gray-400 hover:text-gray-600">
                        <i class='bx bx-x text-xl'></i>
                    </button>
                </div>
                <form id="editProjectForm" onsubmit="submitProjectEdit(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Basic Information -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">Basic Information</h4>
                            <div>
                                <label for="edit_name" class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                                <input type="text" name="name" id="edit_name" required 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="edit_description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea name="description" id="edit_description" rows="3"
                                          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label for="edit_start_date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="date" name="start_date" id="edit_start_date" 
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="edit_end_date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="date" name="end_date" id="edit_end_date" 
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label for="edit_status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select name="status" id="edit_status" 
                                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="Planning">Planning</option>
                                        <option value="Active">Active</option>
                                        <option value="On Hold">On Hold</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="edit_priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                    <select name="priority" id="edit_priority" 
                                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Critical">Critical</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Extended Information -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800 border-b pb-2">Project Details</h4>
                            <div>
                                <label for="edit_project_manager" class="block text-sm font-medium text-gray-700 mb-1">Project Manager</label>
                                <input type="text" name="project_manager" id="edit_project_manager" 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="edit_budget" class="block text-sm font-medium text-gray-700 mb-1">Budget (₦)</label>
                                <input type="number" name="budget" id="edit_budget" step="0.01" min="0"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="edit_project_type" class="block text-sm font-medium text-gray-700 mb-1">Project Type</label>
                                <select name="project_type" id="edit_project_type" 
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">Select Type...</option>
                                    <option value="Construction">Construction</option>
                                    <option value="Infrastructure">Infrastructure</option>
                                    <option value="Renovation">Renovation</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Consultation">Consultation</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit_client_name" class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                                <input type="text" name="client_name" id="edit_client_name" 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Details -->
                    <div class="mt-6 space-y-4">
                        <h4 class="font-semibold text-gray-800 border-b pb-2">Additional Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="edit_site_location" class="block text-sm font-medium text-gray-700 mb-1">Site Location</label>
                                <input type="text" name="site_location" id="edit_site_location" 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="edit_funding_source" class="block text-sm font-medium text-gray-700 mb-1">Funding Source</label>
                                <select name="funding_source" id="edit_funding_source" 
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">Select Source...</option>
                                    <option value="Internal">Internal Funding</option>
                                    <option value="Client Payment">Client Payment</option>
                                    <option value="Bank Loan">Bank Loan</option>
                                    <option value="Government Grant">Government Grant</option>
                                    <option value="Partnership">Partnership</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit_risk_level" class="block text-sm font-medium text-gray-700 mb-1">Risk Level</label>
                                <select name="risk_level" id="edit_risk_level" 
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_safety_requirements" class="block text-sm font-medium text-gray-700 mb-1">Safety Requirements</label>
                                <select name="safety_requirements" id="edit_safety_requirements" 
                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="Standard">Standard</option>
                                    <option value="Enhanced">Enhanced</option>
                                    <option value="High Security">High Security</option>
                                    <option value="Specialized">Specialized</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit_regulatory_requirements" class="block text-sm font-medium text-gray-700 mb-1">Regulatory Requirements</label>
                                <textarea name="regulatory_requirements" id="edit_regulatory_requirements" rows="2"
                                          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                        <button type="button" onclick="closeModal('editProjectModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
                            <i class='bx bx-save mr-1'></i>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Activity Log Modal -->
    <div id="activityLogModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class='bx bx-history text-purple-600 mr-2'></i>
                        Project Activity Log
                    </h3>
                    <button onclick="closeModal('activityLogModal')" class="text-gray-400 hover:text-gray-600">
                        <i class='bx bx-x text-xl'></i>
                    </button>
                </div>
                
                <!-- Activity Statistics -->
                <div class="bg-purple-50 rounded-lg p-4 mb-6" id="activityStats">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-purple-600" id="totalActivities">-</div>
                            <div class="text-sm text-purple-700">Total Activities</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-purple-600" id="recentActivities">-</div>
                            <div class="text-sm text-purple-700">This Week</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-purple-600" id="activityTypes">-</div>
                            <div class="text-sm text-purple-700">Activity Types</div>
                        </div>
                    </div>
                </div>
                
                <!-- Activity List -->
                <div class="max-h-96 overflow-y-auto" id="activityListContainer">
                    <div id="activityLoadingSpinner" class="flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                        <span class="ml-2 text-gray-600">Loading activities...</span>
                    </div>
                    <div id="activityList" class="space-y-3 hidden">
                        <!-- Activities will be loaded here -->
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="flex justify-between items-center mt-4 pt-4 border-t" id="activityPagination">
                    <div class="text-sm text-gray-500" id="activityPaginationInfo">
                        <!-- Pagination info -->
                    </div>
                    <div class="flex space-x-2" id="activityPaginationButtons">
                        <!-- Pagination buttons -->
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal('activityLogModal')" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Update Modal -->
    <div id="progressUpdateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class='bx bx-trending-up text-green-600 mr-2'></i>
                        Update Project Progress
                    </h3>
                    <button onclick="closeModal('progressUpdateModal')" class="text-gray-400 hover:text-gray-600">
                        <i class='bx bx-x text-xl'></i>
                    </button>
                </div>
                <form onsubmit="submitProgressUpdate(event)">
                    <div class="mb-4">
                        <label for="progress_value" class="block text-sm font-medium text-gray-700 mb-2">
                            Progress Percentage
                        </label>
                        <div class="relative">
                            <input type="range" name="progress" id="progress_slider" min="0" max="100" step="1" 
                                   value="{{ progress or 0 }}" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                   oninput="updateProgressDisplay(this.value)">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0%</span>
                                <span>25%</span>
                                <span>50%</span>
                                <span>75%</span>
                                <span>100%</span>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <span class="text-2xl font-bold text-green-600" id="progress_display">{{ progress or 0 }}%</span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="progress_notes" class="block text-sm font-medium text-gray-700 mb-2">
                            Progress Notes (Optional)
                        </label>
                        <textarea name="notes" id="progress_notes" rows="3" 
                                  placeholder="Add any notes about this progress update..."
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('progressUpdateModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            <i class='bx bx-check mr-1'></i>
                            Update Progress
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Upload Document Modal -->
    <div id="uploadDocumentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Upload Document</h3>
                    <button onclick="closeModal('uploadDocumentModal')" class="text-gray-400 hover:text-gray-600">
                        <i class='bx bx-x text-xl'></i>
                    </button>
                </div>
                <form method="POST" action="{{ url_for('admin.upload_document', project_id=project.id) }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <div class="mb-4">
                        <label for="document_file" class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
                        <input type="file" name="document_file" id="document_file" required 
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">Supported: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG (Max 10MB)</p>
                    </div>
                    <div class="mb-4">
                        <label for="document_type" class="block text-sm font-medium text-gray-700 mb-2">Document Type</label>
                        <select name="document_type" id="document_type" required 
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select type...</option>
                            <option value="Contract">Contract</option>
                            <option value="Drawing">Drawing</option>
                            <option value="Specification">Specification</option>
                            <option value="Report">Report</option>
                            <option value="Invoice">Invoice</option>
                            <option value="Certificate">Certificate</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="document_description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="document_description" id="document_description" rows="2" 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                  placeholder="Brief description of the document..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('uploadDocumentModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
                            <i class='bx bx-upload mr-1'></i>
                            Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript Functions -->
    <script>
        // Project Data from Server
        const projectDataElement = document.getElementById('project-data');
        const projectData = JSON.parse(projectDataElement.textContent);
        console.log('Project data loaded:', projectData);
        
        // Template Cache System for Fast Loading
        const templateCache = {
            cache: new Map(),
            preloadPromises: new Map(),
            
            // Check if templates are cached for a project type
            hasTemplates(projectType) {
                return this.cache.has(projectType);
            },
            
            // Get cached templates
            getTemplates(projectType) {
                return this.cache.get(projectType) || [];
            },
            
            // Cache templates for a project type
            setTemplates(projectType, templates) {
                this.cache.set(projectType, templates);
                console.log(`Cached ${templates.length} templates for ${projectType}`);
            },
            
            // Preload templates for a project type
            preloadTemplates(projectType) {
                if (this.hasTemplates(projectType) || this.preloadPromises.has(projectType)) {
                    return Promise.resolve();
                }
                
                console.log(`Preloading templates for ${projectType}...`);
                const promise = this.fetchTemplatesFromServer(projectType);
                this.preloadPromises.set(projectType, promise);
                return promise;
            },
            
            // Fetch templates from server
            fetchTemplatesFromServer(projectType) {
                return fetch(`/admin/projects/${projectData.id}/get_boq_templates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ project_type: projectType })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.setTemplates(projectType, data.templates);
                        this.preloadPromises.delete(projectType);
                        return data.templates;
                    }
                    throw new Error(data.message || 'Failed to fetch templates');
                });
            },
            
            // Clear cache (useful for development)
            clearCache() {
                this.cache.clear();
                this.preloadPromises.clear();
                console.log('Template cache cleared');
            }
        };

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function openStaffModal() {
            openModal('addStaffModal');
        }

        function openMilestoneModal() {
            openModal('addMilestoneModal');
        }

        function openBOQModal() {
            openModal('addBoqModal');
        }

        function openDocumentModal() {
            openModal('uploadDocumentModal');
        }

        function openTaskModal() {
            // Redirect to projects page since admin.tasks doesn't exist
            window.location.href = "{{ url_for('admin.projects') }}";
        }

        function openBudgetModal() {
            // Redirect to admin expenses page for this project
            window.location.href = "/admin/projects/{{ project.id }}/expenses";
        }

        function openBudgetAnalysis() {
            // Redirect to admin budget analysis page
            window.location.href = "/admin/projects/{{ project.id }}/budget-analysis";
        }

        function openProjectSettings() {
            // Redirect to admin project settings page
            window.location.href = "/admin/projects/{{ project.id }}/settings";
        }

        function editProjectInfo() {
            // Redirect to edit project page
            window.location.href = "/admin/projects/{{ project.id }}/edit";
        }

        function editProject() {
            // Fetch project data and open edit modal
            fetch(`/admin/projects/${projectData.id}/edit`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        openEditProjectModal(data.project);
                    } else {
                        showFlashModal('error', 'Error loading project data');
                    }
                })
                .catch(error => {
                    console.error('Error fetching project data:', error);
                    showFlashModal('error', 'Error loading project data');
                });
        }

        function showActivityLog() {
            // Open activity log modal
            openActivityLogModal();
        }

        function viewReports() {
            // Redirect to admin reports page
            window.location.href = "/admin/projects/{{ project.id }}/reports";
        }

        // Staff Management
        function removeStaff(staffId, staffName) {
            if (confirm('Are you sure you want to remove this staff member from the project?')) {
                // Create and submit a form for staff removal
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('admin.remove_staff_new', project_id=project.id) }}";
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = '{{ csrf_token }}';
                form.appendChild(csrfInput);
                
                const staffInput = document.createElement('input');
                staffInput.type = 'hidden';
                staffInput.name = 'staff_id';
                staffInput.value = staffId;
                form.appendChild(staffInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Milestone Management
        function deleteMilestone(milestoneId) {
            if (confirm('Are you sure you want to delete this milestone?')) {
                // Create and submit a form for milestone deletion
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/delete-milestone/${milestoneId}`;
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = '{{ csrf_token }}';
                form.appendChild(csrfInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // BOQ Management
        function deleteBoqItem(itemId) {
            if (confirm('Are you sure you want to delete this BOQ item?')) {
                // Create and submit a form for BOQ item deletion
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('admin.add_boq_item', project_id=project.id) }}";
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = '{{ csrf_token }}';
                form.appendChild(csrfInput);
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'delete';
                form.appendChild(actionInput);
                
                const itemInput = document.createElement('input');
                itemInput.type = 'hidden';
                itemInput.name = 'item_id';
                itemInput.value = itemId;
                form.appendChild(itemInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Document Management
        function downloadDocument(documentId) {
            // Use admin download link
            window.open(`/admin/projects/{{ project.id }}/documents/${documentId}/download`, '_blank');
        }

        function deleteDocument(documentId) {
            if (confirm('Are you sure you want to delete this document?')) {
                // Create and submit a form for document deletion
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('admin.upload_document', project_id=project.id) }}";
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = '{{ csrf_token }}';
                form.appendChild(csrfInput);
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'delete';
                form.appendChild(actionInput);
                
                const docInput = document.createElement('input');
                docInput.type = 'hidden';
                docInput.name = 'document_id';
                docInput.value = documentId;
                form.appendChild(docInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Progress Updates
        function updateProgress() {
            // Open progress update modal
            openModal('progressUpdateModal');
            
            // Set current progress value
            const currentProgress = projectData.progress || 0;
            document.getElementById('progress_slider').value = currentProgress;
            document.getElementById('progress_display').textContent = currentProgress + '%';
        }

        // Activity Log
        function refreshActivityLog() {
            location.reload();
        }

        function editTask(taskId) {
            // Implement task editing functionality
            console.log('Editing task:', taskId);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = ['addStaffModal', 'addMilestoneModal', 'addBoqModal', 'uploadDocumentModal', 'editProjectModal', 'activityLogModal', 'progressUpdateModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
            
            // Handle flash modal click outside
            const flashModal = document.getElementById('flashMessageModal');
            if (event.target === flashModal) {
                closeFlashModal();
            }
        }

        // Auto-calculate total in BOQ form
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.getElementById('quantity');
            const unitPriceInput = document.getElementById('unit_price');
            
            if (quantityInput && unitPriceInput) {
                function calculateTotal() {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const unitPrice = parseFloat(unitPriceInput.value) || 0;
                    const total = quantity * unitPrice;
                    
                    // Update display if total element exists
                    const totalDisplay = document.getElementById('calculated_total');
                    if (totalDisplay) {
                        totalDisplay.textContent = `₦${total.toLocaleString()}`;
                    }
                }
                
                quantityInput.addEventListener('input', calculateTotal);
                unitPriceInput.addEventListener('input', calculateTotal);
            }
        });

        // Edit Project Function
        function editProject() {
            alert('Edit project functionality coming soon!');
        }

        // View Reports Function
        function viewReports() {
            window.location.href = `{{ url_for('admin.project_reports', project_id=project.id) }}`;
        }

        // Auto-close modals on successful form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Check for success flash messages
            const successMessages = document.querySelectorAll('.bg-green-50');
            if (successMessages.length > 0) {
                // Close all modals if there's a success message
                const modals = document.querySelectorAll('[id$="Modal"]');
                modals.forEach(modal => {
                    modal.classList.add('hidden');
                });
                
                // Auto-hide success messages after 5 seconds
                setTimeout(() => {
                    successMessages.forEach(msg => {
                        msg.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                        msg.style.opacity = '0';
                        msg.style.transform = 'translateX(100%)';
                        setTimeout(() => msg.remove(), 500);
                    });
                }, 5000);
            }
        });

        // Flash Message Modal System
        function showFlashModal(category, message) {
            const modalId = 'flashMessageModal';
            let flashModal = document.getElementById(modalId);
            
            // Remove existing modal if it exists
            if (flashModal) {
                flashModal.remove();
            }
            
            // Determine modal styling based on category
            let iconClass, bgColor, btnColor, borderColor, iconBg;
            switch(category) {
                case 'success':
                    iconClass = 'bx-check-circle';
                    bgColor = 'bg-green-50';
                    btnColor = 'bg-green-500 hover:bg-green-600 focus:ring-green-300';
                    borderColor = 'border-green-200';
                    iconBg = 'bg-green-100';
                    break;
                case 'error':
                    iconClass = 'bx-error-circle';
                    bgColor = 'bg-red-50';
                    btnColor = 'bg-red-500 hover:bg-red-600 focus:ring-red-300';
                    borderColor = 'border-red-200';
                    iconBg = 'bg-red-100';
                    break;
                case 'warning':
                    iconClass = 'bx-error';
                    bgColor = 'bg-yellow-50';
                    btnColor = 'bg-yellow-500 hover:bg-yellow-600 focus:ring-yellow-300';
                    borderColor = 'border-yellow-200';
                    iconBg = 'bg-yellow-100';
                    break;
                default:
                    iconClass = 'bx-info-circle';
                    bgColor = 'bg-blue-50';
                    btnColor = 'bg-blue-500 hover:bg-blue-600 focus:ring-blue-300';
                    borderColor = 'border-blue-200';
                    iconBg = 'bg-blue-100';
            }
            
            // Create modal
            flashModal = document.createElement('div');
            flashModal.id = modalId;
            flashModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            flashModal.innerHTML = `
                <div class="relative top-20 mx-auto p-0 border ${borderColor} w-96 shadow-2xl rounded-lg bg-white modal-bounce">
                    <div class="rounded-lg ${bgColor}">
                        <div class="p-6 text-center">
                            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full ${iconBg} mb-4 shadow-lg">
                                <i class='bx ${iconClass} text-3xl' style="color: ${category === 'success' ? '#059669' : category === 'error' ? '#DC2626' : category === 'warning' ? '#D97706' : '#2563EB'};"></i>
                            </div>
                            <h3 class="text-xl leading-6 font-bold text-gray-900 mb-3">
                                ${category.charAt(0).toUpperCase() + category.slice(1)}${category === 'error' ? '!' : category === 'success' ? '!' : ''}
                            </h3>
                            <div class="mb-6">
                                <p class="text-sm text-gray-700 font-medium leading-relaxed">${message}</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="closeFlashModal()" 
                                        class="flex-1 px-6 py-3 ${btnColor} text-white text-sm font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 transition duration-300 transform hover:scale-105">
                                    OK
                                </button>
                            </div>
                            <div class="mt-3">
                                <p class="text-xs text-gray-400">Press ESC to close</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(flashModal);
            
            // Add keyboard event listener for ESC key
            function handleKeydown(event) {
                if (event.key === 'Escape') {
                    closeFlashModal();
                    document.removeEventListener('keydown', handleKeydown);
                }
            }
            document.addEventListener('keydown', handleKeydown);
            
            // Focus the modal for keyboard navigation
            flashModal.focus();
            
            // Auto-close after appropriate time based on category
            const autoCloseTime = category === 'success' ? 4000 : category === 'error' ? 6000 : 5000;
            const autoCloseTimer = setTimeout(() => {
                closeFlashModal();
            }, autoCloseTime);
            
            // Store timer reference to clear it if manually closed
            flashModal.autoCloseTimer = autoCloseTimer;
        }

        function closeFlashModal() {
            const flashModal = document.getElementById('flashMessageModal');
            if (flashModal) {
                // Clear auto-close timer if it exists
                if (flashModal.autoCloseTimer) {
                    clearTimeout(flashModal.autoCloseTimer);
                }
                
                // Add fade-out animation
                flashModal.style.opacity = '0';
                flashModal.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    if (flashModal.parentNode) {
                        flashModal.remove();
                    }
                }, 300);
            }
        }

        // Success Modal Function (alternative to flash messages)
        function showSuccessModal(message) {
            // Use the new flash modal system
            showFlashModal('success', message);
        }

        function closeSuccessModal() {
            closeFlashModal();
        }

        // Enhanced Modal and Business Logic Functions

        function openEditProjectModal(projectData) {
            // Populate form with current project data
            document.getElementById('edit_name').value = projectData.name || '';
            document.getElementById('edit_description').value = projectData.description || '';
            document.getElementById('edit_start_date').value = projectData.start_date || '';
            document.getElementById('edit_end_date').value = projectData.end_date || '';
            document.getElementById('edit_status').value = projectData.status || 'Planning';
            document.getElementById('edit_project_manager').value = projectData.project_manager || '';
            document.getElementById('edit_budget').value = projectData.budget || '';
            document.getElementById('edit_project_type').value = projectData.project_type || '';
            document.getElementById('edit_priority').value = projectData.priority || 'Medium';
            document.getElementById('edit_client_name').value = projectData.client_name || '';
            document.getElementById('edit_site_location').value = projectData.site_location || '';
            document.getElementById('edit_funding_source').value = projectData.funding_source || '';
            document.getElementById('edit_risk_level').value = projectData.risk_level || 'Low';
            document.getElementById('edit_safety_requirements').value = projectData.safety_requirements || 'Standard';
            document.getElementById('edit_regulatory_requirements').value = projectData.regulatory_requirements || '';
            
            openModal('editProjectModal');
        }

        function submitProjectEdit(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bx bx-loader-alt animate-spin mr-1"></i>Saving...';
            submitBtn.disabled = true;
            
            fetch(`/admin/projects/${projectData.id}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', data.message);
                    closeModal('editProjectModal');
                    // Refresh page to show updated data
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showFlashModal('error', data.message || 'Failed to update project');
                }
            })
            .catch(error => {
                console.error('Error updating project:', error);
                showFlashModal('error', 'An error occurred while updating the project');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        function openActivityLogModal() {
            openModal('activityLogModal');
            loadActivityLog(1); // Load first page
        }

        function loadActivityLog(page = 1) {
            const loadingSpinner = document.getElementById('activityLoadingSpinner');
            const activityList = document.getElementById('activityList');
            
            loadingSpinner.classList.remove('hidden');
            activityList.classList.add('hidden');
            
            fetch(`/admin/projects/${projectData.id}/activity_log?page=${page}&per_page=20`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayActivityLog(data);
                    } else {
                        showFlashModal('error', data.message || 'Failed to load activity log');
                    }
                })
                .catch(error => {
                    console.error('Error loading activity log:', error);
                    showFlashModal('error', 'An error occurred while loading the activity log');
                })
                .finally(() => {
                    loadingSpinner.classList.add('hidden');
                    activityList.classList.remove('hidden');
                });
        }

        function displayActivityLog(data) {
            // Update statistics
            document.getElementById('totalActivities').textContent = data.statistics.total_activities;
            document.getElementById('recentActivities').textContent = data.statistics.recent_activities_week;
            document.getElementById('activityTypes').textContent = Object.keys(data.statistics.activity_types).length;
            
            // Display activities
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = '';
            
            data.activities.forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = 'flex items-start space-x-3 p-3 bg-purple-50 rounded-lg';
                
                // Icon based on activity type
                let iconClass = 'bx-info-circle text-purple-600';
                if (activity.action_type === 'milestone_added') iconClass = 'bx-flag text-blue-600';
                else if (activity.action_type === 'staff_assigned') iconClass = 'bx-user-plus text-green-600';
                else if (activity.action_type === 'document_uploaded') iconClass = 'bx-upload text-orange-600';
                else if (activity.action_type === 'progress_updated') iconClass = 'bx-trending-up text-indigo-600';
                else if (activity.action_type === 'project_updated') iconClass = 'bx-edit text-yellow-600';
                
                activityElement.innerHTML = `
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mt-1">
                        <i class="bx ${iconClass} text-sm"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-900">
                            <span class="font-medium">${activity.user_name}</span>
                            ${activity.description}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="bx bx-time mr-1"></i>
                            ${activity.created_at}
                        </p>
                    </div>
                `;
                
                activityList.appendChild(activityElement);
            });
            
            // Update pagination
            displayActivityPagination(data.pagination);
        }

        function displayActivityPagination(pagination) {
            const paginationInfo = document.getElementById('activityPaginationInfo');
            const paginationButtons = document.getElementById('activityPaginationButtons');
            
            // Info
            const start = ((pagination.page - 1) * pagination.per_page) + 1;
            const end = Math.min(pagination.page * pagination.per_page, pagination.total);
            paginationInfo.textContent = `Showing ${start}-${end} of ${pagination.total} activities`;
            
            // Buttons
            paginationButtons.innerHTML = '';
            
            // Previous button
            if (pagination.has_prev) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors';
                prevBtn.innerHTML = '<i class="bx bx-chevron-left"></i>';
                prevBtn.onclick = () => loadActivityLog(pagination.page - 1);
                paginationButtons.appendChild(prevBtn);
            }
            
            // Page numbers (show current and nearby pages)
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.pages, pagination.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = i === pagination.page 
                    ? 'px-3 py-1 bg-purple-600 text-white rounded' 
                    : 'px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors';
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadActivityLog(i);
                paginationButtons.appendChild(pageBtn);
            }
            
            // Next button
            if (pagination.has_next) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors';
                nextBtn.innerHTML = '<i class="bx bx-chevron-right"></i>';
                nextBtn.onclick = () => loadActivityLog(pagination.page + 1);
                paginationButtons.appendChild(nextBtn);
            }
        }

        function updateProgressDisplay(value) {
            document.getElementById('progress_display').textContent = value + '%';
        }

        function submitProgressUpdate(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const progress = parseFloat(formData.get('progress'));
            const notes = formData.get('notes');
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bx bx-loader-alt animate-spin mr-1"></i>Updating...';
            submitBtn.disabled = true;
            
            fetch(`/admin/projects/${projectData.id}/update_progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ progress: progress, notes: notes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', data.message);
                    closeModal('progressUpdateModal');
                    
                    // Update progress bar and text in the page
                    const progressBar = document.querySelector('[data-progress-bar]');
                    const progressText = document.querySelector('[data-progress-text]');
                    
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                        // Update color based on progress
                        progressBar.className = progressBar.className.replace(
                            /from-\w+-\d+\s+to-\w+-\d+/g,
                            progress < 25 ? 'from-red-500 to-red-600' :
                            progress < 50 ? 'from-orange-500 to-yellow-500' :
                            progress < 75 ? 'from-yellow-500 to-green-500' :
                            'from-green-500 to-blue-500'
                        );
                    }
                    
                    if (progressText) {
                        progressText.textContent = progress + '%';
                    }
                    
                    // Update project data
                    projectData.progress = progress;
                } else {
                    showFlashModal('error', data.message || 'Failed to update progress');
                }
            })
            .catch(error => {
                console.error('Error updating progress:', error);
                showFlashModal('error', 'An error occurred while updating progress');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        // Material Schedule Functions
        function generateMaterialSchedule() {
            showFlashModal('info', 'Generating material schedule from BOQ items...');
            
            fetch(`/admin/projects/${projectData.id}/generate_material_schedule`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', `Generated ${data.materials_added || 0} material items from BOQ`);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showFlashModal('error', data.message || 'Failed to generate material schedule');
                }
            })
            .catch(error => {
                console.error('Error generating material schedule:', error);
                showFlashModal('error', 'An error occurred while generating material schedule');
            });
        }

        function exportMaterialSchedule() {
            showFlashModal('info', 'Preparing material schedule export...');
            
            window.location.href = `/admin/projects/${projectData.id}/export_material_schedule`;
            
            // Show success message after a delay
            setTimeout(() => {
                showFlashModal('success', 'Material schedule exported successfully!');
            }, 2000);
        }

        // Tab Switching Functions
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('active', 'border-purple-500', 'text-purple-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            const selectedContent = document.getElementById(tabName + '-content');
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }
            
            // Activate selected tab
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active', 'border-purple-500', 'text-purple-600');
                selectedTab.classList.remove('border-transparent', 'text-gray-500');
            }
        }

        // Preloading and Enhanced Template Functions
        function preloadAllCommonTemplates() {
            const commonTypes = ['Bridge', 'Building', 'Road', 'Culvert'];
            commonTypes.forEach(type => {
                if (!templateCache.hasTemplates(type)) {
                    templateCache.preloadTemplates(type).catch(err => {
                        console.log(`Failed to preload ${type} templates:`, err);
                    });
                }
            });
        }

        function handleProjectTypeChange(projectType) {
            if (!projectType) return;
            
            // Update visual indicator immediately
            showTemplateLoadingStatus(true);
            const statusDiv = document.getElementById('template-loading-status');
            if (statusDiv) {
                statusDiv.innerHTML = '<i class="fas fa-magic text-purple-600 mr-2"></i>Templates ready for loading...';
            }
            
            // Preload templates for instant access
            templateCache.preloadTemplates(projectType).then(() => {
                showTemplateLoadingStatus(false);
                const count = templateCache.getTemplates(projectType).length;
                showFlashModal('info', `${count} ${projectType} templates are ready! Click "Load Templates" to add them.`);
            }).catch(err => {
                showTemplateLoadingStatus(false);
                console.error('Preload failed:', err);
            });
        }

        function loadProjectTypeTemplatesInstant(projectType) {
            if (!projectType) return;
            
            const loadButton = document.getElementById('load-templates-btn');
            if (loadButton) {
                loadButton.disabled = true;
                loadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            }
            
            // Check cache first for instant loading
            if (templateCache.hasTemplates(projectType)) {
                const templates = templateCache.getTemplates(projectType);
                console.log(`Loading ${templates.length} cached templates instantly...`);
                
                // Still need to call server to add to project, but we can show preview immediately
                loadTemplatesFromCache(projectType, templates);
                return;
            }
            
            // Fall back to original loading if not cached
            loadProjectTypeTemplates(projectType);
        }

        function loadTemplatesFromCache(projectType, templates) {
            // Show skeleton for better UX
            showLoadingSkeleton(true);
            
            // Call server to actually add templates to project
            fetch(`/admin/projects/${projectData.id}/load_boq_templates`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    project_type: projectType
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoadingSkeleton(false);
                showTemplateLoadingStatus(false);
                const loadButton = document.getElementById('load-templates-btn');
                if (loadButton) {
                    loadButton.disabled = false;
                    loadButton.innerHTML = '<i class="fas fa-download mr-2"></i>Load Templates';
                }
                
                if (data.success) {
                    showFlashModal('success', `⚡ ${projectType} templates loaded instantly! Added ${data.items_added} items.`);
                    // Refresh the current tab content
                    const activeTab = document.querySelector('.tab-button.active');
                    if (activeTab) {
                        const tabName = activeTab.getAttribute('onclick').includes('boq') ? 'boq' : 'materials';
                        switchTab(tabName);
                    }
                } else {
                    showFlashModal('error', 'Failed to load templates: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                showLoadingSkeleton(false);
                showTemplateLoadingStatus(false);
                const loadButton = document.getElementById('load-templates-btn');
                if (loadButton) {
                    loadButton.disabled = false;
                    loadButton.innerHTML = '<i class="fas fa-download mr-2"></i>Load Templates';
                }
                showFlashModal('error', 'Failed to load project templates: ' + error.message);
                console.error('Template loading error:', error);
            });
        }

        function showLoadingSkeleton(show) {
            const skeleton = document.getElementById('boq-loading-skeleton');
            const boqContent = document.querySelector('[id^="boq-tab"]');
            
            if (show) {
                if (skeleton) skeleton.classList.remove('hidden');
                if (boqContent) boqContent.style.opacity = '0.3';
            } else {
                if (skeleton) skeleton.classList.add('hidden');
                if (boqContent) boqContent.style.opacity = '1';
            }
        }

        // Project Type Template Loading
        function loadProjectTypeTemplates(projectType) {
            if (!projectType) return;
            
            const loadButton = document.getElementById('load-templates-btn');
            if (loadButton) {
                loadButton.disabled = true;
                loadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            }
            
            showTemplateLoadingStatus(true);
            
            // Load BOQ templates directly
            fetch(`/admin/projects/${projectData.id}/load_boq_templates`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    project_type: projectType
                })
            })
            .then(response => response.json())
            .then(data => {
                showTemplateLoadingStatus(false);
                if (loadButton) {
                    loadButton.disabled = false;
                    loadButton.innerHTML = '<i class="fas fa-download mr-2"></i>Load Templates';
                }
                
                if (data.success) {
                    showFlashModal('success', `${projectType} templates loaded successfully! Added ${data.items_added} items.`);
                    // Refresh the current tab content instead of reloading entire page
                    const activeTab = document.querySelector('.tab-button.active');
                    if (activeTab) {
                        const tabName = activeTab.getAttribute('onclick').includes('boq') ? 'boq' : 'materials';
                        switchTab(tabName);
                    }
                } else {
                    showFlashModal('error', 'Failed to load templates: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                showTemplateLoadingStatus(false);
                if (loadButton) {
                    loadButton.disabled = false;
                    loadButton.innerHTML = '<i class="fas fa-download mr-2"></i>Load Templates';
                }
                showFlashModal('error', 'Failed to load project templates: ' + error.message);
                console.error('Template loading error:', error);
            });
        }

        function loadBOQTemplatesFromButton() {
            const projectTypeSelector = document.getElementById('project-type-selector');
            const selectedType = projectTypeSelector ? projectTypeSelector.value : null;
            
            if (!selectedType) {
                showFlashModal('warning', 'Please select a project type first');
                return;
            }
            
            console.log('Loading templates for project type:', selectedType);
            console.log('Project data:', projectData);
            
            // Use simple direct loading for debugging
            loadProjectTypeTemplatesSimple(selectedType);
        }

        function loadProjectTypeTemplatesSimple(projectType) {
            if (!projectType) return;
            
            console.log('Starting template load for:', projectType);
            
            const loadButton = document.getElementById('load-templates-btn');
            if (loadButton) {
                loadButton.disabled = true;
                loadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            }
            
            showFlashModal('info', `Loading ${projectType} templates...`);
            
            // Direct API call without cache
            fetch(`/admin/projects/${projectData.id}/load_boq_templates`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': projectData.csrf
                },
                body: JSON.stringify({
                    project_type: projectType
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (loadButton) {
                    loadButton.disabled = false;
                    loadButton.innerHTML = '<i class="fas fa-download mr-2"></i>Load Templates';
                }
                
                if (data.success) {
                    showFlashModal('success', `${projectType} templates loaded successfully! Added ${data.items_added} items.`);
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showFlashModal('error', 'Failed to load templates: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Template loading error:', error);
                if (loadButton) {
                    loadButton.disabled = false;
                    loadButton.innerHTML = '<i class="fas fa-download mr-2"></i>Load Templates';
                }
                showFlashModal('error', 'Failed to load project templates: ' + error.message);
            });
        }

        function updateProjectType(projectType) {
            return fetch(`/admin/projects/${projectData.id}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    project_type: projectType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Failed to update project type');
                }
                return data;
            });
        }

        function loadBOQTemplates(projectType = null) {
            const selectedType = projectType || document.getElementById('project-type-selector').value;
            if (!selectedType) {
                showFlashModal('warning', 'Please select a project type first');
                return Promise.reject('No project type selected');
            }
            
            return fetch(`/admin/projects/${projectData.id}/load_boq_templates`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    project_type: selectedType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', `${data.items_added || 0} BOQ template items loaded`);
                    // Refresh the BOQ table
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || 'Failed to load BOQ templates');
                }
                return data;
            });
        }

        function showTemplateLoadingStatus(show) {
            const statusDiv = document.getElementById('template-loading-status');
            if (statusDiv) {
                if (show) {
                    statusDiv.classList.remove('hidden');
                } else {
                    statusDiv.classList.add('hidden');
                }
            }
        }

        // Load Material Schedule Templates
        function loadMaterialTemplates() {
            if (!confirm('This will load material schedule templates. Any existing material schedule data will remain. Continue?')) {
                return;
            }
            
            showFlashModal('info', 'Loading material schedule templates...');
            
            fetch(`/admin/projects/{{ project.id }}/load_material_templates`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', `${data.message}. Refreshing page...`);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.message || 'Failed to load material templates');
                }
            })
            .catch(error => {
                console.error('Error loading material templates:', error);
                showFlashModal('error', `Error: ${error.message}`);
            });
        }

        // Import Functions
        function importBOQFile(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('boq_file', file);
            formData.append('csrf_token', '{{ csrf_token }}');
            
            showFlashModal('info', 'Importing BOQ data...');
            
            fetch(`/admin/projects/${projectData.id}/import_boq`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', `Successfully imported ${data.items_imported || 0} BOQ items`);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showFlashModal('error', data.message || 'Failed to import BOQ data');
                }
            })
            .catch(error => {
                console.error('BOQ import error:', error);
                showFlashModal('error', 'An error occurred while importing BOQ data');
            })
            .finally(() => {
                fileInput.value = ''; // Reset file input
            });
        }

        function importMaterialFile(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('material_file', file);
            formData.append('csrf_token', '{{ csrf_token }}');
            
            showFlashModal('info', 'Importing material schedule...');
            
            fetch(`/admin/projects/${projectData.id}/import_materials`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', `Successfully imported ${data.items_imported || 0} material items`);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showFlashModal('error', data.message || 'Failed to import material schedule');
                }
            })
            .catch(error => {
                console.error('Material import error:', error);
                showFlashModal('error', 'An error occurred while importing material schedule');
            })
            .finally(() => {
                fileInput.value = ''; // Reset file input
            });
        }

        // Inline Editing Functions
        function updateBOQItem(itemId, field, value) {
            // Store the change temporarily
            if (!window.boqChanges) window.boqChanges = {};
            if (!window.boqChanges[itemId]) window.boqChanges[itemId] = {};
            window.boqChanges[itemId][field] = value;
            
            // Calculate total cost if quantity or unit_price changed
            if (field === 'quantity' || field === 'unit_price') {
                const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                if (row) {
                    const quantity = parseFloat(window.boqChanges[itemId].quantity || row.querySelector('input[onchange*="quantity"]').value || 0);
                    const unitPrice = parseFloat(window.boqChanges[itemId].unit_price || row.querySelector('input[onchange*="unit_price"]').value || 0);
                    const totalCost = quantity * unitPrice;
                    
                    const totalCell = row.querySelector('td:nth-child(5) span');
                    if (totalCell) {
                        totalCell.textContent = `₦${totalCost.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                    }
                }
            }
        }

        function saveBOQItem(itemId) {
            if (!window.boqChanges || !window.boqChanges[itemId]) {
                showFlashModal('info', 'No changes to save');
                return;
            }
            
            fetch(`/admin/projects/${projectData.id}/update_boq_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    item_id: itemId,
                    updates: window.boqChanges[itemId]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', 'BOQ item updated successfully');
                    // Clear the changes for this item
                    delete window.boqChanges[itemId];
                } else {
                    showFlashModal('error', data.message || 'Failed to update BOQ item');
                }
            })
            .catch(error => {
                console.error('BOQ update error:', error);
                showFlashModal('error', 'An error occurred while updating BOQ item');
            });
        }

        function deleteBOQItem(itemId) {
            if (!confirm('Are you sure you want to delete this BOQ item?')) return;
            
            fetch(`/admin/projects/${projectData.id}/delete_boq_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    item_id: itemId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', 'BOQ item deleted successfully');
                    // Remove the row from the table
                    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                    if (row) {
                        row.remove();
                    }
                } else {
                    showFlashModal('error', data.message || 'Failed to delete BOQ item');
                }
            })
            .catch(error => {
                console.error('BOQ delete error:', error);
                showFlashModal('error', 'An error occurred while deleting BOQ item');
            });
        }

        function addNewBOQRow() {
            const tableBody = document.getElementById('boq-table-body');
            if (!tableBody) {
                showFlashModal('error', 'BOQ table not found');
                return;
            }
            
            // Create new row with temporary ID
            const tempId = 'new_' + Date.now();
            const newRow = document.createElement('tr');
            newRow.className = 'hover:bg-gray-50 transition-colors';
            newRow.setAttribute('data-item-id', tempId);
            newRow.innerHTML = `
                <td class="py-4 px-4">
                    <input type="text" 
                           value="New Item" 
                           class="w-full border-0 bg-white border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-purple-500"
                           onchange="updateBOQItem('${tempId}', 'item_description', this.value)"
                           ondblclick="this.focus()">
                </td>
                <td class="py-4 px-4 text-center">
                    <input type="text" 
                           value="unit" 
                           class="w-20 border-0 bg-white border-gray-300 rounded px-2 py-1 text-sm text-center focus:ring-2 focus:ring-purple-500"
                           onchange="updateBOQItem('${tempId}', 'unit', this.value)"
                           ondblclick="this.focus()">
                </td>
                <td class="py-4 px-4 text-center">
                    <input type="number" 
                           value="1" 
                           class="w-24 border-0 bg-white border-gray-300 rounded px-2 py-1 text-sm text-center focus:ring-2 focus:ring-purple-500"
                           onchange="updateBOQItem('${tempId}', 'quantity', this.value)"
                           ondblclick="this.focus()">
                </td>
                <td class="py-4 px-4 text-right">
                    <input type="number" 
                           value="0" 
                           step="0.01"
                           class="w-32 border-0 bg-white border-gray-300 rounded px-2 py-1 text-sm text-right focus:ring-2 focus:ring-purple-500"
                           onchange="updateBOQItem('${tempId}', 'unit_price', this.value)"
                           ondblclick="this.focus()">
                </td>
                <td class="py-4 px-4 text-right">
                    <span class="text-sm font-semibold text-green-700">₦0.00</span>
                </td>
                <td class="py-4 px-4 text-center">
                    <input type="text" 
                           value="" 
                           class="w-24 border-0 bg-white border-gray-300 rounded px-2 py-1 text-sm text-center focus:ring-2 focus:ring-purple-500"
                           onchange="updateBOQItem('${tempId}', 'item_type', this.value)"
                           ondblclick="this.focus()">
                </td>
                <td class="py-4 px-4 text-center">
                    <div class="flex justify-center space-x-2">
                        <button onclick="saveNewBOQItem('${tempId}')" 
                                class="text-green-600 hover:text-green-800 p-1 rounded" title="Save New Item">
                            <i class='bx bx-save text-sm'></i>
                        </button>
                        <button onclick="cancelNewBOQItem('${tempId}')" 
                                class="text-red-600 hover:text-red-800 p-1 rounded" title="Cancel">
                            <i class='bx bx-x text-sm'></i>
                        </button>
                    </div>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            
            // Focus on the first input
            const firstInput = newRow.querySelector('input');
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }
        }

        function saveNewBOQItem(tempId) {
            if (!window.boqChanges || !window.boqChanges[tempId]) {
                showFlashModal('warning', 'Please enter item details before saving');
                return;
            }
            
            fetch(`/admin/projects/${projectData.id}/add_boq_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(window.boqChanges[tempId])
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', 'New BOQ item added successfully');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showFlashModal('error', data.message || 'Failed to add BOQ item');
                }
            })
            .catch(error => {
                console.error('BOQ add error:', error);
                showFlashModal('error', 'An error occurred while adding BOQ item');
            });
        }

        function cancelNewBOQItem(tempId) {
            const row = document.querySelector(`tr[data-item-id="${tempId}"]`);
            if (row) {
                row.remove();
            }
            if (window.boqChanges && window.boqChanges[tempId]) {
                delete window.boqChanges[tempId];
            }
        }

        // Material Schedule specific functions
        function updateMaterialItem(itemId, field, value) {
            fetch(`/admin/projects/${projectData.id}/update_material_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    item_id: itemId,
                    field: field,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Material ${field} updated successfully`);
                    // Update total cost display if it was returned
                    if (data.total_cost !== undefined) {
                        const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                        if (row) {
                            const totalCostCell = row.querySelector('td:nth-child(5) span');
                            if (totalCostCell) {
                                totalCostCell.textContent = `₦${data.total_cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            }
                        }
                    }
                } else {
                    showFlashModal('error', data.message || 'Failed to update material item');
                }
            })
            .catch(error => {
                console.error('Error updating material item:', error);
                showFlashModal('error', 'An error occurred while updating material item');
            });
        }

        function saveMaterialItem(itemId) {
            showFlashModal('success', 'Material item saved successfully');
        }

        function deleteMaterialItem(itemId) {
            if (!confirm('Are you sure you want to delete this material item?')) return;
            
            fetch(`/admin/projects/${projectData.id}/delete_material_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    item_id: itemId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', 'Material item deleted successfully');
                    // Remove the row from the table
                    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                    if (row) {
                        row.remove();
                    }
                } else {
                    showFlashModal('error', data.message || 'Failed to delete material item');
                }
            })
            .catch(error => {
                console.error('Error deleting material item:', error);
                showFlashModal('error', 'An error occurred while deleting material item');
            });
        }

        function addNewMaterialRow() {
            const materialName = prompt('Enter material name:');
            if (!materialName) return;
            
            const requiredQty = prompt('Enter required quantity:', '1') || '1';
            const unit = prompt('Enter unit (e.g., kg, m², pieces):', 'unit') || 'unit';
            const unitCost = prompt('Enter unit cost:', '0') || '0';
            
            fetch(`/admin/projects/${projectData.id}/add_material_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    material_name: materialName,
                    required_qty: parseFloat(requiredQty),
                    unit: unit,
                    unit_cost: parseFloat(unitCost)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', 'Material item added successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showFlashModal('error', data.message || 'Failed to add material item');
                }
            })
            .catch(error => {
                console.error('Error adding material item:', error);
                showFlashModal('error', 'An error occurred while adding material item');
            });
        }

        function updateMaterialStatus(itemId, newStatus) {
            fetch(`/admin/projects/${projectData.id}/update_material_status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    item_id: itemId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFlashModal('success', `Material status updated to ${newStatus}`);
                } else {
                    showFlashModal('error', data.message || 'Failed to update material status');
                }
            })
            .catch(error => {
                console.error('Error updating material status:', error);
                showFlashModal('error', 'An error occurred while updating material status');
            });
        }

        // Enhanced Success/Error Modal System
        function showFlashModal(type, message, duration = 4000) {
            // Remove existing modals
            const existingModals = document.querySelectorAll('.flash-modal');
            existingModals.forEach(modal => modal.remove());

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'flash-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
            
            const typeConfig = {
                success: {
                    bgColor: 'bg-green-600',
                    icon: 'bx-check-circle',
                    textColor: 'text-white'
                },
                error: {
                    bgColor: 'bg-red-600', 
                    icon: 'bx-error-circle',
                    textColor: 'text-white'
                },
                warning: {
                    bgColor: 'bg-yellow-600',
                    icon: 'bx-error',
                    textColor: 'text-white'
                },
                info: {
                    bgColor: 'bg-blue-600',
                    icon: 'bx-info-circle',
                    textColor: 'text-white'
                }
            };

            const config = typeConfig[type] || typeConfig.info;

            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="flash-modal-content">
                    <div class="${config.bgColor} rounded-t-lg px-6 py-4 flex items-center">
                        <i class='bx ${config.icon} text-2xl ${config.textColor} mr-3'></i>
                        <h3 class="${config.textColor} font-semibold capitalize">${type}</h3>
                    </div>
                    <div class="px-6 py-4">
                        <p class="text-gray-700">${message}</p>
                    </div>
                    <div class="px-6 py-4 border-t border-gray-100 flex justify-end">
                        <button onclick="closeFlashModal()" 
                                class="px-4 py-2 ${config.bgColor} ${config.textColor} rounded-lg hover:opacity-90 transition-opacity">
                            OK
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Animate in
            setTimeout(() => {
                const content = document.getElementById('flash-modal-content');
                if (content) {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }
            }, 10);

            // Auto close after duration
            if (duration > 0) {
                setTimeout(() => {
                    closeFlashModal();
                }, duration);
            }

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeFlashModal();
                }
            });
        }

        function closeFlashModal() {
            const modal = document.querySelector('.flash-modal');
            if (modal) {
                const content = document.getElementById('flash-modal-content');
                if (content) {
                    content.classList.remove('scale-100', 'opacity-100');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => {
                        modal.remove();
                    }, 300);
                } else {
                    modal.remove();
                }
            }
        }

        // Override form submission success messages
        document.addEventListener('DOMContentLoaded', function() {
            // Check for flash messages from server and show them as modals
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    showFlashModal('{{ category }}', '{{ message|replace("'", "\\'") }}');
                {% endfor %}
            {% endif %}
            {% endwith %}

            // Override form submissions to show success modals
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const action = form.getAttribute('action');
                    if (action && action.includes('assign_staff')) {
                        // Don't prevent default, just show loading message
                        showFlashModal('info', 'Assigning staff member...', 0);
                    } else if (action && action.includes('milestone')) {
                        showFlashModal('info', 'Creating milestone...', 0);
                    } else if (action && action.includes('boq')) {
                        showFlashModal('info', 'Adding BOQ item...', 0);
                    } else if (action && action.includes('upload')) {
                        showFlashModal('info', 'Uploading document...', 0);
                    }
                });
            });
        });
    </script>
</div>

<!-- Success Modal Template (Hidden by default) -->
<div id="success-modal-template" class="hidden">
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4">
            <div class="bg-green-600 rounded-t-lg px-6 py-4 flex items-center">
                <i class='bx bx-check-circle text-2xl text-white mr-3'></i>
                <h3 class="text-white font-semibold">Success</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-700" id="success-message-text"></p>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 flex justify-end">
                <button onclick="closeSuccessModal()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}