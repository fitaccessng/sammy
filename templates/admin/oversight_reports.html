{% extends "admin/base_simple.html" %}

{% block title %}Business Oversight Reports - Construction Management System{% endblock %}

{% block header %}Business Oversight Reports{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Business Oversight Reports</h2>
    <p class="text-gray-600">Comprehensive business analytics, project monitoring, and operational oversight for construction management</p>
</div>

<!-- Key Business Metrics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
    <!-- Active Projects Card -->
    <div class="card bg-white p-6 metric-card border-l-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Active Projects</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.project_count or 0 }}</h3>
                <p class="text-blue-500 text-sm mt-2">
                    <i class='bx bx-building-house'></i>
                    In progress
                </p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i class='bx bxs-building-house text-2xl text-blue-600'></i>
            </div>
        </div>
    </div>

    <!-- Pending Reports Card -->
    <div class="card bg-white p-6 metric-card border-l-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Pending Reports</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.pending_reports or 0 }}</h3>
                <p class="text-yellow-500 text-sm mt-2">
                    <i class='bx bx-time-five'></i>
                    Awaiting review
                </p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
                <i class='bx bxs-report text-2xl text-yellow-600'></i>
            </div>
        </div>
    </div>

    <!-- Budget Utilization Card -->
    <div class="card bg-white p-6 metric-card border-l-green-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Budget Utilization</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.budget_percentage or 0 }}%</h3>
                <p class="text-green-500 text-sm mt-2">
                    <i class='bx bx-wallet'></i>
                    Of total budget
                </p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
                <i class='bx bxs-wallet text-2xl text-green-600'></i>
            </div>
        </div>
    </div>

    <!-- Safety Incidents Card -->
    <div class="card bg-white p-6 metric-card border-l-red-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Safety Incidents</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.incident_count or 0 }}</h3>
                <p class="text-red-500 text-sm mt-2">
                    <i class='bx bx-shield-alt-2'></i>
                    This month
                </p>
            </div>
            <div class="bg-red-100 p-3 rounded-full">
                <i class='bx bxs-shield-alt-2 text-2xl text-red-600'></i>
            </div>
        </div>
    </div>

    <!-- Equipment Status Card -->
    <div class="card bg-white p-6 metric-card border-l-purple-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Equipment Active</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.active_equipment or 0 }}</h3>
                <p class="text-purple-500 text-sm mt-2">
                    <i class='bx bx-wrench'></i>
                    Operational
                </p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <i class='bx bxs-wrench text-2xl text-purple-600'></i>
            </div>
        </div>
    </div>
</div>

<!-- Report Submissions & Business Overview -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Recent Report Submissions -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-file-doc mr-2 text-blue-600'></i>
                Recent Report Submissions
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                {% if report.recent_submissions %}
                {% for submission in report.recent_submissions %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <i class='bx {% if submission.type == "project" %}bxs-building-house{% elif submission.type == "incident" %}bxs-shield-quarter{% elif submission.type == "order" %}bxs-cart{% else %}bxs-file{% endif %} text-xl {% if submission.type == "project" %}text-blue-500{% elif submission.type == "incident" %}text-red-500{% elif submission.type == "order" %}text-green-500{% else %}text-blue-500{% endif %}'></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ submission.title }}</p>
                            <p class="text-xs text-gray-500">{{ submission.department }} • {{ submission.date }}</p>
                        </div>
                    </div>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                        {% if submission.status == 'Approved' or submission.status == 'Completed' %}bg-green-100 text-green-800
                        {% elif submission.status == 'Pending' or submission.status == 'Open' or submission.status == 'Active' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ submission.status }}
                    </span>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-8">
                    <i class='bx bx-file-blank text-4xl text-gray-300 mb-3'></i>
                    <p class="text-gray-500">No recent report submissions</p>
                    <div class="mt-2 space-x-2">
                        <a href="{{ url_for('admin.add_incident') }}" class="text-blue-600 hover:text-blue-800 text-sm">Submit Safety Report</a>
                        <span class="text-gray-300">•</span>
                        <a href="{{ url_for('admin.add_project') }}" class="text-blue-600 hover:text-blue-800 text-sm">Create Project</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Project Progress Overview -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-bar-chart-alt-2 mr-2 text-green-600'></i>
                Project Progress Overview
            </h3>
        </div>
        <div class="p-6 space-y-6">
            {% if report.project_progress %}
            {% for project in report.project_progress %}
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">{{ project.name }}</span>
                    <span class="text-sm font-semibold text-blue-600">{{ "%.0f"|format(project.progress) }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: {{ "%.0f"|format(project.progress) }}%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    {% if project.due_date %}Due: {{ project.due_date }}{% else %}No due date set{% endif %}
                    {% if project.budget %} • Budget: ₦{{ "{:,.0f}".format(project.budget) }}{% endif %}
                </p>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-8">
                <i class='bx bx-building-house text-4xl text-gray-300 mb-3'></i>
                <p class="text-gray-500">No active projects</p>
                <div class="mt-2">
                    <a href="{{ url_for('admin.add_project') }}" class="text-blue-600 hover:text-blue-800 text-sm mr-3">Create New Project</a>
                    <a href="{{ url_for('admin.projects') }}" class="text-blue-600 hover:text-blue-800 text-sm">View All Projects</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Financial & Operational Reports -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Financial Summary -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <span class="mr-2 text-green-600 text-lg font-bold">₦</span>
                Financial Summary
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Total Budget</span>
                    <span class="text-sm font-semibold">₦{{ "{:,.2f}".format(report.total_budget or 0) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Spent</span>
                    <span class="text-sm font-semibold text-red-600">₦{{ "{:,.2f}".format(report.spent_amount or 0) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Remaining</span>
                    <span class="text-sm font-semibold text-green-600">₦{{ "{:,.2f}".format((report.total_budget or 0) - (report.spent_amount or 0)) }}</span>
                </div>
                <div class="border-t pt-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Pending Orders</span>
                        <span class="text-sm font-semibold">₦{{ "{:,.2f}".format(report.pending_orders_value or 0) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Status -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-cog mr-2 text-purple-600'></i>
                Equipment Status
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Active Equipment</span>
                    <span class="text-sm font-semibold text-green-600">{{ report.active_equipment or 0 }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Under Maintenance</span>
                    <span class="text-sm font-semibold text-yellow-600">{{ report.maintenance_equipment or 0 }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Out of Service</span>
                    <span class="text-sm font-semibold text-red-600">{{ report.inactive_equipment or 0 }}</span>
                </div>
                <div class="border-t pt-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Utilization Rate</span>
                        <span class="text-sm font-semibold">{{ report.equipment_utilization or 0 }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Safety Metrics -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-shield-quarter mr-2 text-red-600'></i>
                Safety Metrics
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Incidents This Month</span>
                    <span class="text-sm font-semibold text-red-600">{{ report.incident_count or 0 }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Days Since Last Incident</span>
                    <span class="text-sm font-semibold text-green-600">{{ report.days_since_incident or 0 }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Safety Training</span>
                    <span class="text-sm font-semibold">{{ report.safety_training_completion or 0 }}%</span>
                </div>
                <div class="border-t pt-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Safety Score</span>
                        <span class="text-sm font-semibold {% if (report.safety_score or 0) >= 90 %}text-green-600{% elif (report.safety_score or 0) >= 70 %}text-yellow-600{% else %}text-red-600{% endif %}">
                            {{ report.safety_score or 0 }}/100
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Business Actions & Report Generation -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Quick Business Actions -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-rocket mr-2 text-purple-600'></i>
                Quick Business Actions
            </h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <a href="{{ url_for('admin.projects') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                    <i class='bx bxs-building-house mr-2'></i>
                    View Projects
                </a>
                <a href="{{ url_for('admin.incidents') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors">
                    <i class='bx bxs-report mr-2'></i>
                    Safety Reports
                </a>
                <a href="{{ url_for('admin.orders') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors">
                    <i class='bx bxs-cart mr-2'></i>
                    Purchase Orders
                </a>
                <a href="{{ url_for('admin.schedules') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 transition-colors">
                    <i class='bx bxs-calendar mr-2'></i>
                    Schedules
                </a>
                <a href="{{ url_for('admin.assets') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 transition-colors">
                    <i class='bx bxs-building mr-2'></i>
                    Assets
                </a>
                <a href="{{ url_for('admin.analytics_custom') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">
                    <i class='bx bxs-analyse mr-2'></i>
                    Analytics
                </a>
            </div>
        </div>
    </div>

    <!-- Business Report Generation -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-download mr-2 text-indigo-600'></i>
                Business Report Generation
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-3">
                <button onclick="generateBusinessReport('project_summary')" class="w-full inline-flex items-center justify-center px-4 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors">
                    <i class='bx bxs-building-house mr-2'></i>
                    Project Summary Report
                </button>
                <button onclick="generateBusinessReport('financial')" class="w-full inline-flex items-center justify-center px-4 py-2 border border-green-300 text-sm font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100 transition-colors">
                    <i class='bx bxs-dollar-circle mr-2'></i>
                    Financial Performance Report
                </button>
                <button onclick="generateBusinessReport('safety')" class="w-full inline-flex items-center justify-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 transition-colors">
                    <i class='bx bxs-shield-quarter mr-2'></i>
                    Safety & Compliance Report
                </button>
                <a href="{{ url_for('admin.analytics_export_csv') }}" class="w-full inline-flex items-center justify-center px-4 py-2 border border-purple-300 text-sm font-medium rounded-md text-purple-700 bg-purple-50 hover:bg-purple-100 transition-colors">
                    <i class='bx bxs-data mr-2'></i>
                    Export Business Data
                </a>
                <button onclick="generateBusinessReport('executive')" class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-gray-50 hover:bg-gray-100 transition-colors">
                    <i class='bx bxs-report mr-2'></i>
                    Executive Dashboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Recent Business Activities -->
<div class="mt-6">
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-time-five mr-2 text-gray-600'></i>
                Recent Business Activities
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                {% if report.recent_activities %}
                {% for activity in report.recent_activities %}
                <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0">
                        <i class='bx {% if activity.type == "project" %}bxs-building-house text-blue-500
                               {% elif activity.type == "safety" %}bxs-shield-quarter text-red-500
                               {% elif activity.type == "financial" %}bxs-dollar-circle text-green-500
                               {% else %}bxs-cog text-gray-500{% endif %} text-2xl'></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{{ activity.description }}</p>
                        <p class="text-sm text-gray-500">{{ activity.department }} • {{ activity.timestamp }}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                            {% if activity.priority == 'High' %}bg-red-100 text-red-800
                            {% elif activity.priority == 'Medium' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-green-100 text-green-800{% endif %}">
                            {{ activity.priority }}
                        </span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-8">
                    <i class='bx bx-time text-4xl text-gray-300 mb-3'></i>
                    <p class="text-gray-500">No recent business activities</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function generateBusinessReport(reportType) {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bx bx-loader-alt bx-spin mr-2"></i>Generating...';
    button.disabled = true;
    
    // Show different messages based on report type
    const reportMessages = {
        'project_summary': 'Project Summary Report will include project status, milestones, budget utilization, and timeline analysis.',
        'financial': 'Financial Performance Report will include budget analysis, cost breakdowns, ROI metrics, and expenditure tracking.',
        'safety': 'Safety & Compliance Report will include incident analysis, safety metrics, compliance status, and recommendations.',
        'executive': 'Executive Dashboard will provide high-level KPIs, strategic insights, and performance summaries for leadership.',
        'default': 'Business report generation will provide comprehensive analytics for your construction management operations.'
    };
    
    setTimeout(() => {
        alert(reportMessages[reportType] || reportMessages['default']);
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}

// Real-time updates for business metrics
setInterval(() => {
    // This would typically make an AJAX call to refresh business data
    console.log('Refreshing business oversight data...');
}, 60000); // Every minute for business data

// Chart initialization for business metrics (if Chart.js is available)
document.addEventListener('DOMContentLoaded', function() {
    // Initialize any charts or real-time data visualization here
    console.log('Business oversight dashboard initialized');
});
</script>
{% endblock %}