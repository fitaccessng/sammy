{% extends "admin/base_simple.html" %}

{% block title %}Business Oversight Reports - Construction Management System{% endblock %}

{% block header %}Business Oversight Reports{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">Business Oversight Reports</h2>
    <p class="text-gray-600">Comprehensive business analytics, project monitoring, and operational oversight for construction management</p>
</div>

<!-- Key Business Metrics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
    <!-- Active Projects Card -->
    <div class="card bg-white p-6 metric-card border-l-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Active Projects</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.project_count or 0 }}</h3>
                <p class="text-blue-500 text-sm mt-2">
                    <i class='bx bx-building-house'></i>
                    In progress
                </p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <i class='bx bxs-building-house text-2xl text-blue-600'></i>
            </div>
        </div>
    </div>

    <!-- Pending Reports Card -->
    <div class="card bg-white p-6 metric-card border-l-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Pending Reports</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.pending_reports or 0 }}</h3>
                <p class="text-yellow-500 text-sm mt-2">
                    <i class='bx bx-time-five'></i>
                    Awaiting review
                </p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
                <i class='bx bxs-report text-2xl text-yellow-600'></i>
            </div>
        </div>
    </div>

    <!-- Budget Utilization Card -->
    <div class="card bg-white p-6 metric-card border-l-green-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Budget Utilization</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.budget_percentage or 0 }}%</h3>
                <p class="text-green-500 text-sm mt-2">
                    <i class='bx bx-wallet'></i>
                    Of total budget
                </p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
                <i class='bx bxs-wallet text-2xl text-green-600'></i>
            </div>
        </div>
    </div>

    <!-- Safety Incidents Card -->
    <div class="card bg-white p-6 metric-card border-l-red-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Safety Incidents</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.incident_count or 0 }}</h3>
                <p class="text-red-500 text-sm mt-2">
                    <i class='bx bx-shield-alt-2'></i>
                    This month
                </p>
            </div>
            <div class="bg-red-100 p-3 rounded-full">
                <i class='bx bxs-shield-alt-2 text-2xl text-red-600'></i>
            </div>
        </div>
    </div>

    <!-- Equipment Status Card -->
    <div class="card bg-white p-6 metric-card border-l-purple-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Equipment Active</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.active_equipment or 0 }}</h3>
                <p class="text-purple-500 text-sm mt-2">
                    <i class='bx bx-wrench'></i>
                    Operational
                </p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <i class='bx bxs-wrench text-2xl text-purple-600'></i>
            </div>
        </div>
    </div>
</div>
    <div class="card bg-white p-6 metric-card border-l-purple-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Approval Levels</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.approval_hierarchy_count or 0 }}</h3>
                <p class="text-purple-500 text-sm mt-2">
                    <i class='bx bx-list-check'></i>
                    Approval processes
                </p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <i class='bx bxs-layer text-2xl text-purple-600'></i>
            </div>
        </div>
    </div>

    <!-- Permissions Card -->
    <div class="card bg-white p-6 metric-card border-l-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Permissions</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.permission_count or 0 }}</h3>
                <p class="text-yellow-500 text-sm mt-2">
                    <i class='bx bx-key'></i>
                    Access controls
                </p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
                <i class='bx bxs-key text-2xl text-yellow-600'></i>
            </div>
        </div>
    </div>

    <!-- Employees Card -->
    <div class="card bg-white p-6 metric-card border-l-indigo-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Employees</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ report.employee_count or 0 }}</h3>
                <p class="text-indigo-500 text-sm mt-2">
                    <i class='bx bx-user'></i>
                    Staff members
                </p>
            </div>
            <div class="bg-indigo-100 p-3 rounded-full">
                <i class='bx bxs-user-detail text-2xl text-indigo-600'></i>
            </div>
        </div>
    </div>
</div>

<!-- System Overview Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- System Roles Table -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-user-account mr-2 text-blue-600'></i>
                System Roles Overview
            </h3>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for role in report.roles %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ role.id }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ role.name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    Active
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not report.roles %}
                        <tr>
                            <td colspan="3" class="px-6 py-4 text-center text-gray-500">No roles found</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Health Metrics -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-dashboard mr-2 text-green-600'></i>
                System Health Metrics
            </h3>
        </div>
        <div class="p-6 space-y-6">
            <!-- Role Coverage -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Role Coverage</span>
                    <span class="text-sm font-semibold text-green-600">{{ report.system_health.role_coverage or 0 }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" style="width: {{ report.system_health.role_coverage or 0 }}%"></div>
                </div>
            </div>

            <!-- Permission Setup -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Permission Configuration</span>
                    <span class="text-sm font-semibold text-yellow-600">{{ report.permission_coverage or 0 }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-yellow-500 h-2 rounded-full" style="width: {{ report.permission_coverage or 0 }}%"></div>
                </div>
            </div>

            <!-- Organizational Structure -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Organizational Structure</span>
                    <span class="text-sm font-semibold text-blue-600">{{ report.org_structure_coverage or 0 }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: {{ report.org_structure_coverage or 0 }}%"></div>
                </div>
            </div>

            <!-- Data Integrity -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Data Integrity</span>
                    <span class="text-sm font-semibold text-green-600">{{ report.system_health.data_integrity or 0 }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" style="width: {{ report.system_health.data_integrity or 0 }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions & Export Options -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Quick Management Actions -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-cog mr-2 text-purple-600'></i>
                Quick Management Actions
            </h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <a href="{{ url_for('admin.roles_view') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                    <i class='bx bxs-user-account mr-2'></i>
                    Manage Roles
                </a>
                <a href="{{ url_for('admin.reporting_lines_view') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors">
                    <i class='bx bxs-network-chart mr-2'></i>
                    Reporting Lines
                </a>
                <a href="{{ url_for('admin.approval_hierarchy_view') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 transition-colors">
                    <i class='bx bxs-layer mr-2'></i>
                    Approval Hierarchy
                </a>
                <a href="{{ url_for('admin.permissions_view') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 transition-colors">
                    <i class='bx bxs-key mr-2'></i>
                    Permissions
                </a>
            </div>
        </div>
    </div>

    <!-- Export & Reports -->
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-download mr-2 text-indigo-600'></i>
                Export & Reports
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-3">
                <button onclick="exportReport('pdf')" class="w-full inline-flex items-center justify-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 transition-colors">
                    <i class='bx bxs-file-pdf mr-2'></i>
                    Export as PDF Report
                </button>
                <button onclick="exportReport('excel')" class="w-full inline-flex items-center justify-center px-4 py-2 border border-green-300 text-sm font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100 transition-colors">
                    <i class='bx bxs-spreadsheet mr-2'></i>
                    Export as Excel
                </button>
                <a href="{{ url_for('admin.analytics_export_csv') }}" class="w-full inline-flex items-center justify-center px-4 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors">
                    <i class='bx bxs-data mr-2'></i>
                    Export Analytics CSV
                </a>
                <button onclick="generateDetailedReport()" class="w-full inline-flex items-center justify-center px-4 py-2 border border-purple-300 text-sm font-medium rounded-md text-purple-700 bg-purple-50 hover:bg-purple-100 transition-colors">
                    <i class='bx bxs-report mr-2'></i>
                    Generate Detailed Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activities Section -->
{% if report.recent_activities %}
<div class="mt-6">
    <div class="card bg-white">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class='bx bxs-time-five mr-2 text-gray-600'></i>
                Recent Administrative Activities
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                {% for activity in report.recent_activities %}
                <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0">
                        <i class='bx bxs-user-circle text-2xl text-gray-400'></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{{ activity.description }}</p>
                        <p class="text-sm text-gray-500">{{ activity.timestamp }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function exportReport(format) {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bx bx-loader-alt bx-spin mr-2"></i>Exporting...';
    button.disabled = true;
    
    // Simulate export process
    setTimeout(() => {
        alert(`Export to ${format.toUpperCase()} functionality will be implemented with your specific reporting requirements.`);
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}

function generateDetailedReport() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bx bx-loader-alt bx-spin mr-2"></i>Generating...';
    button.disabled = true;
    
    setTimeout(() => {
        alert('Detailed report generation functionality will include comprehensive analytics, user activity logs, and system performance metrics.');
        button.innerHTML = originalText;
        button.disabled = false;
    }, 3000);
}

// Auto-refresh data every 30 seconds for real-time monitoring
setInterval(() => {
    // This would typically make an AJAX call to refresh the data
    console.log('Auto-refreshing oversight data...');
}, 30000);
</script>
{% endblock %}