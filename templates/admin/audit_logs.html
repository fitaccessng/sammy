{% extends "base.html" %}

{% block title %}System Audit Log - Admin{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">System Audit Log</h1>
        <p class="text-gray-600">Comprehensive activity tracking for all system operations</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <form method="GET" action="{{ url_for('admin.audit_logs') }}" class="grid md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Date From</label>
                <input type="date" name="date_from" value="{{ request.args.get('date_from', '') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Date To</label>
                <input type="date" name="date_to" value="{{ request.args.get('date_to', '') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Module</label>
                <select name="module" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Modules</option>
                    <option value="procurement" {% if request.args.get('module') == 'procurement' %}selected{% endif %}>Procurement</option>
                    <option value="finance" {% if request.args.get('module') == 'finance' %}selected{% endif %}>Finance</option>
                    <option value="hr" {% if request.args.get('module') == 'hr' %}selected{% endif %}>HR</option>
                    <option value="cost_control" {% if request.args.get('module') == 'cost_control' %}selected{% endif %}>Cost Control</option>
                    <option value="admin" {% if request.args.get('module') == 'admin' %}selected{% endif %}>Admin</option>
                    <option value="project" {% if request.args.get('module') == 'project' %}selected{% endif %}>Project</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Action</label>
                <select name="action" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Actions</option>
                    <option value="created" {% if request.args.get('action') == 'created' %}selected{% endif %}>Created</option>
                    <option value="updated" {% if request.args.get('action') == 'updated' %}selected{% endif %}>Updated</option>
                    <option value="deleted" {% if request.args.get('action') == 'deleted' %}selected{% endif %}>Deleted</option>
                    <option value="approved" {% if request.args.get('action') == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="rejected" {% if request.args.get('action') == 'rejected' %}selected{% endif %}>Rejected</option>
                    <option value="submitted" {% if request.args.get('action') == 'submitted' %}selected{% endif %}>Submitted</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">User</label>
                <input type="text" name="user_name" value="{{ request.args.get('user_name', '') }}" placeholder="Search by name"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="md:col-span-5 flex gap-3">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    <i class='bx bx-filter-alt'></i> Apply Filters
                </button>
                <a href="{{ url_for('admin.audit_logs') }}" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    <i class='bx bx-refresh'></i> Reset
                </a>
                <button type="button" onclick="exportAuditLogs()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors ml-auto">
                    <i class='bx bx-download'></i> Export CSV
                </button>
            </div>
        </form>
    </div>

    <!-- Stats Cards -->
    <div class="grid md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Total Activities</p>
                    <p class="text-2xl font-bold text-gray-800">{{ total_count }}</p>
                </div>
                <i class='bx bx-list-ul text-4xl text-blue-500'></i>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Today's Activities</p>
                    <p class="text-2xl font-bold text-gray-800">{{ today_count }}</p>
                </div>
                <i class='bx bx-calendar-check text-4xl text-green-500'></i>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Active Users</p>
                    <p class="text-2xl font-bold text-gray-800">{{ active_users_count }}</p>
                </div>
                <i class='bx bx-user text-4xl text-purple-500'></i>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">Critical Events</p>
                    <p class="text-2xl font-bold text-gray-800">{{ critical_count }}</p>
                </div>
                <i class='bx bx-error text-4xl text-red-500'></i>
            </div>
        </div>
    </div>

    <!-- Audit Log Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">User</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Action</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Module</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Reference</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Description</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">IP Address</th>
                        <th class="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Details</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for log in logs %}
                    <tr class="hover:bg-gray-50 {% if not log.success %}bg-red-50{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ log.timestamp.strftime('%b %d, %Y %I:%M %p') if log.timestamp else 'N/A' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-gray-800">{{ log.user_name or 'System' }}</div>
                            <div class="text-xs text-gray-500">{{ log.user_role or '-' }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full
                                {% if log.action == 'created' %}bg-green-100 text-green-800
                                {% elif log.action == 'updated' %}bg-blue-100 text-blue-800
                                {% elif log.action == 'deleted' %}bg-red-100 text-red-800
                                {% elif log.action == 'approved' %}bg-purple-100 text-purple-800
                                {% elif log.action == 'rejected' %}bg-orange-100 text-orange-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ log.action|upper }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ log.module|title }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-800">{{ log.reference_type|replace('_', ' ')|title }}</div>
                            <div class="text-xs text-gray-500">{{ log.reference_number or ('#' + (log.reference_id|string)) if log.reference_id else '-' }}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">
                            {{ log.description or '-' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ log.ip_address or '-' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button onclick="showDetails({{ log.id }})" class="text-blue-600 hover:text-blue-800">
                                <i class='bx bx-show text-xl'></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                            <i class='bx bx-info-circle text-4xl mb-2'></i>
                            <p>No audit logs found matching your criteria.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if logs %}
        <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t">
            <div class="text-sm text-gray-600">
                Showing {{ ((page - 1) * per_page) + 1 }} to {{ min(page * per_page, total_count) }} of {{ total_count }} results
            </div>
            <div class="flex gap-2">
                {% if page > 1 %}
                <a href="{{ url_for('admin.audit_logs', page=page-1, **request.args) }}" 
                   class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-100">Previous</a>
                {% endif %}
                {% if page * per_page < total_count %}
                <a href="{{ url_for('admin.audit_logs', page=page+1, **request.args) }}" 
                   class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-100">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Details Modal -->
<div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-xl font-bold text-gray-800">Audit Log Details</h3>
            <button onclick="closeDetails()" class="text-gray-600 hover:text-gray-800">
                <i class='bx bx-x text-2xl'></i>
            </button>
        </div>
        <div id="detailsContent" class="p-6">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<script>
function showDetails(logId) {
    const modal = document.getElementById('detailsModal');
    const content = document.getElementById('detailsContent');
    
    content.innerHTML = '<div class="text-center py-8"><i class="bx bx-loader-alt bx-spin text-4xl text-blue-500"></i></div>';
    modal.classList.remove('hidden');
    
    fetch(`/admin/audit-logs/${logId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const log = data.log;
                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="font-semibold text-gray-700">Timestamp:</label>
                            <p class="text-gray-600">${log.timestamp}</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700">User:</label>
                            <p class="text-gray-600">${log.user_name} (${log.user_role || 'N/A'})</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700">Action:</label>
                            <p class="text-gray-600">${log.action} in ${log.module}</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700">Reference:</label>
                            <p class="text-gray-600">${log.reference_type} - ${log.reference_number || log.reference_id || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700">Description:</label>
                            <p class="text-gray-600">${log.description || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700">IP Address:</label>
                            <p class="text-gray-600">${log.ip_address || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700">User Agent:</label>
                            <p class="text-gray-600 text-sm">${log.user_agent || 'N/A'}</p>
                        </div>
                        ${log.old_values ? `
                        <div>
                            <label class="font-semibold text-gray-700">Old Values:</label>
                            <pre class="bg-gray-100 p-3 rounded-lg text-sm overflow-x-auto">${log.old_values}</pre>
                        </div>
                        ` : ''}
                        ${log.new_values ? `
                        <div>
                            <label class="font-semibold text-gray-700">New Values:</label>
                            <pre class="bg-gray-100 p-3 rounded-lg text-sm overflow-x-auto">${log.new_values}</pre>
                        </div>
                        ` : ''}
                        <div>
                            <label class="font-semibold text-gray-700">Status:</label>
                            <p class="text-gray-600">${log.success ? '<span class="text-green-600">Success</span>' : '<span class="text-red-600">Failed</span>'}</p>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = '<div class="text-center py-8 text-red-600">Error loading details</div>';
            }
        })
        .catch(error => {
            content.innerHTML = '<div class="text-center py-8 text-red-600">Error loading details</div>';
        });
}

function closeDetails() {
    document.getElementById('detailsModal').classList.add('hidden');
}

function exportAuditLogs() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    window.location.href = `{{ url_for('admin.audit_logs') }}?${params.toString()}`;
}
</script>
{% endblock %}
