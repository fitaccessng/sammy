{% extends "admin/base_simple.html" %}

{% block title %}Payroll Details - Admin Approval{% endblock %}

{% block header %}Payroll Approval Details{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Payroll Details - {{ summary.period }}</h2>
        <p class="text-gray-600">Review payroll submission for admin approval</p>
    </div>
    <a href="{{ url_for('finance.pending_payroll_approvals') }}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors duration-200">
        <i class='bx bx-arrow-back mr-2'></i>Back to Approvals
    </a>
</div>

<!-- Payroll Summary -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="card bg-white p-6 border-l-blue-500 border-l-4">
        <div class="text-center">
            <h3 class="text-2xl font-bold text-blue-600">{{ summary.employee_count }}</h3>
            <p class="text-gray-600 text-sm">Employees</p>
        </div>
    </div>
    <div class="card bg-white p-6 border-l-green-500 border-l-4">
        <div class="text-center">
            <h3 class="text-2xl font-bold text-green-600">₦{{ "{:,.2f}".format(summary.total_gross) }}</h3>
            <p class="text-gray-600 text-sm">Total Gross</p>
        </div>
    </div>
    <div class="card bg-white p-6 border-l-red-500 border-l-4">
        <div class="text-center">
            <h3 class="text-2xl font-bold text-red-600">₦{{ "{:,.2f}".format(summary.total_deductions) }}</h3>
            <p class="text-gray-600 text-sm">Total Deductions</p>
        </div>
    </div>
    <div class="card bg-white p-6 border-l-purple-500 border-l-4">
        <div class="text-center">
            <h3 class="text-2xl font-bold text-purple-600">₦{{ "{:,.2f}".format(summary.total_net) }}</h3>
            <p class="text-gray-600 text-sm">Net Payroll</p>
        </div>
    </div>
</div>

<!-- Submission Details -->
<div class="card bg-white p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Submission Information</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
            <label class="block text-sm font-medium text-gray-600">Period</label>
            <p class="text-gray-900 font-medium">{{ summary.period }}</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-600">Submitted By</label>
            <p class="text-gray-900 font-medium">{{ summary.submitted_by }}</p>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-600">Submission Date</label>
            <p class="text-gray-900 font-medium">{{ summary.submitted_at.strftime('%d/%m/%Y %H:%M') }}</p>
        </div>
    </div>
    {% if summary.comments %}
    <div class="mt-4">
        <label class="block text-sm font-medium text-gray-600">HR Comments</label>
        <p class="text-gray-900">{{ summary.comments }}</p>
    </div>
    {% endif %}
</div>

<!-- Employee Payroll Details -->
<div class="card bg-white">
    <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Employee Payroll Breakdown</h3>
        <p class="text-gray-600 text-sm mt-1">Detailed payroll information for all employees</p>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designation</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Days</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gross (₦)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax (₦)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pension (₦)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Other (₦)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Pay (₦)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bank Details</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for payroll in payroll_data %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ payroll.employee_name }}</div>
                        <div class="text-sm text-gray-500">ID: {{ payroll.employee_id }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ payroll.designation or 'N/A' }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ payroll.site or 'N/A' }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ payroll.work_days or 0 }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ "{:,.2f}".format(payroll.gross) }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ "{:,.2f}".format(payroll.tax) }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ "{:,.2f}".format(payroll.pension) }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ "{:,.2f}".format(payroll.nhf + payroll.nhis + payroll.other_deductions) }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-green-600">{{ "{:,.2f}".format(payroll.net_pay) }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ payroll.bank_name or 'N/A' }}</div>
                        <div class="text-sm text-gray-500">{{ payroll.account_number or 'N/A' }}</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="bg-gray-50">
                <tr>
                    <td colspan="4" class="px-4 py-3 text-sm font-medium text-gray-900">TOTALS</td>
                    <td class="px-4 py-3 text-sm font-bold text-gray-900">₦{{ "{:,.2f}".format(summary.total_gross) }}</td>
                    <td class="px-4 py-3 text-sm font-bold text-gray-900">₦{{ "{:,.2f}".format(payroll_data|sum(attribute='tax')) }}</td>
                    <td class="px-4 py-3 text-sm font-bold text-gray-900">₦{{ "{:,.2f}".format(payroll_data|sum(attribute='pension')) }}</td>
                    <td class="px-4 py-3 text-sm font-bold text-gray-900">₦{{ "{:,.2f}".format((payroll_data|sum(attribute='nhf')) + (payroll_data|sum(attribute='nhis')) + (payroll_data|sum(attribute='other_deductions'))) }}</td>
                    <td class="px-4 py-3 text-sm font-bold text-green-600">₦{{ "{:,.2f}".format(summary.total_net) }}</td>
                    <td class="px-4 py-3"></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- Approval Actions -->
<div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Approve Payroll -->
    <div class="card bg-white p-6">
        <h3 class="text-lg font-semibold text-green-700 mb-4">
            <i class='bx bx-check-circle mr-2'></i>Approve Payroll
        </h3>
        <p class="text-gray-600 mb-4">Approve this payroll submission and send to finance for processing.</p>
        
        <form method="POST" action="{{ url_for('approve_payroll', approval_id=approval.id) }}">
            <div class="mb-4">
                <label for="approve_comments" class="block text-sm font-medium text-gray-700 mb-2">Admin Comments (Optional)</label>
                <textarea id="approve_comments" name="comments" rows="3" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                         placeholder="Add any comments about this approval..."></textarea>
            </div>
            <button type="submit" 
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200"
                    onclick="return confirm('Are you sure you want to APPROVE this payroll? This action will send the payroll to finance for processing.')">
                <i class='bx bx-check mr-2'></i>Approve & Send to Finance
            </button>
        </form>
    </div>

    <!-- Reject Payroll -->
    <div class="card bg-white p-6">
        <h3 class="text-lg font-semibold text-red-700 mb-4">
            <i class='bx bx-x-circle mr-2'></i>Reject Payroll
        </h3>
        <p class="text-gray-600 mb-4">Reject this payroll submission and send back to HR for corrections.</p>
        
        <form method="POST" action="{{ url_for('reject_payroll', approval_id=approval.id) }}">
            <div class="mb-4">
                <label for="rejection_reason" class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason <span class="text-red-500">*</span></label>
                <textarea id="rejection_reason" name="rejection_reason" rows="3" required
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                         placeholder="Please specify the reason for rejection..."></textarea>
            </div>
            <button type="submit" 
                    class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-200"
                    onclick="return confirm('Are you sure you want to REJECT this payroll? This will send it back to HR for corrections.')">
                <i class='bx bx-x mr-2'></i>Reject & Return to HR
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}

.table-responsive {
    max-height: 500px;
    overflow-y: auto;
}

.table-hover tbody tr:hover {
    background-color: rgba(249, 250, 251, 1);
}

.border-l-4 {
    border-left-width: 4px;
}

input:focus, textarea:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn-approve:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
}

.btn-reject:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-resize textareas
document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
});

// Form validation
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const textareas = this.querySelectorAll('textarea[required]');
        for (let textarea of textareas) {
            if (!textarea.value.trim()) {
                e.preventDefault();
                textarea.focus();
                alert('Please fill in all required fields.');
                return;
            }
        }
    });
});
</script>
{% endblock %}