{% extends "admin/base_simple.html" %}

{% block title %}Activity Log - Construction Management System{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex justify-between flex-wrap items-center pt-6 pb-4 mb-6 border-b border-gray-200">
    <div>
        <h1 class="text-3xl font-bold text-gray-800">System Activity Log</h1>
        <p class="text-sm text-gray-500 mt-1">Complete history of all system activities</p>
    </div>
    <div class="flex gap-2 mt-2 sm:mt-0">
        <button type="button" onclick="window.print()" class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
            <i class="fas fa-print"></i>
            Print
        </button>
        <a href="{{ url_for('admin.dashboard') }}" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<!-- Filters Section -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Filter Activities</h3>
    <form method="GET" action="{{ url_for('admin.activity_log') }}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Action Type Filter -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Action Type</label>
            <select name="action_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Types</option>
                {% for action in action_types %}
                <option value="{{ action }}" {% if current_filters.action_type == action %}selected{% endif %}>{{ action }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- User Filter -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
            <select name="user_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Users</option>
                {% for user in user_names %}
                <option value="{{ user }}" {% if current_filters.user_name == user %}selected{% endif %}>{{ user }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Date From -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
            <input type="date" name="date_from" value="{{ current_filters.date_from }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Date To -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
            <input type="date" name="date_to" value="{{ current_filters.date_to }}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Filter Buttons -->
        <div class="md:col-span-2 lg:col-span-4 flex gap-2">
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                <i class="fas fa-filter"></i>
                Apply Filters
            </button>
            <a href="{{ url_for('admin.activity_log') }}" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                <i class="fas fa-undo"></i>
                Clear Filters
            </a>
        </div>
    </form>
</div>

<!-- Activity Log Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-6 border-b border-gray-100">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800">Activity Timeline</h3>
            <span class="text-sm text-gray-500">Total: {{ pagination.total }} activities</span>
        </div>
    </div>

    {% if activities %}
    <!-- Desktop Table View -->
    <div class="hidden md:block overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for activity in activities %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ activity.created_at.strftime('%b %d, %Y') if activity.created_at else 'N/A' }}</div>
                        <div class="text-xs text-gray-500">{{ activity.created_at.strftime('%I:%M %p') if activity.created_at else '' }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-blue-600 text-xs"></i>
                            </div>
                            <div class="text-sm font-medium text-gray-900">{{ activity.user_name or 'System' }}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if 'milestone' in activity.action_type.lower() %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                <i class="fas fa-flag mr-1"></i>Milestone
                            </span>
                        {% elif 'staff' in activity.action_type.lower() or 'assign' in activity.action_type.lower() %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                <i class="fas fa-user-plus mr-1"></i>Staff
                            </span>
                        {% elif 'document' in activity.action_type.lower() or 'upload' in activity.action_type.lower() %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                <i class="fas fa-file mr-1"></i>Document
                            </span>
                        {% elif 'budget' in activity.action_type.lower() or 'cost' in activity.action_type.lower() %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                <i class="fas fa-dollar-sign mr-1"></i>Budget
                            </span>
                        {% elif 'delete' in activity.action_type.lower() or 'remove' in activity.action_type.lower() %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </span>
                        {% elif 'update' in activity.action_type.lower() or 'edit' in activity.action_type.lower() %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">
                                <i class="fas fa-edit mr-1"></i>Update
                            </span>
                        {% elif 'create' in activity.action_type.lower() or 'add' in activity.action_type.lower() %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-cyan-100 text-cyan-800">
                                <i class="fas fa-plus mr-1"></i>Create
                            </span>
                        {% else %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                <i class="fas fa-info mr-1"></i>{{ activity.action_type }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">{{ activity.description }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if activity.project_id %}
                            <a href="{{ url_for('project.project_details', project_id=activity.project_id) }}" class="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                                Project #{{ activity.project_id }}
                            </a>
                        {% else %}
                            <span class="text-sm text-gray-400">N/A</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Card View -->
    <div class="md:hidden divide-y divide-gray-200">
        {% for activity in activities %}
        <div class="p-4 hover:bg-gray-50 transition-colors">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    {% if 'milestone' in activity.action_type.lower() %}
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-flag text-blue-600"></i>
                        </div>
                    {% elif 'staff' in activity.action_type.lower() or 'assign' in activity.action_type.lower() %}
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user-plus text-green-600"></i>
                        </div>
                    {% elif 'document' in activity.action_type.lower() or 'upload' in activity.action_type.lower() %}
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-file text-purple-600"></i>
                        </div>
                    {% elif 'budget' in activity.action_type.lower() or 'cost' in activity.action_type.lower() %}
                        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-yellow-600"></i>
                        </div>
                    {% elif 'delete' in activity.action_type.lower() or 'remove' in activity.action_type.lower() %}
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-trash text-red-600"></i>
                        </div>
                    {% elif 'update' in activity.action_type.lower() or 'edit' in activity.action_type.lower() %}
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-edit text-orange-600"></i>
                        </div>
                    {% elif 'create' in activity.action_type.lower() or 'add' in activity.action_type.lower() %}
                        <div class="w-10 h-10 bg-cyan-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-plus text-cyan-600"></i>
                        </div>
                    {% else %}
                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-info text-gray-600"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900">{{ activity.user_name or 'System' }}</p>
                    <p class="text-sm text-gray-600 mt-1">{{ activity.description }}</p>
                    <div class="flex items-center gap-3 mt-2">
                        <span class="text-xs text-gray-400">
                            <i class="far fa-clock mr-1"></i>
                            {{ activity.created_at.strftime('%b %d, %I:%M %p') if activity.created_at else 'N/A' }}
                        </span>
                        {% if activity.project_id %}
                        <a href="{{ url_for('project.project_details', project_id=activity.project_id) }}" class="text-xs text-blue-600 hover:underline">
                            Project #{{ activity.project_id }}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Showing <span class="font-medium">{{ pagination.page }}</span> of <span class="font-medium">{{ pagination.pages }}</span> pages
                ({{ pagination.total }} total activities)
            </div>
            <div class="flex gap-2">
                {% if pagination.has_prev %}
                <a href="{{ url_for('admin.activity_log', page=pagination.prev_num, action_type=current_filters.action_type, user_name=current_filters.user_name, date_from=current_filters.date_from, date_to=current_filters.date_to) }}" 
                   class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 transition-colors">
                    <i class="fas fa-chevron-left mr-1"></i>Previous
                </a>
                {% else %}
                <span class="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-400 cursor-not-allowed">
                    <i class="fas fa-chevron-left mr-1"></i>Previous
                </span>
                {% endif %}

                {% if pagination.has_next %}
                <a href="{{ url_for('admin.activity_log', page=pagination.next_num, action_type=current_filters.action_type, user_name=current_filters.user_name, date_from=current_filters.date_from, date_to=current_filters.date_to) }}" 
                   class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 transition-colors">
                    Next<i class="fas fa-chevron-right ml-1"></i>
                </a>
                {% else %}
                <span class="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-400 cursor-not-allowed">
                    Next<i class="fas fa-chevron-right ml-1"></i>
                </span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="p-12 text-center">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-history text-gray-400 text-3xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Activities Found</h3>
        <p class="text-sm text-gray-500 mb-4">
            {% if current_filters.action_type or current_filters.user_name or current_filters.date_from or current_filters.date_to %}
            No activities match your current filters. Try adjusting your search criteria.
            {% else %}
            No activities have been logged yet. Activity logs will appear here once users start interacting with the system.
            {% endif %}
        </p>
        {% if current_filters.action_type or current_filters.user_name or current_filters.date_from or current_filters.date_to %}
        <a href="{{ url_for('admin.activity_log') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 transition-colors">
            <i class="fas fa-undo mr-2"></i>
            Clear All Filters
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}

{% block styles %}
<style>
@media print {
    .no-print {
        display: none !important;
    }
    
    body {
        background: white;
    }
    
    .bg-white {
        box-shadow: none !important;
        border: none !important;
    }
}
</style>
{% endblock %}
